<!DOCTYPE html>	
<html lang="en" xml:lang="en">
<head>
<title>overwritten</title>
	<script src='js/respec.js' class='remove'></script>
	<script class='remove'>				
		var respecConfig = {
					 
          // specification status (e.g. WD, LCWD, NOTE, etc.). If in doubt use ED.
          specStatus:           "OIPF-FINAL",

		  OIPFrelease: "2",	
		  OIPFversion: "2.3",
		  OIPFvolume: "7",
		  
		  OIPFAppendixLabel: "Annex",
          
          // the specification's short name, as in http://www.w3.org/TR/short-name/
          shortName:            "volume7",

          // if your specification has a subtitle that goes below the main
          // formal title, define it here
		  title: "Authentication, Content Protection and Service Protection",
          subtitle   :  "",

          // if you wish the publication date to be other than today, set this
          publishDate:  "2014-01-24",

          // if the specification's copyright date is a range of years, specify
          // the start date here:
          //copyrightStart: "2005",
		
		  //additionalCopyrightHolders: "",
		  
		  overrideCopyright: " ",
		  
		  
          // if there is a previously published draft, uncomment this and set its YYYY-MM-DD date
          // and its maturity status
          // previousPublishDate:  "1977-03-15",
          // previousMaturity:  "WD",

          // if there a publicly available Editor's Draft, this is the link
          edDraftURI:           "",

          // if this is a LCWD, uncomment and set the end of its review period
          // lcEnd: "2009-08-05",



          // editors, add as many as you like
          // only "name" is required
          editors:  [
              { name: "Editor", url: "contact@oipf.tv",
                company: "Open IPTV Forum", companyURL: "http://www.oipf.tv/" },
          ],
		  
          // authors, add as many as you like. 
          // This is optional, uncomment if you have authors as well as editors.
          // only "name" is required. Same format as editors.

          //authors:  [
          //    { name: "Your Name", url: "http://example.org/",
          //      company: "Your Company", companyURL: "http://example.com/" },
          //],
          
          // name of the WG
          wg:           "OIPF Solutions WG",
          
          // URI of the public WG page
          wgURI:        "http://www.oipf.tv",
          
          // name (with the @w3c.org) of the public mailing to which comments are due
          wgPublicList: "contact@oipf.tv",
          
          // URI of the patent status for this WG, for Rec-track documents
          // !!!! IMPORTANT !!!!
          // This is important for Rec-track documents, do not copy a patent URI from a random
          // document unless you know what you're doing. If in doubt ask your friendly neighbourhood
          // Team Contact.
          wgPatentURI:  "",
          		  
		  maxTocLevel:	3,
		  
				
		  localBiblio: {
			"MRL-BNSP":"Marlin Developer Community, \"Marlin – Broadband Network Service Profile Specification\", Version 1.1",
			"MRL-MS3":"Marlin Developer Community, \"Marlin –Simple Secure Streaming Specification\", Version 1.1.1",
			"IEC62455":"IEC, IEC 62455, \"Internet protocol (IP) and transport stream (TS) based service access\".",
			"MRL-DMZ":"Marlin Developer Community, \"Marlin Dynamic Media Zones\", Version 1.1",
			"MRL-CORE":"Marlin Developer Community, \"Marlin - Core System Specification\", Version 1.3",
			
			"HDCP":"Digital Content Protection LLC, \"High-bandwidth Digital Content Protection System\", Revision 1.3.",
			"DTCP":"Hitachi, Intel, Matsushita, Sony, Toshiba, \"Digital Transmission Content Protection Specification, Volume 1 (Informational Version)\", Revision 1.51.",
			"DVB-SRM":"DVB BlueBook A135, \"Digital Video Broadcasting (DVB); System Renewability Messages (SRM) in DVB systems\"",
			
			"DVB-SC":"ETSI, TS 103 197 V1.5.1, \"Digital Video Broadcasting (DVB); Head-end implementation of DVB SimulCrypt\", March 2007.",
			"CI+":"CI Plus LLP, CI Plus Specification, \"Content Security Extensions to the Common Interface\", V1.3 (2011-01).",
			
			"DTCP-IP":"Hitachi, Intel, Matsushita, Sony, Toshiba, \"DTCP Volume 1 Supplement E, Mapping DTCP to IP, (Informational Version)\", Revision 1.2.",
			"DVB-CA":"ETSI, ETR 289, \"Digital Video Broadcasting (DVB); Support for the use of scrambling and Conditional Access (CA) within digital broadcasting systems\", October 1996.",
			"DTCP-AA":"DTLA, DTCP Adopter Agreement, “Digital Transmission Protection License Agreement”.",
			"DVB-CI":"ETSI, EN 50221, \"Common Interface Specification for Conditional Access and other Digital Video Broadcasting Decoder Applications\", February 1997, and<br />ETSI, TS 101 699 V1.1.1, \"Digital Video Broadcasting (DVB); Extensions to the Common Interface Specification\".",

			"3GPP33.220":"3GPP, TS 33.220, \"Generic Authentication Architecture (GAA); Generic bootstrapping architecture\".",
			"3GPP24.109":"3GPP, TS 24.109, \"Bootstrapping interface (Ub) and network application function interface (Ua); Protocol details\".",
			"3GPP33.203":"3GPP, TS 33.203, \"3GPP; Technical Specification Group Services and System Aspects; 3G security; Access security for IP-based services (Release 8)\".",
			"3GPP24.229":"3GPP, TS 24.229, \"3GPP; Technical Specification Group Core Network and Terminals; Internet Protocol (IP) multimedia call control protocol based on Session Initiation Protocol (SIP) and Session Description Protocol (SDP); Stage 3 (Release 8)\".",
			"3GPP31.103":"3GPP, TS 31.103, \"3GPP; Technical Specification Group Core Network and Terminals; Characteristics of the IP Multimedia Services Identity Module (ISIM) application (Release 8)\".",

			"SAMLCORE":"OASIS, \"Assertions and Protocols for the OASIS Security Markup Language (SAML) V2.0\".",
			"SAMLPROF":"OASIS, \"Profiles for the OASIS Security Assertion Markup Language (SAML) V2.0\".",
		   },
		};
	</script>
<link rel="stylesheet" href="styles/oipf-csp-spec.css" type="text/css" />
</head>
<body>

<section id="abstract">
<p>This Technical Specification (TS) has been produced by the Open IPTV Forum.</p>
<p>This specification provides multiple options for some features. The Open IPTV Forum Profiles specification complements the Release 2 specifications by defining the Open IPTV Forum implementation and deployment profiles. This document is Volume 7 in the 10 Volume set of specifications that define the Open IPTV Forum Release 2 Solution.</p>
<p>The other Volumes in the set are:</p><ul>
<li>Volume 1 – Overview [[.OIPF_OVIEW2]],
<li>Volume 2 – Media Formats [[.OIPF_MEDIA2]],
<li>Volume 2a – HTTP Adaptive Streaming [[.OIPF_HAS2]],
<li>Volume 3 – Content Metadata [[.OIPF_META2]],
<li>Volume 4 – Protocols [[.OIPF_PROT2]],
<li>Volume 4a – Examples of Protocol Sequences [[.OIPF_PROT_EX2]],
<li>Volume 5 – Declarative Application Environment [[.OIPF_DAE2]],
<li>Volume 5a – Web Standards TV Profile [[.OIPF_WSTVP2]], 
<li>Volume 6 – Procedural Application Environment [[.OIPF_PAE2]], and
<li>Volume 7 – Authentication, Content Protection and Service Protection (the present document).
</ul>
<p>The present document, the Authentication, Content Protection and Service Protection Specification (Volume 7), specifies the Authentication, Content and Service Protection functionality of the OIPF Release 2 solution.</p>
<p>The requirements for this functionality are derived from the following sources:</p><ul>
<li>Open IPTV Forum Service and Platform Requirement for R2, see [[.OIPF_SERV2]];
<li>Open IPTV Forum Functional Architecture for R2, see [[.OIPF_ARCH2]].
</ul>

</section>

<section id="scope">
<h1>Scope</h1>
<p>For the system-wide scope, refer to [[.OIPF_OVIEW2]], <a href="volume1.html#scope" class="extRef">section 1</a>.</p>
<p>The scope of the present Volume is content protection, service protection, service access protection, user identification, user authentication, and user authorisation.
<p>The following sections contain features for which the criteria that determine under which circumstances these features are implemented are out of the scope of the present document or contain conditional normative statements referring to other volumes of the Open IPTV Forum specifications:</p><ul>
<li><a href="#tca" class="sectionRef"></a> <a href="#tca" class="sectionTitleRef"></a>
<li><a href="#protected-file-formats" class="sectionRef"></a> <a href="#protected-file-formats" class="sectionTitleRef"></a>
<li><a href="#protection-of-mpeg2-transport-streams" class="sectionRef"></a> <a href="#protection-of-mpeg2-transport-streams" class="sectionTitleRef"></a>
<li><a href="#ciplus-based-gateway" class="sectionRef"></a> <a href="#ciplus-based-gateway" class="sectionTitleRef"></a>
<li><a href="#protected-streaming-and-file-formats" class="sectionRef"></a> <a href="#protected-streaming-and-file-formats" class="sectionTitleRef"></a>
<li><a href="#personal-video-recorder" class="sectionRef"></a> <a href="#personal-video-recorder" class="sectionTitleRef"></a>
<li><a href="#time-shifting" class="sectionRef"></a> <a href="#time-shifting" class="sectionTitleRef"></a>
<li><a href="#dtcp-ip-based-gateway" class="sectionRef"></a> <a href="#dtcp-ip-based-gateway" class="sectionTitleRef"></a>
<li><a href="#protected-streaming-and-file-formats-1" class="sectionRef"></a> <a href="#protected-streaming-and-file-formats-1" class="sectionTitleRef"></a>
<li><a href="#http-digest-authentication-using-ims-gateway" class="sectionRef"></a> <a href="#http-digest-authentication-using-ims-gateway" class="sectionTitleRef"></a>
<li><a href="#gba-authentication-using-ims-gateway" class="sectionRef"></a> <a href="#gba-authentication-using-ims-gateway" class="sectionTitleRef"></a>
</ul>
<p>Note that GBA authentication can be achieved using either the mechanism in section <a href="#gba-authentication-using-ims-gateway" class="sectionRef"></a> <a href="#gba-authentication-using-ims-gateway" class="sectionTitleRef"></a> or the, more general, mechanism in section <a href="#http-digest-authentication-using-ims-gateway" class="sectionRef"></a> <a href="#http-digest-authentication-using-ims-gateway" class="sectionTitleRef"></a>. Section <a href="#http-digest-authentication-using-ims-gateway" class="sectionRef"></a> allows the use of different authentication mechanism in a way that is transparent to the OITF, including possible future authentication mechanisms, and should preferably be used. It is expected that section <a href="#gba-authentication-using-ims-gateway" class="sectionRef"></a> <a href="#gba-authentication-using-ims-gateway" class="sectionTitleRef"></a> will be deprecated and removed in future versions of this specification.</p>
</section>
<section id='references'>
<h2>References</h2>
</section>

<section id="conventions-and-terminology">
<h2>Conventions and Terminology</h2>
<section><h3>Conventions</h3>
<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in [[RFC2119]]. </p>
<p>All sections and appendixes, except "Scope" and "Introduction", are normative, unless they are explicitly indicated to be informative.</p>
</section>
<section><h3>Terminology</h3>
<section><h4>Definitions</h4>
<table class="definitions">
<tr><th>Term</th><th>Definition</th></tr>
<tr><td>Business Token</td><td>collection of information defined in [[!MRL-BNSP]] that contains the service specific information for a given business model</td></tr>
<tr><td>Content and Service Protection Gateway</td><td>optional gateway function that provides a conversion from a (proprietary) content and service protection solution in the network to one that is supported by an OITF, as defined in this specification</td></tr>
<tr><td>Client Function</td><td>function that interacts with the Marlin Client Function in a Content and Service Protection</td></tr>
<tr><td>Content and Service Key Management Function</td><td><p>entity responsible for storing and providing Service, Program, Content Keys and ECM attached information</p><p>This function MAY be physically co-located with other functions (e.g. the Content Delivery Network Controller for Content on Demand services), see [[.OIPF_ARCH2]].</p><p>This entity has been identified in release 1 just to illustrate informatively the separation between content encryption which is part of content preparation and content delivery.</p></td></tr>
<tr><td>Content on Demand Encryption Management Function</td><td><p>back office Content on Demand function in charge of launching Content on Demand encryption.</p><p>This entity has been identified in release 1 just to illustrate informatively the separation between content encryption which is part of content preparation and content delivery.</p></td></tr>
<tr><td>Content and Service Protection</td><td>function that handles service protection and content protection for the client in the OITF</td></tr>
<tr><td>CSP-G Server</td><td>functional entity in the network that handles content protection and service protection for the Content and Service Protection Gateway (CSPG) in the residential network</td></tr>
<tr><td>CSP-T Server</td><td>functional entity in the network that handles service protection and content protection for the CSP-T client in the OITF</td></tr>
<tr><td>Marlin Action Token</td><td>token defined either in [[!MRL-BNSP]] or in [[!MRL-MS3]] that is used to trigger the Marlin Protocols from the Marlin Client Function in CSP, and from which some information (e.g., business token) is used in the Marlin protocols. The mimeType attribute is used to qualify which Marlin token type is returned.</td></tr>
<tr><td>Marlin Client Function</td><td>compliant implementation of the Marlin Client that is defined in [[!MRL-BNSP]] and that enables secure communications (Marlin Protocols) with the Marlin Server Function in a CSP-T Server</td></tr>
<tr><td>Marlin Configuration Token</td><td>token defined in [[!MRL-BNSP]] that includes the location information of the Marlin Server Function in CSP-T Server with which the CSP communicates</td></tr>
<tr><td>Marlin Server Function</td><td>compliant implementation of the Marlin Server that is defined in [[!MRL-BNSP]] and that enables secure communications (Marlin Protocols) with the Marlin Client Function in a CSP</td></tr>
<tr><td>MS3 Manifest File</td><td>A text document carrying a Stream Access Statement URL and a Content URI Template, as specified in [[!MRL-MS3]]</td></tr>
<tr><td>MS3 Stream Access Statement</td><td>Stream Access Statement as specified in [[!MRL-MS3]]</td></tr>
<tr><td>Output Control Information</td><td>Output Control Information as defined in [[!MRL-BNSP]] and [[!MRL-BBTS]]</td></tr>
<tr><td>Program Key</td><td>symmetric key defined in [[!IEC62455]] that encrypts an ECM</td></tr>
<tr><td>Scramble Key</td><td>symmetric key that scrambles the content</td></tr>
<tr><td>Server Function</td><td>function that interacts with the Marlin Server Function in a CSP-T Server</td></tr>
<tr><td>serviceBaseCID</td><td>the part of the Content ID that is the same for all content in a service</td></tr>
<tr><td>Service Key</td><td>symmetric key defined in [[!IEC62455]] that encrypts an ECM or a Program Key</td></tr>
<tr><td>Single Sign On</td><td>Single Sign On	method of service access control that enables the user to authenticate once and gain access to the resources of multiple services</td></tr>
</table>
</section>
<section><h4>Abbreviations</h4>
<p>In addition to the Abbreviations provided in <a href="volume1.html#abbreviations" class="extRef">Volume 1</a>, the following abbreviations are used in this Volume.</p>
<table class="definitions">
<tr><th>Acronym</th><th>Explanation</th></tr>
<tr><td>3GPP</td><td>Third Generation Partnership Project</td></tr>
<tr><td>AES</td><td>Advanced Encryption Standard</td></tr>
<tr><td>AKE</td><td>Authentication and Key Exchange</td></tr>
<tr><td>APDU</td><td>Application Protocol Data Unit</td></tr>
<tr><td>ATIS</td><td>Alliance for Telecommunications Industry Solutions</td></tr>
<tr><td>BBTS</td><td>Broadband Transport Stream – MPEG-2 transport stream as defined by [[!MRL-BBTS]]</td></tr>
<tr><td>BNS</td><td>Broadband Network Service</td></tr>
<tr><td>BSF</td><td>Bootstrapping Server Function</td></tr>
<tr><td>bslbf</td><td>bit string, left bit first</td></tr>
<tr><td>B-TID</td><td>Bootstrapping Transaction Identifier</td></tr>
<tr><td>CA</td><td>Conditional Access</td></tr>
<tr><td>CAD</td><td>Content Access Descriptor</td></tr>
<tr><td>CAM</td><td>Conditional Access Module</td></tr>
<tr><td>CAT</td><td>Conditional Access Table</td></tr>
<tr><td>CBC</td><td>Cipher-Block Chaining</td></tr>
<tr><td>CE-HTML</td><td>Consumer Electronics – HTML</td></tr>
<tr><td>CI</td><td>Common Interface</td></tr>
<tr><td>CSKMF</td><td>Content and Service Key Management Function</td></tr>
<tr><td>CSPG-CI+</td><td>CSPG – CI+ based</td></tr>
<tr><td>CSPG-DTCP</td><td>CSPG – DTCP-IP based</td></tr>
<tr><td>CSP-T</td><td>Content and Service Protection – Terminal-Centric Approach </td></tr>
<tr><td>DCF</td><td>DRM Content Format</td></tr>
<tr><td>DMZ</td><td>Dynamic Media Zones</td></tr>
<tr><td>DNR</td><td>Do Not Record</td></tr>
<tr><td>DNTS</td><td>Do Not Time Shift</td></tr>
<tr><td>DTCP</td><td>Digital Transmission Content Protection</td></tr>
<tr><td>DTLA</td><td>Digital Transmission Licensing Administrator</td></tr>
<tr><td>DVB</td><td>Digital Video Broadcasting</td></tr>
<tr><td>ECM</td><td>Entitlement Control Message</td></tr>
<tr><td>EMM</td><td>Entitlement Management Message</td></tr>
<tr><td>ETSI</td><td>European Telecommunications Standards Institute</td></tr>
<tr><td>FQDN</td><td>Fully Qualified Domain Name</td></tr>
<tr><td>GAA</td><td>Generic Authentication Architecture</td></tr>
<tr><td>HDCP</td><td>High-bandwidth Digital Content Protection</td></tr>
<tr><td>HDD</td><td>Hard Disk Drive</td></tr>
<tr><td>HNI-AMNI</td><td>Home Network Interface – Additional Managed Network Interface</td></tr>
<tr><td>HNI-CSP</td><td>Home Network Interface – Content and Service Protection</td></tr>
<tr><td>HNI-IGI</td><td>Home Network Interface – IMS Gateway Interface</td></tr>
<tr><td>HNI-INI</td><td>Home Network Interface – ITF (IPTV Terminal Function) Network Interface</td></tr>
<tr><td>ID</td><td>Identity</td></tr>
<tr><td>IDSA</td><td>IIF Default Scrambling Algorithm</td></tr>
<tr><td>IEC</td><td>International Electrotechnical Commission</td></tr>
<tr><td>IETF</td><td>Internet Engineering Task Force</td></tr>
<tr><td>IIF</td><td>IPTV Interoperability Forum</td></tr>
<tr><td>IPMC</td><td>IP Multicast</td></tr>
<tr><td>IPMP</td><td>Intellectual Property Management Protocol</td></tr>
<tr><td>ISO</td><td>International Organization for Standardization</td></tr>
<tr><td>IV</td><td>Initialization Vector</td></tr>
<tr><td>KDF</td><td>Key Derivation Function</td></tr>
<tr><td>KSM</td><td>Key Stream Message</td></tr>
<tr><td>M-CID</td><td>Marlin Content ID</td></tr>
<tr><td>MIME</td><td>Multipurpose Internet Mail Extensions</td></tr>
<tr><td>MP4</td><td>MPEG-4</td></tr>
<tr><td>MPEG</td><td>Moving Pictures Experts Group</td></tr>
<tr><td>MS3</td><td>Marlin Simple Secure Streaming</td></tr>
<tr><td>NAF</td><td>Network Application Function</td></tr>
<tr><td>NPI</td><td>Network Provider Interface</td></tr>
<tr><td>OASIS</td><td>Organization for the Advancement of Structured Information Standards</td></tr>
<tr><td>PCMCIA</td><td>Personal Computer Memory Card International Association</td></tr>
<tr><td>PCP</td><td>Protected Content Packet</td></tr>
<tr><td>PDCF</td><td>Packetized DRM Content Format</td></tr>
<tr><td>PES</td><td>Packetized Elementary Stream</td></tr>
<tr><td>PID</td><td>Packet Identifier</td></tr>
<tr><td>PIN</td><td>Personal Identification Number</td></tr>
<tr><td>PKI</td><td>Public Key Infrastructure</td></tr>
<tr><td>PMT</td><td>Program Map Table</td></tr>
<tr><td>SAML</td><td>Security Assertion Markup Language</td></tr>
<tr><td>SAS</td><td>Specific Application Support</td></tr>
<tr><td>SRM</td><td>System Renewability Message</td></tr>
<tr><td>TEK</td><td>Traffic Encryption Key</td></tr>
<tr><td>TISPAN</td><td>Telecoms & Internet converged Services & Protocols for Advanced Networks</td></tr>
<tr><td>TLS</td><td>Transport Layer Security</td></tr>
<tr><td>TLV</td><td>Type Length Value</td></tr>
<tr><td>TS</td><td>Transport Stream</td></tr>
<tr><td>TV</td><td>Television</td></tr>
<tr><td>uimsbf</td><td>unsigned integer most significant bit first</td></tr>
<tr><td>UNIS-CSP-G</td><td>User Network Interface Specific – Content and Service Protection Gateway</td></tr>
<tr><td>UPnP</td><td>Universal Plug and Play</td></tr>
<tr><td>URI</td><td>Usage Rule Information</td></tr>
</table>
</section>
</section>
</section>

<section id="content-and-service-protection"><h1>Content and Service Protection</h1>
<p>This section specifies the Content and Service protection functionality.</p>
<p>It consists of a specification of</p><ul>
<li>the <a href="#tca" class="sectionTitleRef"></a>, see section <a href="#tca" class="sectionRef"></a>, and
<li>the <a href="#gca" class="sectionTitleRef"></a>, see section <a href="#gca" class="sectionRef"></a>.
</ul>

<section id="tca"><h2>Terminal-Centric Approach</h2>
<p>This section specifies the functionality for the OIPF Terminal-Centric Approach to Content & Service Protection. In order to do this, this section provides a mapping from all relevant functions and interfaces from [[.OIPF_ARCH2]] to specific sections of Marlin specifications [[!MRL-BNSP]] and [[!MRL-MS3]].</p>
<p>All normative statements in this section and its sub-sections apply only in case the Terminal-Centric Approach is supported by the OITF.</p>
<p>OITFs that support the OIPF Terminal-Centric Approach to Content & Service Protection SHALL be compliant with [[!MRL-BNSP]] and MAY be compliant with [[!MRL-MS3]].</p>
<p>NOTE: The criteria that determine under which circumstances the Terminal-Centric Approach is implemented are out of the scope of the present document.</p>
<p>NOTE: The criteria that determine under which circumstances the support for Marlin metering for content or rights owner settlement is implemented in the OITF are out of the scope of the present document.</p>
<section id="interfaces-for-csp-and-csp-t-server"><h3>Interfaces for CSP and CSP-T Server</h3>
<p>This section describes the interfaces related to a CSP and CSP-T Server in the Functional Architecture described in [[.OIPF_ARCH2]].</p>
<section id="tca-interfaces-scope"><h4>Scope</h4>
<p>The main scope of this section is to describe CSP interfaces (CSP-1, UNIS-CSP-T) and CSP-T Server interfaces (NPI CSPTx, x = 1, 2, 3). CSP-1 is the interface between CSP and OITF Functions. NPI-CSPTx, x = 1, 2, 3, are the interfaces between the CSP-T Server and Providers Network Functions. This section informatively touches upon the Marlin License Evaluation and Content Encryption.</p>
<p>Only the UNIS-CSP-T interface and the interface to DAE in CSP-1 are normative. The other interfaces are informatively described for comprehension.</p>
<p>Figure <a href="#csp-t-system-overview" class="figureRef"></a> shows the message flow overview.</p>
<figure id="csp-t-system-overview">
<img alt="FIGURE 1" src="images/CSP-T_SystemOverview.png" />
<figcaption>Figure ####: CSP-T System Overview</figcaption>
</figure>
<p>The four functional entities in Figure <a href="#csp-t-system-overview" class="figureRef"></a> are described below:</p><ul>
<li>CSP in this document consists of Marlin Client Function and a part of the Client Function which deals with Marlin elements.
<li>CSP-T Server in this document consists of Marlin Server Function and a part of the Server Function which deals with Marlin elements.
<li>OITF Function is the function in the OITF that interacts with the CSP. The OITF Function also interacts with a Providers Network Function to acquire the necessary information for the CSP. How the Providers Network Function is called in this document depends on the process to be performed.
<li>Providers Network Function is the function in the Providers Network that interacts with the CSP-T Server. How the Providers Network Function is called in this document depends on the process to be performed.
</ul>
<p>Note that the OITF Function with which the CSP communicates is not limited as described in this document and may vary depending on the implementation of the OITF.</p>
</section>
<section id="interface-csp-csp-t"><h4>Interface CSP - CSP-T Server (UNIS-CSP-T)</h4>
<p>When requested from a native application or from the DAE application to handle a Marlin Action Token or a MIPPVControlMessage, see section <a href="#dae-marlin-messages" class="sectionRef"></a>, the CSP SHALL act as a Marlin DRM Client and SHALL perform Marlin Protocols as specified in [[!MRL-BNSP]] or [[!MRL-MS3]] as applicable. Furthermore, in the context of [[!MRL-BNSP]], if there are no available rights when trying to use content, the CSP SHALL comply with [[!MRL-BBTS]] and [[!OMARLIN]] and SHALL try to use the URL specified in the content to acquire new rights.</p>
<p>In both cases, the CSP-T Server SHALL comply with Marlin Protocols as specified in [[!MRL-BNSP]].</p>
<p>These protocols are:</p><ul>
<li>Marlin registration: Node acquisition and Link acquisition.
<li>Marlin de-registration.
<li>Marlin License acquisition.
</ul>
<p>If Marlin Simple Secure Streaming feature is supported, the CSP-T Server MAY comply with MS3 Protocols as specified in [[!MRL-MS3]]</p><ul>
<li>MS3 Protocol.
</ul>
<p>Marlin Protocols are described in section <a href="#marlin-protocol-sequences" class="sectionRef"></a>.</p>
</section>
<section id="interface-csp-oitf"><h4>Interface CSP - OITF Function (CSP-1)</h4>
<p>The DAE DRM Agent API, as defined in [[.OIPF_DAE2]] <a href="volume5.html#application-oipfdrmagent" class="extRef">section 7.6.1</a>, triggers handling of DRM Message, e.g. Marlin Action Token, MIPPVControlMessage or Marlin License. When the <a href="volume5.html#oipfdrmagent-senddrmmessage" class="apiRef">sendDRMMessage</a> API is called for a DRMSystemID set to the value defined for Marlin, OITF SHALL forward the DRM Message to the CSP function. The result of calling <a href="volume5.html#oipfdrmagent-senddrmmessage" class="apiRef">sendDRMMessage></a> is notified through the <a href="volume5.html#oipfdrmagent-ondrmmessageresult" class="apiRef">onDRMMessageResult</a> event handler.</p>
<p>Typical DRM events SHALL be triggered by CSP to DAE via A/V Control or video/broadcast object when content cannot be played, recorded or time shifted, due to a lack of rights (no license, invalid license) or parental control locking. These events are defined in [[.OIPF_DAE2]] sections <a href="volume5.html#video-broadcast-extensions-drm-errors" class="extRef">7.13.6</a> and <a href="volume5.html#av-control-extensions-for-drm-rights-errors" class="extRef">7.14.6</a>. The DRMSystemID of these events SHALL be set to the value defined for Marlin.</p>
<p>A DAE application or native application MAY use DRMControlInformation, defined as an extension to PurchaseItem in [[.OIPF_META2]], present in the BCG and SD&amp;S retrieved by the metadata client. SilentRightsURL, PreviewRightsURL and RightsIssuerURL in DRMControlInformation MAY be used to get updated rights. If the DRMSystemID in DRMControlInformation is set to the value defined for Marlin, the application SHALL forward the DRMPrivateData, if present, to the CSP. A DAE application SHALL use <a href="volume5.html#oipfdrmagent-senddrmmessage" class="apiRef">sendDRMMessage</a>, defined in [[.OIPF_DAE2]]  <a href="volume5.html#application-oipfdrmagent-methods" class="extRef">section 7.6.1.2</a>, to forward the DRMPrivateData.</p>
<p>All objects defined in [[.OIPF_DAE2]] that are requested to handle a content-access descriptor, defined in [[.OIPF_DAE2]] SHALL check if the content-access descriptor includes DRMControlInformation. These objects or the underlying functions SHALL forward the available DRMPrivateData in the DRMControlInformation to the CSP if the DRMSystemID is set to the value defined for Marlin.
<p>NOTE: The DRMSystemID is defined in section <a href="#tca-drmsystemid" class="sectionRef"></a> for Marlin.</p>
</section>
<section id="marlin-protocol-sequences"><h4>Marlin Protocol Sequences (informative)</h4>
<section id="marlin-registration"><h5>Marlin Registration (informative)</h5>
<p>Marlin Registration provides functions which enable a Marlin Client Function in CSP to register to a Marlin domain. Marlin Registration consists of Node Acquisition and Link Acquisition.</p>
<section id="node-acquisition"><h6>Node Acquisition (informative)</h6>
<p>Node Acquisition provides an Octopus Node Object from a Marlin Server Function in CSP-T Server to a Marlin Client Function in CSP.
Note that Node Acquisition is performed prior to the respective Link Acquisition to provide the Octopus Node Objects necessary for the Link Acquisition.</p>
<p>Marlin Node Acquisition Protocol is triggered by a Marlin Action Token for Node Acquisition (hereafter Node Acquisition Action Token) from CSP. The OITF Function acquires the Node Acquisition Action Token and then the OITF Function feeds it to CSP. After CSP acquires corresponding Marlin Configuration Token from CSP-T Server, CSP executes Marlin Node Acquisition Protocol with CSP-T Server. Note that Marlin Node Acquisition Protocol is to provide one Octopus Node Object per its request and response.</p>
<p>The message flow in case of Node Acquisition is shown in Figure <a href="#node-acquisition-sequence" class="figureRef"></a>.</p>
<figure id="node-acquisition-sequence">
<img alt="FIGURE 2" src="images/NodeAcquisitionSequence.png" />
<figcaption>Figure ####: Node Acquisition Sequence</figcaption>
</figure>
<p>In Node Acquisition Sequence, the following steps are performed:</p>
<table class="sequence">
<tr><td>1.</td><td>The OITF Function (e.g. DAE) communicates with IPTV Applications and IPTV Service Profile function via UNIS-6 and NPI-17 for Node Acquisition.<div class="footnote">Note that, although NPI-17 is assumed as the interface for communication between IPTV Applications and IPTV Service Profile, in the case of the managed network model, NPI-2 and NPI-6 may be used instead.</div></td></tr>
<tr><td>2.</td><td>Given the Marlin Action Token URL (e.g. embedded into the webpage obtained in step 1), the OITF Function (e.g. DAE application) sends the request for the Node Acquisition Action Token to the IPTV Applications by UNIS-6.</td></tr>
<tr><td>3.</td><td>When receiving the request from the OITF Function, the IPTV Applications sends a request to the IPTV Service Profile function via NPI-17 to get the necessary information to generate the Node Acquisition Action Token.</td></tr>
<tr><td>4.</td><td>Receiving the request from IPTV Applications, the IPTV Service Profile function sends Business Token and user information to IPTV Applications.</td></tr>
<tr><td>5.</td><td>Given the information from the IPTV Applications, when there is no Octopus Node for the given user information, the CSP-T Server generates Octopus Node and correlates user information with the Octopus Node, so that CSP-T Server can check for the existence of the Octopus Node next time from the user information. Then the CSP-T Server correlates the Business Token with Octopus Node so that the CSP-T Server can provide the corresponding Octopus Node from the Business Token included in the (Marlin Node Acquisition Protocol) request.</td></tr>
<tr><td>6.</td><td>IPTV Applications sends the Node Acquisition Action Token to the OITF Function by UNIS-6.</td></tr>
<tr><td>7.</td><td>The OITF Function sends the Node Acquisition Action Token to the CSP by CSP-1.</td></tr>
<tr><td>8.</td><td>When the CSP does not have a corresponding Marlin Configuration Token, the CSP gets the Marlin Configuration Token from the CSP-T Server by referring to the URL specified in the Node Acquisition Action Token.</td></tr>
<tr><td>9.</td><td>Given the Node Acquisition Action Token, the CSP sends a (Marlin Node Acquisition Protocol) request to CSP-T Server by UNIS-CSP-T.</td></tr>
<tr><td>10.</td><td>To check the request from the CSP, the CSP-T Server sends the Business Token (and possibly other client data such as client version, model, etc... extracted from the request) to the IPTV Service Profile function.</td></tr>
<tr><td>11.</td><td>The IPTV Service Profile function validates the data received from the CSP-T Server.</td></tr>
<tr><td>12.</td><td>If validation succeeds, the IPTV Service returns to CSP-T Server the data necessary to fulfil the CSP request. If validation fails, an error is returned to the CSP-T Server.</td></tr>
<tr><td>13.</td><td>The CSP-T Server sends a Marlin (Node Acquisition) response message to the CSP. This response includes either the Octopus Node correlated to the Business Token sent in the original CSP request, or an error message as defined in [[!MRL-BNSP]].</td></tr>
</table>
</section>
<section id="link-acquisition"><h6>Link Acquisition (informative)</h6>
<p>Link Acquisition provides an Octopus Link from Marlin Server Function in CSP-T Server to Marlin Client Function in CSP.</p>
<p>Note that this sequence assumes that the corresponding Node Acquisition has already been performed between the CSP and CSP-T Server.</p>
<p>Marlin Link Acquisition Protocol is triggered by a Marlin Action Token for Link Acquisition (hereafter Link Acquisition Action Token) from CSP. The OITF Function acquires the Link Acquisition Action Token, and then the OITF Function feeds it to CSP. After CSP acquires corresponding Marlin Configuration Token from CSP-T Server, CSP executes Marlin Link Acquisition Protocol with CSP-T Server.</p>
<p>The message flow in case of Link Acquisition is shown in Figure <a href="#link-acquisition-sequence" class="figureRef"></a>.</p>
<figure id="link-acquisition-sequence">
<img alt="FIGURE 3" src="images/LinkAcquisitionSequence.png" />
<figcaption>Figure ####: Link Acquisition Sequence</figcaption>
</figure>
<p>In Link Acquisition Sequence, the following steps are performed:</p><table class="sequence">
<tr><td>1.</td><td>The OITF function (e.g. DAE) communicates with IPTV Applications and IPTV Service Profile function via UNIS-6 and NPI-17 for Link Acquisition.<div class="footnote">Note that, although NPI-17 is assumed as the interface for communication between IPTV Applications and IPTV Service Profile, in the case of the managed network model, NPI-2 and NPI-6 may be used instead.</div></td></tr>
<tr><td>2.</td><td>Given the Marlin Action Token URL (e.g. embedded into the webpage obtained in step 1), the OITF Function (e.g. DAE application) sends the request for the Link Acquisition Action Token to IPTV Applications by UNIS-6.</td></tr>
<tr><td>3.</td><td>When receiving the request from the OITF Function, the IPTV Applications sends a request to the IPTV Service Profile function by NPI-17 to get necessary information to generate the Link Acquisition Action Token,</td></tr>
<tr><td>4.</td><td>Receiving the request from IPTV Applications, the IPTV Service Profile function sends Business Token and user information to IPTV Applications.</td></tr>
<tr><td>5.</td><td>Given the user information from the IPTV Applications, the CSP-T Server finds the information of Octopus Node which corresponds to “From Node” and “To Node”. Then the CSP-T Server correlates the Business Token with “From Node” and “To Node” so that the CSP-T Server can check the information in (Marlin Link Acquisition Protocol) request.</td></tr>
<tr><td>6.</td><td>IPTV Applications sends the Link Acquisition Action Token to the OITF Function by UNIS-6.</td></tr>
<tr><td>7.</td><td>Given the Link Acquisition Action Token, the OITF Function sends it to the CSP by CSP-1.</td></tr>
<tr><td>8.</td><td>When the CSP does not have a corresponding Marlin Configuration Token, the CSP gets the Marlin Configuration Token from the CSP-T Server by referring to the URL specified in the Link Acquisition Action Token by UNIS-CSP-T.</td></tr>
<tr><td>9.</td><td>Given the Link Acquisition Action Token, the CSP sends a (Marlin Link Acquisition Protocol) request to the CSP T Server.</td></tr>
<tr><td>10.</td><td>To check the request from the CSP, when the request includes the correct combination of Business Token, “From Node”, and “To Node”, the CSP-T Server sends a Business Token and MessageID to the IPTV Service Profile function by NPI-CSPT1a. The MessageID is a unique id, and the same MessageID is set among request, response, and confirmation, so that IPTV Service Profile function can use the MessageID to correlate request, response, and confirmation.</td></tr>
<tr><td>11.</td><td>The IPTV Service Profile function validates the data received from the CSP-T Server.</td></tr>
<tr><td>12.</td><td>If validation succeeds, the IPTV Service Profile function returns to CSP-T Server the data necessary to fulfil the CSP request.  If validation fails, an error is returned to the CSP-T Server.</td></tr>
<tr><td>13.</td><td>The CSP-T Server sends a Marlin (Registration) response message to the CSP.  This response includes either the registration agent correlated to the Business Token sent in the original CSP request, or a fault message as defined in [[!MRL-BNSP]].</td></tr>
<tr><td>14.</td><td>The CSP sends a (Marlin Link Acquisition Protocol) Confirmation to the CSP-T Server by UNIS-CSP-T.</td></tr>
<tr><td>15.</td><td>The CSP-T Server checks the resultCode (i.e. success or failure for registration in CSP), and then stores the “From Node” and “To Node” information by correlating with the user information so that CSP-T Server can manage Marlin domain information for the user.</td></tr>
<tr><td>16.</td><td>The CSP-T Server sends the resultCode and the MessageID to the IPTV Service Profile function by NPI-CSPT1a.</td></tr>
<tr><td>17.</td><td>The IPTV Service Profile function stores the resultCode in connection with the user information from step 4.</td></tr>
</table>
</section>
</section>
<section id="marlin-deregistration"><h5>Marlin Deregistration (informative)</h5>
<p>Marlin Deregistration provides functions which enable Marlin Client Function in CSP to deregister from a Marlin domain.</p>
<p>Note that this sequence assumes that the corresponding Node Acquisition and Link Acquisition have already been performed between the CSP and CSP-T Server.</p>
<p>Marlin Deregistration Protocol is triggered by a Marlin Action Token for Deregistration (hereafter Deregistration Action Token) from CSP. The OITF Function acquires the Deregistration Action Token, and then the OITF Function feeds it to CSP. After CSP acquires corresponding Marlin Configuration Token from CSP-T Server, CSP executes Marlin Deregistration Protocol with CSP-T Server.</p>
<p>The sequence of deregistration messages is shown in Figure <a href="#marlin-deregistration-sequence" class="figureRef"></a>. </p>
<figure id="marlin-deregistration-sequence">
<img alt="FIGURE 4" src="images/MarlinDeregistration.png" />
<figcaption>Figure ####: Deregistration Sequence</figcaption>
</figure>
<p>In this deregistration sequence, the following steps are performed:</p><table class="sequence">
<tr><td>1.</td><td>The OITF function (e.g. DAE) communicates with IPTV Applications and IPTV Service Profile function via UNIS-6 and NPI-17 for Marlin Deregistration.<div class="footnote">Note that, although NPI-17 is assumed as the interface for communication between IPTV Applications and IPTV Service Profile, in the case of the managed network model, NPI-2 and NPI-6 may be used instead.</div></td></tr>
<tr><td>2.</td><td>Given the Marlin Action Token URL (e.g. embedded into the web page obtained in step 1), the OITF Function (e.g. DAE application) sends the request for the Deregistration Action Token to the IPTV Applications by UNIS-6.</td></tr>
<tr><td>3.</td><td>When receiving the request from the OITF Function, the IPTV Applications sends a request to the IPTV Service Profile function by NPI-17 to get necessary information to generate the Deregistration Action Token.</td></tr>
<tr><td>4.</td><td>Receiving the request from IPTV Applications, the IPTV Service Profile function sends Business Token and user information to IPTV Applications.</td></tr>
<tr><td>5.</td><td>Given the user information from the IPTV Applications, the CSP-T Server finds the information of Octopus Node which corresponds to “From Node” and “To Node”. Then the CSP-T Server correlates the Business Token with “From Node” and “To Node” so that the CSP-T Server can check the information in (Marlin Deregistration Protocol) request.</td></tr>
<tr><td>6.</td><td>IPTV Applications sends the Deregistration Action Token to the OITF Function by UNIS-6.</td></tr>
<tr><td>7.</td><td>Given the Deregistration Action Token, the OITF Function sends it to the CSP by CSP-1.</td></tr>
<tr><td>8.</td><td>When the CSP does not have a corresponding Marlin Configuration Token, the CSP gets the Marlin Configuration Token from the CSP-T Server by referring to the URL specified in the Deregistration Action Token.</td></tr>
<tr><td>9.</td><td>Given the Deregistration Action Token, the CSP sends a (Marlin Deregistration Protocol) request to the CSP-T Server by UNIS-CSP-T.</td></tr>
<tr><td>10.</td><td>To check the request from the CSP by the IPTV Service Profile function, when the request includes the correct combination of Business Token, “From Node”, and “To Node”, the CSP-T Server sends a Business Token and MessageID to the IPTV Service Profile function by NPI-CSPT1a. The MessageID is a unique id and the same MessageID is set among request, response, and confirmation so that IPTV Service Profile function can use the MessageID to correlate request, response, and confirmation.</td></tr>
<tr><td>11.</td><td>The IPTV Service Profile function validates the data received from the CSP-T Server.</td></tr>
<tr><td>12.</td><td>If validation succeeds, the IPTV Service Profile function returns to CSP-T Server the data necessary to fulfil the CSP request.  If validation fails, an error is returned to the CSP-T Server.</td></tr>
<tr><td>13.</td><td>The CSP-T Server sends a Marlin (Deregistration) response message to the CSP.  This response includes either the deregistration agent correlated to the Business Token sent in the original CSP request, or an error message as defined in [[!MRL-BNSP]].</td></tr>
<tr><td>14.</td><td>The CSP sends a (Marlin Deregistration Protocol) Confirmation to the CSP-T Server by UNIS-CSP-T.</td></tr>
<tr><td>15.</td><td>The CSP-T Server checks the resultCode (i.e. success or failure for deregistration in CSP) and Message ID, and then stores the “From Node” and “To Node” information by correlating it with the user information, so that CSP-T Server can manage Marlin domain information for the user.</td></tr>
<tr><td>16.</td><td>The CSP-T Server sends the resultCode and the MessageID to the IPTV Service Profile function by NPI-CSPT1a.</td></tr>
<tr><td>17.</td><td>The IPTV Service Profile function stores the resultCode in connection with the user information from step 4.</td></tr>
</table>
</section>
<section id="marlin-license-acquisition"><h5>Marlin License Acquisition (informative)</h5>
<p>License Acquisition provides functions which enable Marlin Client Function in CSP to obtain a Marlin License.</p>
<p>Marlin License Acquisition Protocol is triggered by a Marlin Action Token for License Acquisition (hereafter License Acquisition Action Token) from CSP. The OITF Function acquires the License Acquisition Action Token, and then the OITF Function feeds it to the CSP. After CSP acquires corresponding Marlin Configuration Token from CSP-T Server, CSP executes Marlin License Acquisition Protocol with CSP-T Server.</p>
<p>The sequence of license acquisition messages is shown in Figure <a href="#marlin-license-acquisition-sequence" class="figureRef"></a>.</p>
<figure id="marlin-license-acquisition-sequence">
<img alt="FIGURE 5" src="images/MarlinLicenseAcquisition.png" />
<figcaption>Figure ####: License Acquisition Sequence</figcaption>
</figure>
<p>In this sequence, the following steps are performed:</p><table class="sequence">
<tr><td>1.</td><td>The OITF Function (e.g. DAE) communicates with IPTV Applications and IPTV Service Profile function via UNIS-6 and NPI-17 for License Acquisition.<div class="footnote">Note that, although NPI-17 is assumed as the interface for communication be	tween IPTV Applications and IPTV Service Profile, in the case of the managed network model, NPI-2 and NPI-6 may be used instead.</div></td></tr>
<tr><td>2.</td><td>Given the Marlin Action Token URL (e.g. embedded into the webpage obtained in step1), the OITF Function (e.g. DAE application) sends the request for the License Acquisition Action Token to the IPTV Applications by UNIS-6.</td></tr>
<tr><td>3.</td><td>When receiving the request from the OITF Function, the IPTV Applications sends a request to the IPTV Service Profile function by NPI-17 to get the information necessary to generate the License Acquisition Action Token.</td></tr>
<tr><td>4.</td><td>Receiving the request from IPTV Applications, the IPTV Service Profile function sends Business Token and user information to IPTV Applications. This user information for License Acquisition also indicates “Bound to Node” of the Marlin License.</td></tr>
<tr><td>5.</td><td>Given the information from the IPTV Applications, the CSP-T Server correlates the Business Token with the “Bound to Node” so that the CSP-T Server can check the information in a (Marlin License Acquisition Protocol) request.</td></tr>
<tr><td>6.</td><td>IPTV Applications sends the License Acquisition Action Token to the OITF Function by UNIS-6.</td></tr>
<tr><td>7.</td><td>Given the License Acquisition Action Token, the OITF Function sends it to the CSP by CSP-1.</td></tr>
<tr><td>8.</td><td>When the CSP does not have a corresponding Marlin Configuration Token, the CSP obtains the Marlin Configuration Token from the CSP-T Server by referring to the URL specified in the License Acquisition Action Token.</td></tr>
<tr><td>9.</td><td>Given the License Acquisition Action Token, the CSP sends a (Marlin License Acquisition Protocol) request to the CSP-T Server by UNIS-CSP-T.</td></tr>
<tr><td>10.</td><td>To check the request from the CSP, when the request includes the correct combination of Business Token and “Bound to Node”, the CSP-T Server sends a Business Token to the IPTV Service Profile function by NPI-CSPT1a.</td></tr>
<tr><td>11.</td><td>The IPTV Service Profile function validates the data received from the CSP-T Server. If validation fails, an error is returned to the CSP-T Server. If validation succeeds, the IPTV Service Profile function returns to CSP-T Server the data necessary to generate the Marlin License, consisting at a minimum of:<ul>
<li>M-CID (Marlin Content ID)
<li>Usage Information which includes the content usage rules</ul></td></tr>
<tr><td>12.</td><td>To get the corresponding Content Key, the CSP-T Server sends the M-CID to the CSKMF by NPI-CSPT3.</td></tr>
<tr><td>13.</td><td>When receiving the information, the CSKMF looks for the corresponding Content Key (*) by M-CID, and then sends the Content Key (*) and M-CID to the CSP-T Server by NPI-CSPT3.<div class="footnote">* When the content is protected by Scramble Key and Service Key (or Program Key), the Service Key (or Program Key) is provided from CSKMF to CSP-T Server instead of Content Key. See section <a href="#content-encryption" class="sectionRef"></a>, for a brief explanation of such encryption scheme.</div></td></tr>
<tr><td>14.</td><td>The CSP-T Server sends a Marlin (License) response message to the CSP. This response includes either the License correlated to the Business Token sent in the original CSP request, or an error message as defined in [[!MRL-BNSP]].</td></tr>
</table>
</section>
</section>
</section>
<section id="protected-content-usages"><h3>Protected Content Usages</h3>
<p>Protected content usages include: playback, recording, time shifting. </p>
<p>Protected content can be played from a native application or from a DAE application using A/V Control or video/broadcast object as defined in [[.OIPF_DAE2]]</p>
<p>Protected content can be time-shifted from a native application or from a DAE application using video/broadcast object as defined in [[.OIPF_DAE2]]</p>
<p>Protected content can be recorded from a native application or from a DAE application video/broadcast object as defined in [[.OIPF_DAE2]]</p>
<p>CSP SHALL control protected content usages as defined in [[!MRL-BNSP]] for License evaluation, [[!MRL-MS3]] for evaluation of Stream Access Statements, and [[!MRL-BBTS]] for ECM control. See also section <a href="#content-encryption" class="sectionRef"></a> for an overview.</p>
<p>If usages are not allowed, CSP SHALL block the consumption of program (i.e. stop descrambling) and SHALL generate the appropriate event (no rights, parental control locking) to the calling application, i.e. native application or DAE object. The DAE A/V Control or video/broadcast object SHALL trigger the event to the calling DAE application as specified in <a href="#interface-csp-oitf" class="sectionRef"></a>.</p>
<p>For MPEG-2 TS, usages SHALL be controlled at each ECM change. For other file formats, usages are controlled only when requesting the usage.</p>
<section id="marlin-license-evaluation"><h4>Marlin License Evaluation (informative)</h4>
<section id="license-evaluation-for-pdcf-or-ipmp"><h5>License Evaluation (for (P)DCF [[!OMARLIN]] or Marlin IPMP [[!MRL-FF]]) (informative)</h5>
<p>This section describes the informative overview of how Marlin data objects acquired via Marlin Protocols are used for consumption of protected contents, such as rendering or exporting.</p>
<p>Figure <a href="#license-evaluation-sequence" class="figureRef"></a> shows the message flow of License Evaluation.</p>
<figure id="license-evaluation-sequence">
<img alt="FIGURE 6" src="images/LicenseEvaluationSequence.png" />
<figcaption>Figure ####: License Evaluation Sequence</figcaption>
</figure>
<p>In order to gain access to a protected content, steps below are performed:</p><table class="sequence">
<tr><td>1.</td><td>OITF Function such as DAE  triggers the evaluation of a corresponding Marlin License at CSP via Stream Session Management and Control by providing following information:
<div class="footnote">Note that, although DAE is used as a function to trigger the License Evaluation, this is only for illustrative purposes and other OITF function can be used, such as OITF embedded application depending on the design of the OITF.</div><ul>
<li>Content URL: the protected content to be accessed.
<li>Optionally, M-CID (Marlin Content ID): Id of the protected content to be accessed. The M-CID can also be retrieved from the content, ContentAccessDescriptor [[.OIPF_DAE2]], BCG, or SD&amp;S [[.OIPF_META2]].
<li>Operation: operation to perform with the protected content (e.g., render, export).</ul></td></tr>
<tr><td>2.</td><td>The Marlin Client Function in CSP is required to check the following:<ul>
<li>The PKI signatures on the Marlin data objects related to the protected content are validated. For trust management of Marlin, see section 9 of [[!MRL-CORE]].
<li>The usage rule specified in the Marlin data objects for the protected content is valid for CSP.
<li>If the license evaluation succeeds, the CSP returns the corresponding Content Key and attached usage information such as Output Control</ul> Information (if any) to the Stream Session Management and Control. Otherwise, the CSP responds with an error.</td></tr>
<tr><td>3.</td><td>The Stream Session Management sends the received Content, Content Key and attached usage information, to the Decrypt function.</td></tr>
</table>
</section>
<section id="license-evaluation-for-mpeg2-transport-stream"><h5>License Evaluation (for MPEG-2 Transport Stream) (informative)</h5>
<p>Figure <a href="#scramble-key-decryption-sequence" class="figureRef"></a> shows the message flow of License Evaluation with Scramble Key Decryption.</p>
<figure id="scramble-key-decryption-sequence">
<img alt="FIGURE 7" src="images/ScrambleKeyDecryptionSequence.png" />
<figcaption>Figure ####: Scramble Key Decryption Sequence</figcaption>
</figure>
<p>When the content is encrypted by Scramble Key, License Evaluation and Scramble Key Decryption sequence below is followed:</p><table class="sequence">
<tr><td>1.</td><td>OITF Function such as DAE triggers the evaluation of a corresponding Marlin License at CSP via Stream Session Management and Control by providing following information:<div class="footnote">Note that, although DAE is used as a function to trigger the License Evaluation, this is only for illustrative purposes and can be performed by another OITF function, such as OITF embedded application, depending on the design of the OITF.</div><ul>
<li>Content URL: the protected content to be accessed (Local or remote URL).
<li>Optionally, M-CID (Marlin Content ID): Id of the protected content to be accessed. The M-CID can also be retrieved from the content, ContentAccessDescriptor [[.OIPF_DAE2]], BCG, or SD&amp;S [[.OIPF_META2]].
<li>Operation: operation to perform with the protected content (e.g., render, export).</ul></td></tr>
<tr><td>2.</td><td>The Marlin Client Function in CSP is required to check the following:<ul>
<li>The PKI signatures on the Marlin data objects related to the protected content are validated (signature O.K. and certificate chain is successfully chained up to the Marlin Trust Anchors).
<li>The usage rule specified in the Marlin data objects for the protected content is valid for CSP.</ul></td></tr>
<tr><td>3.</td><td>If the license evaluation succeeds, the CSP returns attached usage information such as Output Control Information (if any) to the Stream Session Management and Control. Otherwise, the CSP responds with an error.</td></tr>
<tr><td>4.</td><td>The Stream Session Management and Control provides an ECM to the CSP. The ECM includes a Scramble Key encrypted by a Service or Program key and attached ECM information including the Encryption Algorithm Type, Parental Control Information, recording control Information and Output Control Information.</td></tr>
<tr><td>5.</td><td>The CSP checks the ECM on integrity. If this is OK, the CSP decrypts encrypted Scramble Key with the appropriate key, and, based on the combined Output Control Information in the ECM and license, the CSP determines updated Output Control Information as specified in [[!MRL-BBTS]].</td></tr>
<tr><td>6.</td><td>The CSP sends Scramble Key and attached usage and ECM information to the Stream Session Management and Control.</td></tr>
<tr><td>7.</td><td>The Stream Session Management sends the received Content, Scramble Key and attached usage and ECM information to the Decrypt.</td></tr>
</table>
<p>Note that the sequence assumes that Stream Session Management and Control is trusted by the CSP and that the Scramble Key, permission to perform the requested operation and attached usage information are transferred over a secure channel.</p>
</section>
</section>
</section>

<section id="content-encryption"><h3>Content Encryption (informative)</h3>
<p>This section contains an informative overview of Content Encryption to clarify sequences related to Content Key, Service or Program key, and Scramble Key in section <a href="#marlin-license-acquisition" class="sectionRef"></a> and <a href="#marlin-license-evaluation" class="sectionRef"></a>.</p>
<p>Figure <a href="#cod-encryption-sequence-using-content-key-pdcf-ipmp" class="figureRef"></a>, Figure <a href="#cod-encryption-sequence-using-content-key-mpeg2" class="figureRef"></a> and Figure <a href="#sc-encryption-sequence-using-scramble-key-mpeg2" class="figureRef"></a> show the message flows of Content Encryption.</p>

<figure id="cod-encryption-sequence-using-content-key-pdcf-ipmp">
<img alt="FIGURE 8" src="images/CODEncryptionSequenceUsingContentKeyForPDCForIPMP.png" />
<figcaption>Figure ####: Content on Demand Encryption Sequence using Content Key (for (P)DCF [[!OMARLIN]] or Marlin IPMP [[!MRL-FF]])</figcaption>
<!--<figcaption>Figure ####: Content on Demand Encryption Sequence using Content Key (for (P)DCF [OMARLIN] or Marlin IPMP [MRL-FF])</figcaption>-->
</figure>
<p>When (P)DCF [[!OMARLIN]] or Marlin IPMP [[!MRL-FF]] Content On Demand is encrypted using Content Key, the following steps are performed in Content Encryption sequence:</p><table class="sequence">
<tr><td>1.</td><td>The Content on Demand Management requests for a content specified by M-CID (Marlin Content ID), the Content Key to use.</td></tr>
<tr><td>2.</td><td>The Content and Service Key Management function returns the Content Key.</td></tr>
<tr><td>3.</td><td>The Content on Demand Encryption Management Function launches encryption of the content in the clear using the M-CID (Marlin Content ID) and Content Key. The protected content is generated.</td></tr>
<tr><td>4.</td><td>The Content on Demand Management stores the protected content in the Content Storage.</td></tr>
</table>

<figure id="cod-encryption-sequence-using-content-key-mpeg2">
<img alt="FIGURE 9" src="images/CODEncryptionSequenceUsingContentKeyForMPEG2.png" />
<figcaption>Figure ####: Content on Demand Encryption Sequence using Content Key (for MPEG-2 TS)</figcaption>
</figure>
<p>When MPEG-2 TS Content on Demand is encrypted using Content Key, the following steps are performed in Content Encryption Sequence:</p><table class="sequence">
<tr><td>1.</td><td>The Content on Demand Management requests for the content item specified by M-CID (Marlin Content ID), the Content Key and ECM attached information, including the Encryption Algorithm, Parental Control Information and Output Control Information, to use.</td></tr>
<tr><td>2.</td><td>The Content and Service Key Management function returns the Content Key and ECM attached information.</td></tr>
<tr><td>3.</td><td>The Content on Demand Encryption Management Function launches encryption of the content in the clear. Scramble Keys are generated and the content is encrypted using these Scramble Keys. The Scramble Keys are encrypted using the Content Key. ECMs that include Scramble Keys and provided ECM attached information are inserted into the protected content.</td></tr>
<tr><td>4.</td><td>The Content on Demand Encryption Management Function stores the protected content in the Content Storage.</td></tr>
</table>

<figure id="sc-encryption-sequence-using-scramble-key-mpeg2">
<img alt="FIGURE 10" src="images/ScheduledContentEncryptionSequenceUsingScrambleKeyForMPEG2.png" />
<figcaption>Figure ####: Scheduled Content Encryption Sequence using Scramble Key (for MPEG-2 TS)</figcaption>
</figure>
<p>When MPEG-2 TS Scheduled Content is encrypted by Scramble Keys then the Scramble Keys are encrypted by a Service or Program key, the following steps are performed in Content Encryption Sequence:</p><table class="sequence">
<tr><td>1.</td><td>The Content and Service Key Management function sends the M-CID (Marlin Content ID), Service key and possibly a Program key, ECM attached information including Encryption Algorithm, Parental Control Information and Output Control Information to the Multicast Content Delivery Function.</td></tr>
<tr><td>2.</td><td>The Multicast Content Delivery Function generates Scramble Keys and then encrypts clear content using these Scramble Keys. Then the Multicast Content Delivery Function encrypts the Scramble Keys using the Service Key or Program Key. When the Program Key is used for encryption of Scramble Keys, the Multicast Content Delivery Function encrypts the Program Key using the Service Key. An ECM that includes the encrypted Scramble Keys and provided ECM attached information is inserted into the protected content. </td></tr>
<tr><td>3.</td><td>Protected scheduled content is sent to the Transport Processing Function through UNIT-17M.</td></tr>
</table>
</section>
<section id="protected-file-formats"><h3>Protected File Formats</h3>
<p>The protected file formats supported in the present specification are:</p><ul>
<li>the MP4 file format as defined in <a href="volume2.html#system-mp4-file-format" class="extRef">section 4.2</a> of [[.OIPF_MEDIA2]]<ul>
<li>encrypted according to the OMA (P)DCF file formats, including Marlin specific extensions in an OMA compatible way, as defined in section 4 of [[!OMARLIN]],
<li>encrypted according to the Marlin IPMP file format as specified in section 2.3 of [[!MRL-FF]],
<li>encrypted as specified in [[!CENC]],</ul>
<li>the MPEG-2 TS file format as specified in section <a href="#protection-of-mpeg2-transport-streams" class="sectionRef"></a>.
</ul>
<p>NOTE: this section lists four different protected file formats supported by this specification. The criteria that determine under which circumstances which one or more of these is implemented are out of the scope of the present document.</p>
</section>
<section id="protection-of-mpeg2-transport-streams"><h3>Protection of MPEG-2 Transport Streams</h3>
<p>If the OITF supports the unprotected MPEG-2 TS format, the OITF SHALL support the Marlin protected MPEG-2 TS format, as defined in this section and its sub-sections. Otherwise, the support of the Marlin protected MPEG-2 TS format as defined in this section and its sub-sections is OPTIONAL.</p>
<p>If the OITF supports the unprotected time stamped MPEG-2 TS format, the OITF SHALL support the Marlin protected time stamped MPEG-2 TS format, as defined in this section and its sub-sections. Otherwise, the support of the Marlin protected time stamped MPEG-2 TS format as defined in this section and its sub-sections is OPTIONAL.</p>


<section id="protection-of-mpeg2-transport-streams-context"><h4>Context</h4>
<p>Transport of conditional access messages in MPEG-2 TS is defined by DVB. CA_descriptors (Conditional access descriptor) are used to signal the presence of conditional access information in the stream. Conditional access messages are transported in short MPEG-2 TS private section (section_syntax_indicator = 0). Two types of messages are considered:</p><ul>
<li>ECM messages, which are linked to descrambling, access criteria and Control Words (TEK). These messages are signalled in the CA_descriptor in the PMT. ECM Messages should have a high repetition rate in order to allow quick programme access.
<li>EMM messages, which are linked to rights management. These messages are signalled in the CA_descriptor in the CAT. These messages’ repetition rate should be set at head end level in order to comply with the operator QoS requirements.
</ul>
<figure id="signalling-ecm-and-emm">
<img alt="FIGURE 11" src="images/ConditionalAccessDescriptorsSignallingECMandEMMMessages.jpg" style="width:60%" />
<figcaption>Figure ####: Conditional Access Descriptors Signalling ECM and EMM Messages</figcaption>
</figure>
<p>This specification uses Marlin to protect MPEG-2 Transport Streams and time stamped Transport Streams as specified in [[!MRL-BBTS]]. If an OITF supports Marlin protected MPEG-2 TS, the OITF SHALL implement the functions of the DRM Client as specified in [[!MRL-BBTS]]. For Marlin protected MPEG-2 TS the Content Delivery function SHALL deliver Transport Streams or Time-stamped Transport Streams that are formatted as specified in [[!MRL-BBTS]].</p>
<p>If an OITF supports Marlin protected MPEG-2 TS, the OITF SHALL support the Parental_rating access_criteria_descriptor as specified in [[!IEC62455]], the recording control access_criteria_descriptor as specified in section <a href="#recording-control-access-criteria" class="sectionRef"></a> and SHALL support at least the rating_type 0 in these criteria, which maps to the parental rating system in DVB Systems [[!DVBSI]].</p>
<p>For the recording control, refer also to section <a href="#recording-control-access-criteria" class="sectionRef"></a>, the OITF SHALL compare the required operation with the allowed operations (PVR and time shifting) in the recording control criteria and refuse the requested operation to the calling application (native or DAE) if the requested operation is not allowed.</p>
<p>For the parental rating control, the OITF SHALL compare the program's rating from the parental rating access_criteria_descriptor with the current parental rating criterion set in the OITF by the application (either native application or DAE) and SHALL block the consumption of programme (i.e. stop descrambling), if the parental rating system is supported by the OITF and the programme’s rating does not meet the parental rating criterion (e.g. rating is at or above a certain threshold, for a rating system that is ordered from lower viewer age to higher viewer age). The OITF SHALL raise an event to the application controlling the playback or other operation, whenever a parental rating is discovered for the A/V content that does not meet the parental rating criterion that is set for the parental system in use, which has lead to blocking of the consumption of the content. The event SHALL provide the programme's rating. In case the application is a native application and if the MPEG-2 TS stream provides a Parental Control URL, as defined in section 0, the native application SHOULD launch the DAE with the Parental Control URL for management of parental control. In case the application is a DAE application, the event is called onParentalRatingChange and is defined in sections <a href="#video-broadcast-extensions-parental-ratings" class="extRef">7.13.5</a> and <a href="volume5.html#av-control-extensions-for-parental-rating-errors" class="extRef">7.14.5</a> of [[.OIPF_DAE2]].</p>
<p>If the OITF does not support the particular parental rating system used in the program, the OITF SHALL raise an event to the application controlling the playback or other operation. The event SHALL provide the programme's rating. In case the application is a DAE application, the event is called onParentalRatingError and is defined in sections <a href="#video-broadcast-extensions-parental-ratings" class="extRef">7.13.5</a> and <a href="volume5.html#av-control-extensions-for-parental-rating-errors" class="extRef">7.14.5</a> of [[.OIPF_DAE2]]. The event MAY be managed via the DAE application (see <a href="volume5.html#parental-access-control" class="extRef">section 4.5</a> of [[.OIPF_DAE2]] for more information). In case the application is a native application, the event is managed through an OITF vendor dependent user interface. In both cases, consumption MAY be unblocked by setting a new parental rating threshold. This threshold setting is usually restricted to privileged users, e.g. parents and a successful PIN input by a user may be used to control the parental rating threshold setting. The OITF SHOULD continue monitoring the MPEG-2 TS, taking into account parental rating criteria changes in ECM streams or new settings for the parental rating threshold in the OITF, and SHALL unblock consumption (i.e. re-start descrambling) if the current programme's rating becomes lower than the current parental rating threshold.</p>
<p>When no valid rights are available for the MPEG-2 TS, the OITF SHALL block the consumption of the programme (i.e. stop descrambling) and SHALL raise an event to the application controlling the playback or other operation. In case the application is a DAE application, the event is called onDRMRightsError and is defined in sections <a href="volume5.html#video-broadcast-extensions-drm-errors" class="extRef">7.13.6</a> and <a href="volume5.html#av-control-extensions-for-drm-rights-errors" class="extRef">7.14.6</a> of [[.OIPF_DAE2]]. The OITF SHOULD continue monitoring the MPEG-2 TS, taking into account criteria changes in ECM streams or rights changes in OITF and SHALL unblock consumption (i.e. re-starting descrambling) if there are valid rights for the requested operation.</p>
<p>For the avoidance of doubt, the OITF SHALL support the presence of descriptors (for a general description of descriptors, see [[!MPEG2TS]] which are not defined in this specification) but SHALL ignore these descriptors. In particular, to allow DVB-SimulCrypt with other CA systems as defined in [[!DVB-SC]] and gateway-centric approach, the presence of following descriptors SHALL be supported: CA descriptor for other CA systems than Marlin and than CA systems supported in a CSPG, scrambling descriptor [[!DVBSI]], and copyright descriptor [[!MPEG2TS]].</p>
</section>

<section id="recording-control-access-criteria"><h4>Recording Control Access Criteria</h4>
This section defines an access_criteria_descriptor that MAY be present in the IEC62455 ECM as defined in [[!MRL-BBTS]].
<table class="simple" id="access_criteria_descriptor">
<caption>Table ####: Recording Control access_criteria_descriptor</caption>
<tr><th>recording control information<br />access_criteria_descriptor</th><th>Tag</th><th>Length<br />(in bits)</th><th>Type</th></tr>
<tr><td>recording_control_information_byte</td><td>0x10</td><td>8</td><td>bslbf</td></tr>
</table>
<table class="simple bit-table" id="recording_control_information_byte">
<caption>Table ####: Bit Assignments of recording_control_information_byte</caption>
<tr><th>Bit #</th><th>7</th><th>6</th><th>5</th><th>4</th><th>3</th><th>2</th><th>1</th><th>0</th></tr>
<tr><td>Assignment</td><td>rsvd</td><td>rsvd</td><td>rsvd</td><td>rsvd</td><td>rsvd</td><td>rsvd</td><td>DNTS</td><td>DNR</td></tr>
</table>
<p>The DNR (Do Not Record) bit signals that a BBTS is not allowed to be stored for PVR function. The OITF SHALL NOT store for PVR function the TS packets of a BBTS that are received after receipt of a BBTS packet carrying an IEC62455 ECM that includes a recording control access_criteria_descriptor in which the DNR bit is set to 1.</p>
<p>The OITF MAY store for PVR function the TS packets of a BBTS that are received after receipt of a BBTS packet carrying an IEC62455 ECM that does not include a recording control access_criteria_descriptor or does include a recording control access criteria in which the DNR bit is set to 0.</p>
<p>The DNTS (Do Not Time Shift) bit signals that a BBTS is not allowed to be stored for time shifting. The OITF SHALL NOT store for time shifting the TS packets of a BBTS that are received after receipt of a BBTS packet carrying an IEC62455 ECM that includes a recording control access_criteria_descriptor in which the DNTS bit is set to 1.</p>
<p>The OITF MAY store for time shifting the TS packets of a BBTS that are received after receipt of a BBTS packet carrying an IEC62455 ECM that does not include a recording control access_criteria_descriptor or does include a recording control access criteria in which the DNTS bit is set to 0.</p>
<p>The time shifting period SHALL not exceed 90 minutes in case the DNR bit is set to 1 and the DNTS bit is set to 0.</p>
<p>The combination of DNR equals 0 (PVR allowed) and DNTS equals 1 (time shift not allowed) SHOULD NOT be set.</p>
<p>For an overview of the combinations, see Table <a href="#dnr-and-dnts-combinations" class="tableRef"></a>.</p>
<table class="simple center-2" id="dnr-and-dnts-combinations">
<caption>Table ####: DNR and DNTS Combinations</caption>
<tr><th>DNR</th><th>DNTS</th><th>Description</th></tr>
<tr><td>0</td><td>0</td><td>Time shifting allowed for infinite period; PVR allowed</td></tr>
<tr><td>0</td><td>1</td><td>SHOULD NOT occur</td></tr>
<tr><td>1</td><td>0</td><td>Time shift limited to 90 minutes; PVR NOT allowed</td></tr>
<tr><td>1</td><td>1</td><td>Time shift NOT allowed; PVR NOT allowed</td></tr>
</table>
For this version of the specification, the rsvd (reserved for future use) bits SHALL be set to 0.
</section>
<section id="pmt-table"><h4>PMT Table</h4>
<p>When creating transport streams that are formatted as specified in [[!MRL-BBTS]], the Content Delivery SHALL include a BBTS CA_descriptor [[!MRL-BBTS]] in each PMT pointing to a stream protected by Marlin and SHALL include the serviceBaseCID, see [[!MRL-BBTS]], into the BBTS CA_descriptor. The socID [[!MRL-BBTS]] used by the Content Delivery SHALL be “marlin” (without the double quotes).</p>
<p>In case DVB-SimulCrypt is used with other CA systems as defined in [[!DVB-SC]] and/or with the gateway-centric approach then the content_key_index field in the IEC62455 ECM as defined in [[!MRL-BBTS]] SHALL match the scrambling_mode of the other CA system. If the cipher_mode field is 0x1 (CBC) then the initial_vector and next_initial_vector fields in the IEC62455 ECM SHALL be set to 0 as specified in [[!ATIS-IDSA]].</p>
</section>
<section id="cat-table"><h4>CAT Table</h4>
<p>When creating transport streams that are formatted as specified in [[!MRL-BBTS]], the Content Delivery function MAY include a BBTS CA_descriptor [[!MRL-BBTS]] in the CAT for streams protected by Marlin, in order to provide Marlin Rights URLs. If several Marlin Rights URL sets are provided for different service operators, the Content Delivery SHALL include several BBTS CA_descriptor and each BBTS CA_descriptor SHALL include a different serviceBaseCID.</p>
<p>The Rights Issuer URL section, defined in [[!MRL-BBTS]] MAY contain a Parental Control URL, as defined in this section. Use of the Parental Control URL is described in section <a href="#protection-of-mpeg2-transport-streams-context" class="sectionRef"></a>.</p>
<p>The coding of the Parental Control URL parameter in the TLV format is the following:</p>
<table class="syntax-table" id="parental_control_url-syntax">
<caption>Table ####: Parental_Control_URL Parameter Syntax</caption>
<tr><th>Syntax</th><th>Mnemonic</th><th>No. of bits</th></tr>
<tr><td>Parental_Control_URL () {</td><td></td><td></td></tr>
<tr><td>&nbsp;&nbsp;Parental_Control_URL_tag = 0x05</td><td>uimsbf</td><td>8</td></tr>
<tr><td>&nbsp;&nbsp;Parental_Control_URL_length</td><td>uimsbf</td><td>8</td></tr>
<tr><td>&nbsp;&nbsp;For (i=0; i&lt;N; i++){</td><td></td><td></td></tr>
<tr><td>&nbsp;&nbsp;&nbsp;&nbsp;Parental_Control_URL_data_byte</td><td>bslbf</td><td>8</td></tr>
<tr><td>&nbsp;&nbsp;}</td><td></td><td></td></tr>
<tr><td>}</td><td></td><td></td></tr>
</table>

<table class="arguments-table">
<tr><td>Parental_Control_URL_tag</td><td>This specification has defined the value of 0x05 for the Parental Control URL parameter.</td></tr>
<tr><td>Parental_Control_URL_length</td><td>Specifies the length of the Parental_Control_URL_data_byte in bytes (N).</td></tr>
<tr><td>Parental_Control_URL_data_byte</td><td>The Parental Control URL for this content.</td></tr>
</table>


<p>NOTE: The syntax of Table <a href="#parental_control_url-syntax" class="tableRef"></a> and similar tables in subsequent sections follows conventions outlined in [[!MPEG2TS]] (e.g. mnemonics, use of C-language like loop descriptors).</p>
<p>Before accessing the Rights Issuer URL specified in [[!MRL-BBTS]], the OITF, or the DAE application that receives an “onDRMRightsError” event as defined in sections <a href="volume5.html#video-broadcast-extensions-drm-errors" class="extRef">7.13.6</a> and <a href="volume5.html#av-control-extensions-for-drm-rights-errors" class="extRef">7.14.6</a> of [[.OIPF_DAE2]], SHALL obtain user consent to access the web page. When a service receives an HTTP request to the Rights Issuer URL, the service SHOULD respond with an HTML page and not with a Marlin Action Token or with a Marlin License. This HTML SHALL comply with CE-HTML. After user interaction via the HTML pages, the service MAY return a Marlin Action Token or Marlin License.</p>
<p>Before accessing the Parental Control URL specified in this section, OITF SHALL obtain user consent to access the web page. When receiving an HTTP request to the Parental Control URL, the service SHOULD respond with an HTML page This HTML SHALL comply with CE-HTML.</p>
</section>
<section id="system-renewability-messages"><h4>System Renewability Messages</h4>
<p>In the scope of this specification, DTCP and HDCP System Renewability Messages (SRM) can be transported in a Marlin protected MPEG-2 TS. The signalling and transport of SRM in Marlin protected MPEG-2 TS SHALL comply with [[!DVB-SRM]] specification.</p>
<p>If an OITF supports HDCP output and receives Marlin protected MPEG2-TS format, the OITF SHALL detect the presence of HDCP System Renewability Messages and install them, as defined in [[!HDCP]].</p>
<p>If an OITF supports DTCP output and receives Marlin protected MPEG2-TS format, the OITF SHALL detect the presence of DTCP System Renewability Messages and install them, as defined in [[!DTCP]].</p>
</section>
</section>
<section id="operation-of-marlin"><h3>Operation of Marlin Technologies</h3>
<p>This section specifies the operation of Marlin technologies to support certain type of use cases.</p>
<section id="status-of-marlin-license-support"><h4>Status of Marlin License Support</h4>
<p>A usage rule which uses status information (such as count) is supported in the Marlin License (e.g. burn usage rule by allowing Export action to a certain target system). When the Marlin License requires status management in the client, the corresponding Marlin License SHOULD also have a ‘not after’ condition specified in the absolute validity period. The value specified by ‘not after’ SHOULD be no later than 1 month from the issuance of the Marlin License. For example, when the Marlin License issued on 24 November 2008 00:00 allows 3 times burn to Blu-ray, this Marlin License should only be valid until 24 December 2008 00:00.</p>
</section>
<section id="subscription-support"><h4>Subscription Support</h4>
<p>A CSP function that implements this specification MUST support BNS Extended Topology for Subscription Nodes as defined in [[!MRL-BNSP]]. It means that CSP MUST support following Marlin Protocols for Subscription Node which are originally defined as OPTIONAL functions in [[!MRL-BNSP]]:</p><ul>
<li>Marlin License Acquisition to bind Marlin License to Subscription Node
<li>Marlin Deregistration from a domain represented by Subscription Node where a corresponding Subscription Link SHALL have the following properties:<ul>
<li>LinkFrom: Personality Node or User Node
<li>LinkTo: Subscription Node
</ul></ul>
<p>The CSP MUST signal this support of the BNS Extended Topology by using the mechanism defined in [[!MRL-BNSP]], section 6.2.</p>
</section>
</section>
<section id="tca-drm-data"><h3>DRM Data</h3>
<section id="tca-drmsystemid"><h4>DRMSystemID</h4>
<p>DRMSystemID, used to signal the type of DRM, is defined in [[.OIPF_META2]]. DRMSystemID is used in metadata structures, defined in [[.OIPF_META2]], in APIs defined in [[.OIPF_DAE2]] and in protocols defined in [[.OIPF_PROT2]]. For Marlin, since the DVB CA_System_ID is assigned as 0x4AF4, the value for the DRMSystemID to signal Marlin SHALL be set to the following value: “urn:dvb:casystemid:19188”. In addition to the DRMSystemID “urn:dvb:casystemid:19188” signaling Marlin, URN “urn:marlin:ms3:1-0” defined in [[!MRL-MS3]] section 1.3.1 MAY be used as a second DRMSystemID to signal that Marlin Simple Secure Streaming feature is supported.</p>
</section>
<section id="drm-control-information"><h4>Metadata – DRM Control Information</h4>
<p>A DRM Control Information structure to hold DRM dependant control parameters is defined in [[.OIPF_META2]] as an extended element included in Content Access Descriptor, defined in [[.OIPF_DAE2]] and extension of PurchaseItem element of BCG and SD&amp;S metadata, defined in [[.OIPF_META2]].
For Marlin protected content, the element of DRMControlInformation SHALL be mapped as specified in the following table:</p>
<table class="simple" id="drmcontrolinformation-for-marlin">
<caption>Table ####: DRMControlInformation Mapping for Marlin</caption>
<tr><th>Element / Attribute Name</th><th>Element / Attribute Mapping for Marlin</th></tr>
<tr><td colspan=2>DRMControlInformation</td></tr>
<tr><td>DRMSystemID</td><td>SHALL be set to the value defined for the Marlin System ID, in section <a href="#tca-drmsystemid" class="sectionRef"></a>.</td></tr>
<tr><td>DRMContentID</td><td>SHALL be set Marlin Content ID. For Marlin protected MPEG-2 TS or timespamped MPEG2-TS, the content ID is derived from the socID; together with serviceBaseCID as defined in [[!MRL-BBTS]].</td></tr>
<tr><td>RightsIssuerURL</td><td>SHOULD be set to the RightsIssuerURL present in Marlin protected content formats, defined in section <a href="#protected-file-formats" class="sectionRef"></a> and <a href="#protection-of-mpeg2-transport-streams" class="sectionRef"></a>.</td></tr>
<tr><td>SilentRightsURL</td><td>SHOULD be set to the SilentRightsURL present in Marlin protected content formats, defined in section <a href="#protected-file-formats" class="sectionRef"></a> and <a href="#protection-of-mpeg2-transport-streams" class="sectionRef"></a>. When accessing to this SilentRightsURL, Marlin Action Token or MIPPVControlMessage MAY be returned.</td></tr>
<tr><td>PreviewRightsURL</td><td>SHOULD be set to the PreviewRightsURL present in Marlin protected content formats, defined in section <a href="#protected-file-formats" class="sectionRef"></a> and <a href="#protection-of-mpeg2-transport-streams" class="sectionRef"></a>.</td></tr>
<tr><td>DoNotRecord</td><td>SHOULD be set to the same value as the DNR (Do Not Record) bit in recording control access criteria defined in section <a href="#recording-control-access-criteria" class="sectionRef"></a>.</td></tr>
<tr><td>DoNotTimeShift</td><td>SHOULD be set to the same value as the DNTS (Do Not Time Shift) bit in recording control access criteria defined in section <a href="#recording-control-access-criteria" class="sectionRef"></a>.</td></tr>
<tr><td>DRMGenericData</td><td>Placeholder element for which currently no mapping is defined.</td></tr>
<tr><td>DRMPrivateData</td><td>DRMPrivateData SHALL be an instance of a MarlinPrivateDataType structure, see section <a href="#marlinprivatedatatype-schema" class="sectionRef"></a>.</td></tr>
<tr><td>mimeType</td><td>SHALL be set to the mime type of the DRMPrivateData. For Marlin, it SHALL therefore be set to MIME type of a Marlin License, see [[!MRL-BNSP]] or to the MIME type of a Marlin Token, see [[!MRL-BNSP]].</td></tr>
</table>
<p>If Marlin Simple Secure Streaming feature is supported, in addition to the DRMControlInformation structure given in Table <a href="#drmcontrolinformation-for-marlin" class="tableRef"></a>, an second DRM Control Information structure MAY be present with parameters mapped as specified in the following table:</p>
<table class="simple" id="drmcontrolinformation-for-ms3">
<caption>Table 5b: DRMControlInformation Mapping for Marlin Simple Secure Streaming</caption>
<tr><th>Element / Attribute Name</th><th>Element / Attribute Mapping for Marlin</th></tr>
<tr><td colspan=2>DRMControlInformation</td></tr>
<tr><td>DRMSystemID</td><td>SHALL be set to the value defined for the Marlin Simple Secure Streaming feature, in section <a href="#tca-drmsystemid" class="sectionRef"></a>.</td></tr>
<tr><td>DRMContentID</td><td>SHALL be set Marlin Content ID. In case of scheduled content over IP, the content ID is derived from the socID; together with serviceBaseCID as defined in [[!MRL-BBTS]].</td></tr>
<tr><td>RightsIssuerURL</td><td>Placeholder element for which currently no mapping is defined.</td></tr>
<tr><td>SilentRightsURL</td><td>Placeholder element for which currently no mapping is defined.</td></tr>
<tr><td>PreviewRightsURL</td><td>Placeholder element for which currently no mapping is defined.</td></tr>
<tr><td>DoNotRecord</td><td>SHOULD be set to the same value as the DNR (Do Not Record) bit in recording control access criteria defined in section <a href="#recording-control-access-criteria" class="sectionRef"></a>.</td></tr>
<tr><td>DoNotTimeShift</td><td>SHOULD be set to the same value as the DNTS (Do Not Time Shift) bit in recording control access criteria defined in section <a href="#recording-control-access-criteria" class="sectionRef"></a>.</td></tr>
<tr><td>DRMGenericData</td><td>Placeholder element for which currently no mapping is defined.</td></tr>
<tr><td>DRMPrivateData</td><td>DRMPrivateData SHALL be an instance of a MarlinPrivateDataType structure, see section <a href="#marlinprivatedatatype-schema" class="sectionRef"></a>.</td></tr>
<tr><td>mimeType</td><td>SHALL be set to the mime type of the DRMPrivateData. For Marlin Simple Secure Streaming feature, it SHALL be set to MIME type of a Marlin Token, [[!MRL-MS3]].</td></tr>
</table>
<p>Both MarlinPrivateDataType and HexBinaryPrivateDataType extend DRMPrivateDataType, defined in [[.OIPF_META2]]; and so the element DRMPrivateData can be substituted by either MarlinPrivateData or HexBinaryPrivateData as defined below:</p>
<figure id="outline-of-drmcontrolinformationtype-with-marlinprivatedata">
<img alt="FIGURE 12" src="images/DRMControlInformationType-for-MarlinPrivateData.png" />
<figcaption>Figure ####: Outline of DRMControlInformationType with MarlinPrivateData</figcaption>
</figure>
<p>The XML schema for the MarlinPrivateDataType is defined in section <a href="#marlinprivatedatatype-schema" class="sectionRef"></a>.</p>
<table class="simple" id="marlinprivatedata-structure">
<caption>Table ####: MarlinPrivateData Structure</caption>
<tr><th>Element / Attribute Name</th><th>Element / Attribute Description</th></tr>
<tr><td colspan=2>MarlinPrivateData</td></tr>
<tr><td>MarlinLicense</td><td>A Base64 encoded XML Document containing an instance of a Marlin License, typically used for channel preview.</td></tr>
<tr><td>MarlinToken</td><td>A Base64 encoded XML Document containing an instance of a Marlin Token, to be used for triggering Marlin Protocol.</td></tr>
</table>
</section>
<section id="dae-marlin-messages"><h4>DAE Marlin Messages</h4>
<p>The CSP SHALL support receiving the following messages via the <a href="volume5.html#oipfdrmagent-senddrmmessage" class="apiRef">sendDRMMessage</a> API defined in [[.OIPF_DAE2]], <a href="volume5.html#application-oipfdrmagent" class="extRef">section 7.6.1</a>.</p><ul>
<li>Marlin Action Token, format and mime type defined in [[!MRL-BNSP]].
<li>MIPPVControlMessage, format and mime type defined in section <a href="#mippvcontrolmessage-format" class="sectionRef"></a>
<li>Marlin License, format and mime type defined in [[!MRL-BNSP]].</ul>
<p>For these messages, the DRMSystemID SHALL be set to the value defined for the Marlin System ID in section <a href="#tca-drmsystemid" class="sectionRef"></a>.</p>
<section id="mippvcontrolmessage-format"><h5>MIPPVControlMessage Format</h5>
<p>This section describes the usage of MIPPVControlMessage, which is used for pay per view case, and defines the message structure of MIPPVControlMessage. MIPPVControlMessage is used in a pay per view use case where a large number of users try to acquire Marlin License just before a pay per view program begins. To avoid such simultaneous accesses to CSP-T (DRM Server), a service can apply MIPPVControlMessage which includes common Marlin License (i.e. common for OITFs), Marlin Action Token, and Marlin License acquisition timing information. These three data items are used as follows in a typical pay per view case:</p><ol>
<li>When an OITF Function (e.g. DAE application) receives a MIPPVControlMessage, the OITF Function (e.g. DAE application) passes the MIPPVControlMessage to CSP. CSP uses common Marlin License embedded in MIPPVControlMessage to play a pay per view program until it gets the Marlin License that is valid only for that OITF. Since a common Marlin License is valid for any OITF, the common Marlin License expires during the pay per view program.
<li>By following the timing information in MIPPVControlMessage, the client executes the Marlin Action Token in MIPPVControlMessage, and then it acquires the Marlin License for the OITF.
<li>After acquisition of the Marlin License for the OITF, the OITF can play the pay per view program even after the expiration of the common Marlin License.</ol>
<p>The MIPPVControlMessage includes Marlin License, which is common among clients, Marlin Action Token, which is used to acquire the unique Marlin License, and timing information, which indicates the timing to initiate Marlin License Acquisition protocols. </p>
<figure id="outline-of-mippvcontrolmessage">
<img alt="FIGURE 13" src="images/OutlineOfMIPPVControlMessage.png" />
<figcaption>Figure ####: Outline of MIPPVControlMessage</figcaption>
</figure>
<p>The XML schema for the MIPPVControlMessage is defined in section <a href="#mippvcontrolmessage-schema" class="sectionRef"></a>.</p>
<p>Each element has the following semantics:</p>
<table class="simple" id="mippvcontrolmessage-format-table">
<caption>Table ####: MIPPVControlMessage Format</caption>
<tr><th>Element / Attribute Name</th><th>Element / Attribute Description</th></tr>
<tr><td colspan=2>MIPPVControlMessage</td></tr>
<tr><td>MarlinLicense</td><td>A Base64 encoded XML Document containing an instance of a Marlin License.</td></tr>
<tr><td>MarlinActionToken</td><td>A Base64 encoded XML Document containing an instance of a Marlin Action Token.</td></tr>
<tr><td>absoluteAcquisitionTiming</td><td>License acquisition timing in absolute time</td></tr>
<tr><td>relativeAcquisitionTiming</td><td>License acquisition timing in relative time from the start of the content</td></tr>
</table>
<p>MIME type of MIPPVControlMessage is defined as follows:</p>
<pre>application/vnd.oipf.mippvcontrolmessage+xml</pre>

</section>
</section>
</section>
</section>
<section id="gca"><h2>Gateway-Centric Approach</h2>
<section><h3>Capabilities</h3>
<p>DAE SHALL signal which CA_System_ID values [[!MPEG2TS]] and optionally the type of CSP Gateway are supported in the OITF including those available via Gateway-Centric Approach as defined in <a href="volume5.html#dae-capabilities" class="extRef">section 9</a> of [[.OIPF_DAE2]] document. </p>
<p>The list of supported CA_System_ID values and optionally the type of CSP Gateway SHALL also be retrieved by the Service Platform provider using one of the following methods:</p><ul>
<li>The OITF remote management interface [[.OIPF_PROT2]]
<li>As part of the Service Provider Discovery SUBSCRIBE message [[.OIPF_PROT2]]
</ul>
</section>
<section><h3>CSPG-DAE Interface</h3>
<p>When a DAE application uses the DRM Agent API and event, <a href="volume5.html#oipfdrmagent-senddrmmessage" class="apiRef">sendDRMMessage</a> and <a href="volume5.html#oipfdrmagent-ondrmmessageresult" class="apiRef">onDRMMessageResult</a>, defined in [[.OIPF_DAE2]] <a href="volume5.html#application-oipfdrmagent" class="extRef">section 7.6.1</a>, to handle a DRM Message (see <a href="volume5.html#application-oipfdrmagent" class="extRef">section 7.6.1</a> in [[.OIPF_DAE2]]) for a given CA_System_ID that is supported by a CSPG, the OITF SHALL forward these messages to the appropriate function, CSP or CSPG.</p>
<p>When protected content is used (played, time-shifted, recorded) from a DAE application, the OITF SHALL forward events (no rights or parental control locking) from the CSPG to the DAE application via the A/V Control or video/broadcast object. The DRM events onDRMRightsError, onParentalRatingChange and onParentalRatingError are defined in [[.OIPF_DAE2]] sections <a href="volume5.html#video-broadcast-extensions-parental-ratings" class="extRef">7.13.5</a>, <a href="volume5.html#video-broadcast-extensions-drm-errors" class="extRef">7.13.6</a>, <a href="volume5.html#av-control-extensions-for-parental-rating-errors" class="extRef">7.14.5</a> and <a href="volume5.html#av-control-extensions-for-drm-rights-errors" class="extRef">7.14.6</a>. The DRM events (no rights or parental control locking) SHALL include the CA_System_ID information.</p>
</section>
<section id="ciplus-based-gateway"><h3>CI+ based Gateway</h3>
<p>All normative statements in this section and its sub-sections apply only in case the CI+ based Gateway-Centric Approach is supported.</p>
<p>NOTE: The criteria that determine under which circumstances the CI+ based Gateway-Centric Approach is implemented are out of the scope of the present document.</p>
<section><h4>Overview</h4>
<p>The CSPG-CI+ is an optional entity handling security for the OITF. It SHALL make any specific content protection solution transparent to the OITF. This is achieved by the use of a standard secure channel between the OITF and the CSPG-CI+. The CSPG-CI+ acts as a bridge between a specific protection solution and one standard secure channel. Once the OITF and the CSPG-CI+ are mutually authenticated, the OITF is seamlessly able to receive any content that was initially secured by the different content protection solutions that the CSPG-CI+ handles. The incoming stream to the CSPG-CI+ is associated with the generic media format label “PF”, as defined in [[.OIPF_MEDIA2]].</p>
<p>The protected content stream is sent from the OITF to the CSPG-CI+ and then sent back to the OITF protected in such a way that only authenticated OITF can gain access to it. Incoming and outgoing streams format are based on MPEG-2 Transport Stream. Protected file formats based on MP4 file format (i.e. OMA (P)DCF and Marlin IPMP) are not supported.</p>
<p>The definition of the interfaces is based on the DVB CI specification ([[!DVB-CI]]) and the CI+ specification ([[!CI+]]).</p>
<p>Figure <a href="#cspg-ciplus-overview-figure" class="figureRef"></a> presents an overview of the functions and interfaces of the CSPG-CI+.</p>
<figure id="cspg-ciplus-overview-figure">
<img alt="FIGURE 14" src="images/CSPG-CI+-Overview.png" style="width:60%" />
<figcaption>Figure ####: CSPG-CI+ Overview</figcaption>
</figure>
<p>In order to provide seamless behaviour to the end user (e.g. for service selection operation), the incoming stream in Figure <a href="#cspg-ciplus-overview-figure" class="figureRef"></a> must be delivered through the UNIT-17 reference point as for the Terminal-Centric Approach. Figure <a href="#cspg-ciplus-context-figure" class="figureRef"></a> describes CSPG-CI+ in the home network context and maps interfaces from Figure <a href="#cspg-ciplus-overview-figure" class="figureRef"></a> to Home Network interfaces defined in [[.OIPF_ARCH2]].</p>
<figure id="cspg-ciplus-context-figure">
<img alt="FIGURE 15" src="images/CSPG-CI+-Context.png" />
<figcaption>Figure ####: CSPG-CI+ Context</figcaption>
</figure>
<p>The OITF and CSPG-CI+ SHALL comply with CI+ specifications ([[!CI+]]).</p>
</section>
<section><h4>CSPG-CI+ Connectivity</h4>
<p>The physical interface is based on a PCMCIA slot as specified by the DVB-CI specification ([[!DVB-CI]]) and the CI+ specification ([[!CI+]]).</p>
</section>
<section><h4>CSPG-CI+ Discovery</h4>
<p>The CSPG-CI+ discovery SHALL be performed at OITF start-up and CSPG-CI+ initialization. The setup of the session to the [[!CI+]] Specific Application Support (SAS) resource and the connection to the Open IPTV Forum private application are described in section <a href="#control-channel" class="sectionRef"></a>. A successful connection means that a CSPG-CI+ has been discovered.</p>
</section>
<section><h4>Residential Network Interfaces</h4>

<section><h5>HNI-CSP</h5>
<p>HNI-CSP is an interface to exchange control information and media between the CSPG-CI+ and the OITF.</p>
<section><h6>Control Channel</h6>
<p>OITF controls the CSPG-CI+ using resources defined in [[!DVB-CI]] as well as resources as defined in section 11 of [[!CI+]].</p>
<p>OITF and CSPG-CI+ SHALL use the SAS resource, defined in [[!CI+]], section 11.4, to handle messages as specified in this section.</p>
<p>The OITF SHALL send a SAS_connect_rqst() APDU [[!CI+]] to the CSPG-CI+ with the specific Open IPTV Forum private_host_application_ID defined in Table <a href="#oipf-private_host_application_id" class="tableRef"></a>. The CSPG-CI+ SHALL acknowledge the connection by sending back a SAS_connect_cnf() APDU [[!CI+]].  The highest private_host_application_ID value known by the host shall be tried first. If the SAS_session_status returned by the SAS_connect_cnf() APDU is not 0x00 (“Connection established”) then a lower value shall be tried and so on until success.</p>
<table class="simple" id="oipf-private_host_application_id">
<caption>Table ####: Open IPTV Forum private_host_application_ID</caption>
<tr><th>private_host_application_ID</th><th>Value (64bits)</th></tr>
<tr><td>OIPF_APPLICATION_ID for version up to V2.2 included</td><td>0x0108113101190000</td></tr>
<tr><td>OIPF_APPLICATION_ID for version above V2.2</td><td>0x0108113101190001</td></tr>
</table>
Then any further exchanges between the OITF and the CSPG-CI+ are completed through the use of the SAS_async_msg() APDU. Syntax of this APDU is reminded in Table <a href="#sas_async_msg-adpu-syntax" class="tableRef"></a>.
<table class="syntax-table" id="sas_async_msg-adpu-syntax">
<caption>Table ####: <i>SAS_async_msg()</i> APDU syntax</caption>
<tr><th>Syntax</th><th>No. of  Bits</th><th>Mnemonic</th></tr>
<tr><td>SAS_async_msg() {</td><td></td><td></td></tr>
<tr><td>&nbsp;&nbsp;SAS_async_msg_tag</td><td>24</td><td>uimsbf</td></tr>
<tr><td>&nbsp;&nbsp;length_field()</td><td></td><td></td></tr>
<tr><td>&nbsp;&nbsp;message_nb</td><td>8</td><td>uimsbf</td></tr>
<tr><td>&nbsp;&nbsp;message_length</td><td>16</td><td>uimsbf</td></tr>
<tr><td>&nbsp;&nbsp;for (i=0; i&lt;message_length; i++) {</td><td></td><td></td></tr>
<tr><td>&nbsp;&nbsp;&nbsp;&nbsp;message_byte</td><td>8</td><td>uimsbf</td></tr>
<tr><td>&nbsp;&nbsp;}</td><td></td><td></td></tr>
<tr><td>}</td><td></td><td></td></tr>
</table>

<section><h6>Specific messages</h6>
<p>The OITF and CSPG-CI+ SHALL support the messages listed in Table <a href="#oipf-specific-messages-and-command_id-values" class="tableRef"></a>. For each of the messages the message_byte payload takes the generic syntax given in Table <a href="#generic-message_byte_syntax" class="tableRef"></a>. The message data may be broken into a number of records containing the same or different types of data identified by the datatype_id.</p>
<table class="syntax-table" id="generic-message_byte_syntax">
<caption>Table ####: Generic message_byte() syntax</caption>
<tr><th>Syntax</th><th>No. of  Bits</th><th>Mnemonic</th></tr>
<tr><td>message_byte() {</td><td></td><td></td></tr>
<tr><td>&nbsp;&nbsp;command_id</td><td>8</td><td>uimsbf</td></tr>
<tr><td>&nbsp;&nbsp;ca_system_id</td><td>16</td><td>uimsbf</td></tr>
<tr><td>&nbsp;&nbsp;transaction_id</td><td>32</td><td>uimsbf</td></tr>
<tr><td>&nbsp;&nbsp;send_datatype_nbr</td><td>8</td><td>uimsbf</td></tr>
<tr><td>&nbsp;&nbsp;for (i=0; i&lt;send_datatype_nbr; i++) {</td><td></td><td></td></tr>
<tr><td>&nbsp;&nbsp;&nbsp;&nbsp;datatype_id</td><td>8</td><td>uimsbf</td></tr>
<tr><td>&nbsp;&nbsp;&nbsp;&nbsp;datatype_length</td><td>16</td><td>uimsbf</td></tr>
<tr><td>&nbsp;&nbsp;&nbsp;&nbsp;data_type()</td><td>8 * datatype_length</td><td>bslbf</td></tr>
<tr><td>&nbsp;&nbsp;}</td><td></td><td></td></tr>
<tr><td>}</td><td></td><td></td></tr>
</table>

<table class="arguments-table">
<tr><td>command_id</td><td>8-bit value that identifies the message. The values are defined in Table <a href="#oipf-specific-messages-and-command_id-values" class="tableRef"></a>.</td></tr>
<tr><td>ca_system_id</td><td>16-bit integer that identifies the CA system being queried.</td></tr>
<tr><td>transaction_id</td><td>A 32-bit value, generated by the OITF, provided in a message to the CSPG-CI+ that will be returned in any corresponding reply message from the CSPG-CI+. The transaction_id allows the OITF to match the CSPG-CI+’s replies with the corresponding requests. The OITF SHOULD increment the value, modulo 232, with every message it sends. The transaction_id should be ignored in messages sent spontaneously (events) by the CSPG-CI+ (i.e. rights_info, parental_control_info, system_info).</td></tr>
<tr><td>send_datatype_nbr</td><td>8-bit integer that gives the number of data type items included in the message.</td></tr>
<tr><td>datatype_id</td><td>8-bit integer that identifies the type of the data contained in the data type loop. The values are defined in Table <a href="#oipf-specific-datatype_id-values" class="tableRef"></a>.</td></tr>
<tr><td>datatype_length</td><td>16-bit integer that gives the length of the data_type() field in bytes.</td></tr>
<tr><td>data_type</td><td>Data type payload. The data type loop shall only contain the specified data type, but may contain multiple records of the same type, the number of records may be determined by computation of the datatype_length field.</td></tr>
</table>

<table class="simple" id="oipf-specific-messages-and-command_id-values">
<caption>Table ####: OIPF specific messages and command_id values</caption>
<tr><th>Message</th><th>command_id value (hexadecimal)</th><th colspan=2>Direction</th></tr>
<tr><td></td><td></td><td style="text-align:center">OITF</td><td style="text-align:center">CSPG-CI+</td></tr>
<tr><td>send_msg</td><td>0x01</td><td colspan=2 style="text-align:center">&rarr;</td></tr>
<tr><td>reply_msg</td><td>0x02</td><td colspan=2 style="text-align:center">&larr;</td></tr>
<tr><td>parental_control_info</td><td>0x03</td><td colspan=2 style="text-align:center">&larr;</td></tr>
<tr><td>rights_info</td><td>0x04</td><td colspan=2 style="text-align:center">&larr;</td></tr>
<tr><td>system_info</td><td>0x05</td><td colspan=2 style="text-align:center">&larr;</td></tr>
<tr><td>can_play_content_req</td><td>0x06</td><td colspan=2 style="text-align:center">&rarr;</td></tr>
<tr><td>can_play_content_reply</td><td>0x07</td><td colspan=2 style="text-align:center">&larr;</td></tr>
<tr><td>can_record_content_req</td><td>0x08</td><td colspan=2 style="text-align:center">&rarr;</td></tr>
<tr><td>can_record_content_reply</td><td>0x09</td><td colspan=2 style="text-align:center">&larr;</td></tr>
<tr><td>(reserved)</td><td>0x0A-0x7F</td><td colspan=2> </td></tr>
<tr><td>(user defined)</td><td>0x80-0xFF</td><td colspan=2> </td></tr>
</table>

<table class="simple" id="oipf-specific-datatype_id-values">
<caption>Table ####: OIPF specific datatype_id values</caption>
<tr><th>Data type</th><th>datatype_id value<br />(hexadecimal)</th></tr>
<tr><td>oipf_ca_vendor_specific_information</td><td>0x01</td></tr>
<tr><td>oipf_country_code</td><td>0x02</td></tr>
<tr><td>oipf_parental_control_url</td><td>0x03</td></tr>
<tr><td>oipf_rating_type</td><td>0x04</td></tr>
<tr><td>oipf_rating_value</td><td>0x05</td></tr>
<tr><td>oipf_rights_issuer_url</td><td>0x06</td></tr>
<tr><td>oipf_access_status</td><td>0x07</td></tr>
<tr><td>oipf_status</td><td>0x08</td></tr>
<tr><td>oipf_drm_private_data</td><td>0x09</td></tr>
<tr><td>oipf_can_play_status</td><td>0x0A</td></tr>
<tr><td>oipf_can_record_status</td><td>0x0B</td></tr>
<tr><td>(reserved)</td><td>0x0C-0x7F</td></tr>
<tr><td>(user defined)</td><td>0x80-0xFF</td></tr>
</table>
</section>


<section id="mapping-messages-to-dae-api-or-events"><h6>Mapping of messages to DAE API or Events</h6>
<p>The OITF SHALL map the specific messages listed in Table <a href="#oipf-specific-messages-and-command_id-values" class="tableRef"></a> to DAE API or Events as described in Table <a href="#mapping-to-dae-api" class="tableRef"></a>:</p>
<table class="simple centered" id="mapping-to-dae-api">
<caption>Table ####: Mapping to DAE API or Events</caption>
<tr><th>Message</th><th>DAE API or Event</th></tr>
<tr><td>send_msg</td><td><a href="volume5.html#oipfdrmagent-senddrmmessage" class="apiRef">sendDRMMessage</a></td></tr>
<tr><td>reply_msg</td><td><a href="volume5.html#oipfdrmagent-ondrmmessageresult" class="apiRef">onDRMMessageResult</a></td></tr>
<tr><td>parental_control_info</td><td>onParentalRatingChange,<br />onParentalRatingError</td></tr>
<tr><td>rights_info</td><td>onDRMRightsError</td></tr>
<tr><td>system_info</td><td><a href="volume5.html#oipfdrmagent-ondrmsystemmessage" class="apiRef">onDRMSystemMessage</a></td></tr>
<tr><td>can_play_content_req</td><td><a href="volume5.html#oipfdrmagent-canplaycontent" class="apiRef">canPlayContent</a></td></tr>
<tr><td>can_play_content_reply</td><td><a href="volume5.html#oipfdrmagent-canplaycontent" class="apiRef">canPlayContent</a></td></tr>
<tr><td>can_record_content_req</td><td><a href="volume5.html#oipfdrmagent-canrecordcontent" class="apiRef">canRecordContent</a></td></tr>
<tr><td>can_record_content_reply</td><td><a href="volume5.html#oipfdrmagent-canrecordcontent" class="apiRef">canRecordContent</a></td></tr>
</table>
</section>
<p>The DRMSystemID attribute in DAE API or Events are mapped to the ca_system_id field in the SAS_async_msg APDU. The ca_system_id field is filled by extracting the numeric value from the DRMSystemID string, such that "urn:dvb:casystemid:" is removed and the remaining number is converted from a string to a 16 bit integer. The DRMSystemId is build by prefixing the 16 bit integer converted to a decimal number string with "urn:dvb:casystemid:" as described in [[.OIPF_META2]].</p>
<p>Private data are array of bytes encoded for DAE API or Events attributes in a string using a hexadecimal representation, as defined for xs:hexBinary type used in XML schemas. In CI+ SAS_async_msg fields, the private data is encoded in bytes.</p>
<p>Precise mapping of DAE API or Events and attributes are described in the following sections.</p>


<section id="send-msg"><h6>send_msg</h6>
<p>A native application or DAE application SHOULD use the <b><i>send_msg</i></b> message to provide DRM specific messages to the CSPG-CI+.</p>
<p>When requested by either a native or DAE application, the OITF SHALL send the <b><i>send_msg</i></b> message to the CSPG-CI+ to exchange DRM messages.</p> 
<p>Examples of usage are:</p><ul>
<li>Service Provider handles the purchase of content at the server side and then uses the <b><i>send_msg</i></b> message via a DAE application to ask the CSPG-CI+ to retrieve the associated license.
<li>Service provider sends the <b><i>send_msg</i></b> message via a DAE application to the CSPG-CI+ to force the CSPG-CI+ to purchase a specific program.
</ul>
<p>The data types for the <b><i>send_msg</i></b> message are listed in the following table.</p>
<table class="simple" id="send_msg-message-data-types">
<caption>Table ####: <i>send_msg</i> message data types</caption>
<tr><th>Syntax</th><th>Occurrence number</th></tr>
<tr><td>oipf_ca_vendor_specific_information</td><td>1</td></tr>
</table>
<table class="arguments-table">
<tr><td>oipf_ca_vendor_specific_information</td><td>Vendor specific information. The maximum length is 65000 bytes. </td></tr>
</table>
<p>When a DAE application calls the <a href="volume5.html#oipfdrmagent-senddrmmessage" class="apiRef">sendDRMMessage</a> API with msgType set to the MIME type "application/vnd.oipf.cspg hexbinary" and a DRMSystemId set to a ca system id supported by the CSPG-CI+, the OITF SHALL send a <b><i>send_msg</i></b> message to the CSPG-CI+.</p>
<p>The prototype of the <a href="volume5.html#oipfdrmagent-senddrmmessage" class="apiRef">sendDRMMessage</a> API defined in [[.OIPF_DAE2]] is recalled here:</p>
<pre>String sendDRMMessage( String msgType, String msg, String DRMSystemID )</pre>
<p>The OITF SHALL map the attributes of the called DAE API as follows:</p><ul>
<li>the DRMSystemId attribute is mapped to the ca_system_id field as described in section <a href="#mapping-messages-to-dae-api-or-events" class="sectionRef"></a>. 
<li>the private data in msg attribute encoded in a string using a hexadecimal representation, as defined for xs:hexBinary type used in XML schemas is decoded to bytes before passing it to <b><i>send_msg</i></b> message in the oipf_ca_vendor_specific_information field as described in section <a href="#mapping-messages-to-dae-api-or-events" class="sectionRef"></a>.</ul>

</section>
<section id="reply-msg"><h6>reply_msg</h6>
<p>The CSPG-CI+ SHALL send the reply_msg message to the OITF to provide the status of the <b><i>send_msg</i></b> message.</p>
<p>The data types for the <b><i>reply _msg</i></b> message are listed in the following table.</p>
<table class="simple" id="reply_msg-message-data-types">
<caption>Table ####: <i>reply_msg</i> message data types</caption>
<tr><th>Syntax</th><th>Occurrence number</th></tr>
<tr><td>oipf_status</td><td>1</td></tr>
<tr><td>oipf_ca_vendor_specific_information</td><td>0..1</td></tr>
</table>
<table class="arguments-table">
<tr><td>oipf_status</td><td>If equal to 0, the <b><i>send_msg</i></b> message has been successfully handled by the CSPG-CI+ and a oipf_ca_vendor_specific_information may be available.<br />
If equal to 1, the <b><i>send_msg</i></b> message failed because an unspecified error occurred.<br />
If equal to 2, the <b><i>send_msg</i></b> message failed because the CSPG-CI+ was unable to complete the necessary computations in the time allotted.<br />
If equal to 3, the <b><i>send_msg</i></b> message failed because oipf_ca_vendor_specific_information has a wrong format.<br />
If equal to 4, the <b><i>send_msg</i></b> message failed because user consent is needed for that action.<br />
If equal to 5, the <b><i>send_msg</i></b> message failed because the specified CA system in ca_system_id is unknown.<br />
Unspecified status values SHOULD be considered as 1, message failed because an unspecified error occurs.
</td></tr>
<tr><td>oipf_ca_vendor_specific_information</td><td>Vendor specific information. The maximum length is 65000 bytes. </td></tr>
</table>
<p>NOTE: A service provider should not provide a DRM Message in metadata (BCG, SD&amp;S, CAD) and expect a response in oipf_ca_vendor_specific_information of <b><i>reply_msg</i></b> message, if these metadata are handled by a native application. The native application sending the DRM message to the CSPG-CI+ will not know how to handle a response.</p>
<p>When receiving a <b><i>reply_msg</i></b> message with a transaction_id mapping to a send_msg message issued from a DAE application call to <a href="volume5.html#oipfdrmagent-senddrmmessage" class="apiRef">sendDRMMessage</a>, the OITF SHALL issue an <a href="volume5.html#oipfdrmagent-ondrmmessageresult" class="apiRef">onDRMMessageResult</a> event to the DAE application </p>
<p>The prototype of the <a href="volume5.html#oipfdrmagent-ondrmmessageresult" class="apiRef">onDRMMessageResult</a> event defined in [[.OIPF_DAE2]] is recalled here:</p>
<pre>function onDRMMessageResult( String msgID, String resultMsg, Integer resultCode )</pre>
<p>The OITF SHALL set the attributes of the issued DAE event as follows:</p><ul>
<li>the msgID attribute set to the value returned to the called <a href="volume5.html#oipfdrmagent-senddrmmessage" class="apiRef">sendDRMMessage</a>.
<li>the resultCode attribute is mapped to oipf_status field as follows:
<table class="simple">
<tr><th>oipf_status field</th><th>Description</th><th>resultCode attribute</th><th>Description</th></tr>
<tr><td>0</td><td>Successful</td><td>0</td><td>Successful</td></tr>
<tr><td>1</td><td>Unspecified error</td><td>1</td><td>Unknown error</td></tr>
<tr><td>2</td><td>Out of time</td><td>2</td><td>Cannot process request</td></tr>
<tr><td>3</td><td>Wrong format</td><td>3</td><td>Wrong format</td></tr>
<tr><td>4</td><td>User Consent Needed</td><td>4</td><td>User Consent Needed</td></tr>
<tr><td>5</td><td>Unknown DRM system</td><td>5</td><td>Unknown DRM system</td></tr>
</table>
<li>the resultMsg attribute set to the private data in oipf_ca_vendor_specific_information encoded in a string as described in section <a href="#mapping-messages-to-dae-api-or-events" class="sectionRef"></a>.
</ul>
</section>
<section id="parental-control-info"><h6>parental_control_info</h6>
<p>The CSPG-CI+ SHALL send a <b><i>parental_control_info</i></b> message to advise the OITF whenever the selected program’s rating changes. If the new rating does not meet the parental rating criterion (e.g. rating is at or above a certain threshold, for a rating system that is ordered from lower viewer age to higher viewer age), the program is not descrambled anymore . If the new rating meets the parental rating criterion (e.g. rating is under a certain threshold, for a rating system that is ordered from lower viewer age to higher viewer age), the program is descrambled again.</p>
<p>The data types for the <b><i>parental_control_info</i></b> message are listed in the following table.</p>
<table class="simple" id="parental_control_info-message-data-types">
<caption>Table ####: <i>parental_control_info</i> message data types</caption>
<tr><th>Syntax</th><th>Occurrence number</th></tr>
<tr><td>oipf_access_status</td><td>1</td></tr>
<tr><td>oipf_rating_type</td><td>1</td></tr>
<tr><td>oipf_rating_value</td><td>1</td></tr>
<tr><td>oipf_country_code</td><td>0..n</td></tr>
<tr><td>oipf_parental_control_url</td><td>0..1</td></tr>
</table>
<table class="arguments-table">
<tr><td>oipf_access_status</td><td>If equal to 0, the program is no longer being descrambled, access conditions to the program are no longer being met. A oipf_parental_control_url may be provided.<br />If equal to 1, the program is descrambled again.
</td></tr>
<tr><td>oipf_rating_type</td><td>Rating_type as defined in the parental_rating access_criteria_descriptor in [[!IEC62455]].</td></tr>
<tr><td>oipf_rating_value</td><td>1-byte rating_value as defined in the parental_rating access_criteria_descriptor in [[!IEC62455]].</td></tr>
<tr><td>oipf_country_code</td><td>2-byte optional country_codes as defined in the parental_rating access_criteria_descriptor in [[!IEC62455]].</td></tr>
<tr><td>oipf_parental_control_url</td><td>Optional url for connecting to the service provider, for unlocking the parental control.</td></tr>
</table>
<p>The OITF SHALL support at least the parental rating system identified by the oipf_rating_type 0, which maps to the parental rating system in DVB Systems [[!DVBSI]].</p>
<p>If an oipf_parental_control_url is provided and the event is raised to a native application, the native application SHOULD launch the DAE with the oipf_parental_control_url that might allow to unlock parental control in the CSPG-CI+.</p>
<p>When the parental_control_info message is received and a DAE application is launched, the OITF SHALL issue the relevant event to the DAE application:</p><ul>
<li>onParentalRatingChange event, if the parental rating system specified by the oipf_rating_type is supported by the OITF. 
<li>onParentalRatingError event, if the parental rating system specified by the oipf_rating_type is not supported by the OITF. 
</ul>
<p>The prototype of the onParentalRatingChange and onParentalRatingError events defined in [[.OIPF_DAE2]] are  recalled here:</p><pre>
function onParentalRatingChange( String contentID, ParentalRatingCollection ratings, String DRMSystemID, Boolean blocked )
function onParentalRatingError( String contentID, ParentalRatingCollection ratings, String DRMSystemID )
</pre>
<p>The OITF SHALL set the attributes of the issued event as follows:</p><ul>
<li>the contentId attribute is set to null or undefined.
<li>the ratings attribute (<a href="volume5.html#parentalratingcollection-class" class="apiRef">ParentalRatingCollection</a> object) is filled out with a single <a href="volume5.html#parentalrating-class" class="apiRef">ParentalRating</a> object. This <a href="volume5.html#parentalrating-class" class="apiRef">ParentalRating</a> object is initialized as follows:<ul>
<li>If the oipf_rating_type is supported by the OITF, the oipf_rating_type field is mapped into the <a href="volume5.html#parentalrating-scheme" class="apiRef">scheme</a> property of the <a href="volume5.html#parentalrating-class" class="apiRef">ParentalRating</a> object. If the oipf_rating_type is not supported by the OITF, the <a href="volume5.html#parentalrating-scheme" class="apiRef">scheme</a> is set to null or undefined.
<li>The oipf_rating_value field is mapped into the <a href="volume5.html#parentalrating-value" class="apiRef">value</a> property of the <a href="volume5.html#parentalrating-class" class="apiRef">ParentalRating</a> object. If the oipf_rating_type is supported by the OITF, the <a href="volume5.html#parentalrating-name" class="apiRef">name</a> property of the <a href="volume5.html#parentalrating-class" class="apiRef">ParentalRating</a> object is filled with the string representation of the parental rating value. If the oipf_rating_type is not supported by the OITF, the <a href="volume5.html#parentalrating-name" class="apiRef">name</a> property is set to null or undefined.
<li>The oipf_country_code field is mapped into the <a href="volume5.html#parentalrating-ragion" class="apiRef">region</a> property of the <a href="volume5.html#parentalrating-class" class="apiRef">ParentalRating</a> object</ul>
<li>the DRMSystemID attribute is mapped to the ca_system_id field as defined in section <a href="#mapping-messages-to-dae-api-or-events" class="sectionRef"></a>.
<li>The blocked attribute is mapped to oipf_access_status as follows
<table class="simple">
<tr><th>oipf_access_status field</th><th>Description</th><th>Blocked attribute</th><th>Description</th></tr>
<tr><td>0</td><td>program not descrambled</td><td>True</td><td>Content blocked</td></tr>
<tr><td>1</td><td>Program descrambled</td><td>False</td><td>Content not blocked</td></tr>
</table>
</ul>
<p>A DAE application SHOULD use a proprietary method using <a href="volume5.html#oipfdrmagent-senddrmmessage" class="apiRef">sendDRMMessage</a> to unlock parental control.</p>
<p>If the program is no longer being descrambled (oipf_access_status=0), the native or DAE application SHOULD not stop playing the program, as the program may become descrambled again later (access criteria change, parental unlocking etc).</p>
</section>
<section id="rights-info"><h6>rights_info</h6>
<p>The CSPG-CI+ SHALL send a <b><i>rights_info</i></b> message to advise the OITF that access conditions or rights changed and that the CSPG-CI+ is no longer able or is able again to descramble all requested elementary streams. Once this message is received and if a DAE application is launched, the OIPF SHALL send the relevant event onDRMRightsError, as defined in [[.OIPF_DAE2]] sections <a href="volume5.html#video-broadcast-extensions-drm-errors" class="extRef">7.13.6</a> and <a href="volume5.html#av-control-extensions-for-drm-rights-errors" class="extRef">7.14.6</a>, to the DAE application.</p>
<p>If the program is descrambled again, the OITF SHOULD display the program again. If the program is no longer being descrambled, the OITF MAY decide to stop the program and SHOULD use the oipf_rights_issuer_url, which may provide for the CSPG-CI+ information to let it retrieve missing rights.</p>
<p>The data types for the <b><i>rights_info</i></b> message are listed in the following table.</p>
<table class="simple" id="rights_info-message-data-types">
<caption>Table ####: <i>rights_info</i> message data types</caption>
<tr><th>Syntax</th><th>Occurrence number</th></tr>
<tr><td>oipf_access_status</td><td>1</td></tr>
<tr><td>oipf_rights_issuer_url</td><td>0..1</td></tr>
</table>
<table class="arguments-table">
<tr><td>oipf_access_status</td><td>If equal to 0, the program is no longer being descrambled, access conditions to the program are no longer being met. A oipf_rights_issuer_url may be provided.<br />If equal to 1, the program is descrambled again.</td></tr>
<tr><td>oipf_rights_issuer_url</td><td>Optional url for connecting to the service provider.</td></tr>
</table>
<p>The prototype of the onDRMRightsError event defined in [[.OIPF_DAE2]] is recalled here:</p>
<pre>function onDRMRightsError( Integer errorState, String contentID, String DRMSystemID, String rightsIssuerURL )</pre>

<p>When the <i>right_info</i> message is received and a DAE application is launched, the OITF SHALL issue the <i>onDRMRightsError</i> event to the DAE application.</p>
<p>The OITF SHALL set the attributes of the issued event as follows:</p><ul>
<li>The errorState attribute is mapped to oipf_access_status field as follows:
<table class="simple">
<tr><th>oipf_access_status field</th><th>Description</th><th>errorState attribute</th><th>Description</th></tr>
<tr><td>0</td><td>program not descrambled</td><td>0</td><td>No license</td></tr>
<tr><td>1</td><td>Program descrambled</td><td>2</td><td>Valid license</td></tr>
</table>
<li>The contentId attribute is set to null or undefined.
<li>The DRMSystemID attribute is mapped to the ca_system_id field as defined in section <a href="#mapping-messages-to-dae-api-or-events" class="sectionRef"></a>.
<li>The rightsIssuerURL is mapped to oipf_rights_issuer_url if this field is present. If the oipf_rights_issuer_url is not present, rightIssuerURL is set to null or undefined.
</ul>
<p>If the program is no longer being descrambled (oipf_access_status=0), the native or DAE application SHOULD not stop playing the program, as the program may become descrambled again later (access criteria change, rights update etc).</p>
</section>
<section id="system-info"><h6>system_info</h6>
<p>The CSPG-CI+ SHALL send a system_info message to advise the OITF of any DRM related event, e.g. the removal of a smartcard. Once this message is received and if a DAE application is launched, the OIPF SHALL send the relevant event <a href="volume5.html#oipfdrmagent-ondrmsystemmessage" class="apiRef">onDRMSystemMessage</a>, as defined in [[.OIPF_DAE2]] <a href="volume5.html#application-oipfdrmagent" class="extRef">section 7.6.1</a>, to the DAE application.</p>
<p>The data types for the system_info message are listed in the following table.</p>
<table class="simple" id="system_info-message-data-types">
<caption>Table ####: <i>system_info</i> message data types</caption>
<tr><th>Syntax</th><th>Occurrence number</th></tr>
<tr><td>oipf_ca_vendor_specific_information</td><td>1</td></tr>
</table>
<table class="arguments-table">
<tr><td>oipf_ca_vendor_specific_information</td><td>Vendor specific information. The maximum length is 65000 bytes.</td></tr>
</table>
<p>When the <i>system_info</i> message is received and if a DAE application is launched, the OITF SHALL issue the <i><a href="volume5.html#oipfdrmagent-ondrmsystemmessage" class="apiRef">onDRMSystemMessage</a></i> event to the DAE application.</p>
<p>The prototype of the <a href="volume5.html#oipfdrmagent-ondrmsystemmessage" class="apiRef">onDRMSystemMessage</a> event defined in [[.OIPF_DAE2]] is recalled here:</p>
<pre>function onDRMSystemMessage( String DRMSystemID, String msg )</pre>

<p>The OITF SHALL set the attributes of the issued event as follows:</p><ul>
<li>The DRMSystemID attribute is mapped to the ca_system_id field as defined in section <a href="#mapping-messages-to-dae-api-or-events" class="sectionRef"></a>.
<li>The msg attribute set to the private data in oipf_ca_vendor_specific_information encoded in a string as described in section <a href="#mapping-messages-to-dae-api-or-events" class="sectionRef"></a>.
</ul>
</section>
<section id="can-play"><h6>can_play_content_req and can_play_content_reply</h6>
<p>Note: The following messages are only supported for a private_host_application_ID greater or equal to 0x0108113101190001.</p>
<p>When requested by either a native or DAE application, the OITF SHALL send the <b><i>can_play_content_req</i></b> message to the CSPG-CI+ to check the local availability of a valid license for playing a content protected by a DRM integrated in the CSPG-CI+.</p>
<p>The data types for the <b><i>can_play_content_req</i></b> message are listed in the following table.</p>
<table class="simple" id="can_play_content_req-message-data-types">
<caption>Table ####: <i>can_play_content_req</i> message data types</caption>
<tr><th>Syntax</th><th>Occurrence number</th></tr>
<tr><td>oipf_drm_private_data</td><td>1</td></tr>
</table>
<table class="arguments-table">
<tr><td>oipf_drm_private_data</td><td>DRM proprietary private data. The maximum length is 16384 bytes.</td></tr>
</table>
<p>When a DAE application calls the <a href="volume5.html#oipfdrmagent-canplaycontent" class="apiRef">canPlayContent</a> API with a DRMSystemId set to a ca system id supported by the CSPG-CI+, the OITF SHALL send a <b><i>can_play_content_req</i></b> message to the CSPG-CI+ and wait for a <b><i>can_play_content_reply</i></b> message from the CSPG-CI+.</p>
<p>The data types for the <b><i>can_play_content_reply</i></b> message are listed in the following table.</p>
<table class="simple" id="can_play_content_reply-message-data-types">
<caption>Table ####: <i>can_play_content_reply</i> message data types</caption>
<tr><th>Syntax</th><th>Occurrence number</th></tr>
<tr><td>oipf_can_play_status</td><td>1</td></tr>
</table>
<table class="arguments-table">
<tr><td>oipf_can_play_status</td><td>If equal to 1, the CSPG_CI+ has a valid license available that may allow playing the content associated to the DRM metadata. If equal to 0, the CSPG-CI+ has no license available.</td></tr>
</table>
<p>When the CSPG-CI+ receives a <b><i>can_play_content_req</i></b> message, then it shall check whether it owns a valid license for playing the protected content which oipf_drm_private_data relates to and reply to the OITF with a <b><i>can_play_content_reply</i></b> message with an oipf_can_play_status that indicates whether or not the CSPG-CI+ has a valid license available.</p>
<p>The prototype of the <a href="volume5.html#oipfdrmagent-canplaycontent" class="apiRef">canPlayContent</a> API defined in [[.OIPF_DAE2]] is recalled here:</p>
<pre>Boolean canPlayContent( String DRMPrivateData, String DRMSystemID )</pre>

<p>The OITF SHALL map the attributes of the called DAE API as follows:</p><ul>
<li>the DRMSystemId attribute is mapped to the ca_system_id field as described in section <a href="#mapping-messages-to-dae-api-or-events" class="sectionRef"></a>.
<li>the DRMPrivateData is mapped to oipf_drm_private_data.
<li>the returned Boolean is mapped from the oipf_can_play_status.
</ul>
</section>
<section id="can-record"><h6>can_record_content_req and can_record_content_reply</h6>
<p>Note: The following messages are only supported for a private_host_application_ID greater or equal to 0x0108113101190001.</p>
<p>When requested by either a native or DAE application, the OITF SHALL send the <b><i>can_record_content_req</i></b> message to the CSPG-CI+ to check the local availability of a valid license for recording a content protected by a DRM integrated in the CSPG-CI+.</p>
<p>The data types for the <b><i>can_record_content_req</i></b> message are listed in the following table.</p>
<table class="simple" id="can_record_content_req-message-data-types">
<caption>Table ####: <i>can_record_content_req</i> message data types</caption>
<tr><th>Syntax</th><th>Occurrence number</th></tr>
<tr><td>oipf_drm_private_data</td><td>1</td></tr>
</table>
<table class="arguments-table">
<tr><td>oipf_drm_private_data</td><td>DRM proprietary private data. The maximum length is 16384 bytes.</td></tr>
</table>
<p>When a DAE application calls the <a href="volume5.html#oipfdrmagent-canrecordcontent" class="apiRef">canRecordContent</a> API with a DRMSystemId set to a ca system id supported by the CSPG-CI+, the OITF SHALL send a <b><i>can_record_content_req</i></b> message to the CSPG-CI+ and wait for a <b><i>can_record_content_reply</i></b> message from the CSPG-CI+.</p>
<p>The data types for the <b><i>can_record_content_reply</i></b> message are listed in the following table.</p>
<table class="simple" id="can_record_content_reply-message-data-types">
<caption>Table ####: <i>can_record_content_reply</i> message data types</caption>
<tr><th>Syntax</th><th>Occurrence number</th></tr>
<tr><td>oipf_can_record_status</td><td>1</td></tr>
</table>
<table class="arguments-table">
<tr><td>oipf_can_record_status</td><td>If equal to 1, the CSPG_CI+ has a valid license available that may allow recording the content associated to the DRM metadata. If equal to 0, the CSPG-CI+ has no license available.</td></tr>
</table>
<p>When the CSPG-CI+ receives a <b><i>can_record_content_req</i></b> message, then it shall check whether it owns a valid license for recording the protected content which oipf_drm_private_data relates to and reply to the OITF with a <b><i>can_record_content_reply</i></b> message with an oipf_can_record_status that indicates whether or not the CSPG-CI+ has a valid license available.</p>
<p>The prototype of the <a href="volume5.html#oipfdrmagent-canrecordcontent" class="apiRef">canRecordContent</a> API defined in [[.OIPF_DAE2]] is recalled here:</p>
<pre>Boolean canRecordContent( String DRMPrivateData, String DRMSystemID )</pre>

<p>The OITF SHALL map the attributes of the called DAE API as follows:</p><ul>
<li>the DRMSystemId attribute is mapped to the ca_system_id field as described in section <a href="#mapping-messages-to-dae-api-or-events" class="sectionRef"></a>.
<li>the DRMPrivateData is mapped to oipf_drm_private_data.
<li>the returned Boolean is mapped from the oipf_can_record_status.
</ul>
</section>
</section>
<section id="media-channel"><h6>Media Channel</h6>
<p>Media are exchanged as defined in the [[!CI+]] specification.</p>
<p>For streamed content, in either Scheduled Content case or Content on Demand case, the transmission of the protected content from the OITF to the CSPG-CI+ is performed by using MPEG-2 Transport Stream.</p>
<p>For downloaded content, the OITF SHALL stream the content to the CSPG-CI+ at consumption time.</p>
</section>

</section>
<section><h5>UNIS-CSP-G</h5></section>
<section><h5>HNI-AGC</h5>
<p>In case there is an Application Gateway, control flow is handled through the OITF, via HNI-INI-AG and HNI-CSP control channel. The HNI-AGC reference point introduced in [[.OIPF_ARCH2]] is not used.</p>
</section>

</section>
<section><h4>Provider Network Interfaces</h4>
<p>The scrambler on network side SHALL have an interface with the CSP-G Server functional entity so that ECMs can be provided during content encryption. This interface is not described in the present specification.</p>
</section>
<section><h4>Protected Streaming and File Formats</h4>
<p>The CSPG-CI+ supports the MPEG-2 Transport Stream format. The CSPG-CI+ supports the MPEG-2 Transport Stream format. The generically protected incoming transport stream to the CSPG-CI+ is associated with the media format label “PF”, as defined in [[.OIPF_MEDIA2]].</p>
<p>The CSPG-CI+ does not support the time stamped MPEG-2 Transport Stream format.</p>
<p>However, in the case content is received by the OITF under a time stamped MPEG-2 Transport Stream format and if the OITF supports the unprotected time stamped MPEG-2 TS format,</p><ul>
<li>the OITF MAY first use the timestamps provided through the 4 additional bytes of each time stamped MPEG-2 TS (as defined in [[.OIPF_MEDIA2]]) packet to eliminate network jitter and restore the original packet arrival times before sending the content to the CSPG-CI+,
<li>and the OITF SHALL remove the 4 additional bytes from each time stamped MPEG-2 TS (as defined in [[.OIPF_MEDIA2]]) packet before sending the content to the CSPG-CI+.
</ul>
<p>If the OITF does not support the unprotected time stamped MPEG-2 TS format, the support of the above two operations is OPTIONAL.</p>

<section id="ciplus-protection-of-mpeg2"><h5>Protection of MPEG-2 Transport Streams</h5>
<p>MPEG-2 Transport Stream can be streamed or downloaded. Based on the CA_descriptor found in the PMT table, the OITF knows if it can handle the stream or if it has to send it to the CSPG-CI+.</p>
<p>If the CA_descriptor found in the PMT is a Marlin CA_descriptor (with CA_system_ID value assigned for Marlin) and the Terminal-Centric Approach is supported by the OITF, then the OITF SHALL manage the content with CSP function described in section <a href="#tca" class="sectionRef"></a>.</p>
<p>If the CA_descriptor found in the PMT is a Marlin CA_descriptor and the Terminal-Centric Approach is not supported by the OITF, then the OITF SHALL ignore it unless Marlin is supported by a CSPG-CI+ in which case the OITF SHALL provide the protected content to the relevant CSPG-CI+.</p>
<p>If the CA_descriptor found in the PMT is not a Marlin CA_descriptor, then the OITF SHALL compare the CA_system_ID value with the CA_system_ID supported by the CSPG-CI+. A CSPG-CI+ might support more than one CA_system_ID. If a CA_system_ID value matches then the OITF SHALL provide the protected content to the CSPG-CI+. In case several CSPG-CI+ gateways are connected to the OITF, the OITF SHALL provide the protected content to only one CSPG-CI+.</p>
<p>If there are several CA_descriptors in the PMT, i.e. referring to different content protection systems (Marlin and/or those offered by the CSPG-CI+ gateways), and if the user is already granted with a valid right or license through one of these content protection systems, the OITF SHALL select the corresponding content protection system as a priority.</p>
<p>NOTE: If simulcrypting with the Terminal-Centric solution is desired, the algorithm used for content encryption in the Gateway-Centric Approach has to be the same as for the Terminal-Centric Approach.</p>
<p>The scrambling algorithm SHALL be signalled in the PMT at program loop level by the scrambling_descriptor specified in [[!DVBSI]]. Within the scrambling_descriptor, the algorithm is specified by the scrambling_mode field. The following scrambling_modes are referenced by the Open IPTV Forum:</p>
<table class="simple" id="scrambling-modes">
<caption>Table ####: Scrambling Modes</caption>
<tr><th>scrambling_mode</th><th>Description</th></tr>
<tr><td>0x01</td><td>DVB-CSA1</td></tr>
<tr><td>0x02</td><td>DVB-CSA2</td></tr>
<tr><td>0x70</td><td>AES 128-bit key using the Cipher Block Chaining (CBC) encryption mode with the IV setting and the residual termination block process as specified in [[!ATIS-IDSA]].</td></tr>
</table>

</section>
<section><h5>Downloaded Content Usage</h5>
<p>Downloaded content SHALL be stored locally as it is received by the OITF not going through the CSPG-CI+.</p>
<p>Downloaded content SHALL be provided to the CSPG-CI+ at consumption time only. Consequently, any conversion from e.g. time stamped MPEG-2 TS as defined in [[.OIPF_MEDIA2]] to TS is performed at consumption time as well.</p>
</section>
</section>
<section><h4>Personal Video Recorder</h4>
<p>PVR functionality is supported by using URI (Usage Rule Information) as defined in [[!CI+]], section 5.7.</p>
<p>When the OITF is asked to store content, it SHALL send the content to CSPG CI+. The content is returned from CSPG-CI+ and recorded in accordance with the URI associated with the content.</p>
</section>
<section><h4>Time Shifting</h4>
<p>Time Shifting functionality is supported by using URI (Usage Rule Information) as defined in [[!CI+]], section 5.7.</p>
<p>When the OITF is asked to time shift content, it SHALL store the content returned from CSPG-CI+ before rendering in accordance with the URI associated to the content.</p>
</section>
<section><h4>CI+ Specification Usage</h4>
<section><h5>Module Deployment</h5>
<p>As the network offered in the Open IPTV Forum context is a bi-directional communication channel, the optional Registered Service Mode (RSM) in the CI+ specification [[!CI+]] is recommended in the CSP specification. The RSM SHOULD be supported by CSPG-CI+.</p>
</section>
<section><h5>Host Service Shunning</h5>
<p>As no DVB-CI backward compatibility is needed, the OITF SHALL make the CSPG-CI+ operate in a CI+ mode [[!CI+]] only (thus preventing CSPG-CI+ gateways from operating with the unencrypted DVB-CI link). CI+ Protected Service Signalling defined in section 10.1 of [[!CI+]] is not used.</p>
</section>
</section>
<section id="ciplusgw-drm-data"><h4>DRM Data</h4>
<section id="ciplusgw-drmsystemid"><h5>DRMSystemID</h5>
<p>DRMSystemID, used to signal the type of DRM, is defined in [[.OIPF_META2]]. DRMSystemID is used in metadata structures in APIs defined in [[.OIPF_DAE2]] and in protocols defined in [[.OIPF_PROT2]]. For CSPG-CI+, the DVB CA_System_ID in DRMSystemID SHALL be the one of the specific content protection solution in the CSPG-CI+.</p>
</section>
<section id="ciplusgw-metadata-drm-control-information"><h5>Metadata – DRM Control Information</h5>
<p>A DRM Control Information structure to hold DRM dependant control parameters is defined in [[.OIPF_META2]] as an extended element included in Content Access Descriptor, defined in [[.OIPF_DAE2]] and extension of PurchaseItem element of BCG and SD&amp;S metadata, defined in [[.OIPF_META2]].</p>
<p>For specifically protected content, the element of DRMControlInformation SHALL be mapped as specified in the following table:</p>
<table class="simple" id="drmcontrolinformation-mapping-for-cspg-ciplus">
<caption>Table ####: DRMControlInformation Mapping for CSPG-CI+</caption>
<tr><th>Element / Attribute Name</th><th>Element / Attribute Mapping for CSPG-CI+</th></tr>
<tr><td colspan="2">DRMControlInformation</td></tr>
<tr><td>DRMSystemID</td><td>SHALL be set to the value defined for the specific protection system in the CSPG-CI+, in section <a href="#ciplusgw-drmsystemid" class="sectionRef"></a></td></tr>
<tr><td>DRMContentID</td><td>Vendor specific information.</td></tr>
<tr><td>RightsIssuerURL</td><td>SHOULD be set to the RightsIssuerURL which is provided in the <b><i>rights_info</i></b> message defined in section <a href="#rights-info" class="sectionRef"></a>.</td></tr>
<tr><td>SilentRightsURL</td><td>MAY be set to an URL allowing retrieval of a message to be forwarded to the CSPG-CI+ in order to silently get updated rights. The MIME type or the HTTP response SHALL be "application/vnd.oipf.cspg-hexbinary" and the body of the HTTP response SHALL be an hexadecimal string as described in section <a href="#mapping-messages-to-dae-api-or-events" class="sectionRef"></a>.</td></tr>
<tr><td>PreviewRightsURL</td><td>MAY be set to an URL allowing retrieval of a message to be forwarded to the CSPG-CI+ in order to get preview rights. The MIME type or the HTTP response SHALL be "application/vnd.oipf.cspg-hexbinary" and the body of the HTTP response SHALL be a hexadecimal string as described in section <a href="#mapping-messages-to-dae-api-or-events" class="sectionRef"></a>.</td></tr>
<tr><td>DoNotRecord</td><td>Vendor specific mapping</td></tr>
<tr><td>DoNotTimeShift</td><td>Vendor specific mapping</td></tr>
<tr><td>DRMPrivateData</td><td>DRMPrivateData structure SHALL be substituted by the HexBinaryPrivateData structure.</td></tr>
<tr><td>mimeType</td><td>SHALL be set to the mime type of the DRMPrivateData. For CSPG-CI+, it SHALL therefore be set to the following MIME type: "application/vnd.oipf.cspg-hexbinary"</td></tr>
</table>
<p>Both MarlinPrivateDataType and HexBinaryPrivateDataType extend DRMPrivateDataType which is defined in [[.OIPF_META2]], and so the element DRMPrivateData can be substituted by either MarlinPrivateData or HexBinaryPrivateData as described in DRMControlInformation outline in Figure <a href="#outline-of-drmcontrolinformationtype-with-marlinprivatedata" class="figureRef"></a>.</p>
<p>The XML schema for HexBinaryPrivateData is defined in section <a href="#hexbinaryprivatedatatype-schema" class="sectionRef"></a>.</p>
<table class="simple" id="hexbinaryprivatedata-structure">
<caption>Table ####: HexBinaryPrivateData Structure</caption>
<tr><th>Element / Attribute Name</th><th>Element / Attribute Mapping for CSPG-CI+</th></tr>
<tr><td colspan="2">HexBinaryPrivateData</td></tr>
<tr><td>Message</td><td>A hexadecimal encoded sequence of bytes to be sent to the CSPG-CI+ using <b><i>send_msg</i></b> message</td></tr>
</table>
</section>
</section>
</section>
<section id="dtcp-ip-based-gateway"><h3>DTCP-IP based Gateway</h3>
<p>All normative statements in this section and its sub-sections apply only in case the DTCP-IP based Gateway-Centric Approach is supported.
NOTE: The criteria that determine under which circumstances the DTCP-IP based Gateway-Centric Approach is implemented are out of the scope of the present document.</p>
<section id="dtcp-ip-gateway-overview"><h4>Overview</h4>
<p>The CSP Gateway based on DTCP-IP (CSPG-DTCP) is an optional entity handling security for the OITF. The CSPG DTCP resides in the residential network and makes any specific content protection solution transparent. This is achieved by transforming a service proprietary content protection format into standard protection formats which are sent by a secure channel. OITF and CSPG-DTCP mutually authenticate each other, and CSPG-DTCP transfers content and its usage rule information to OITF in a secure manner. The definition of this interface is based on DTCP ([[!DTCP]]) and DTCP over IP ([[!DTCP-IP]]).</p><ul>
<li>Browsing interactions are executed between DAE and IPTV Applications.
<li>OITF discovers CSPG-DTCP in a home IP network by the use of the UPnP device discovery protocol as specified in [[.OIPF_PROT2]], <a href="volume4.html#s10-1-1-3" class="extRef">section 10.1.1.3</a>.
<li>For managed network relying on IMS, CSPG-DTCP is co-located with IG to share session management information between IG and CSPG-DTCP. If it supports multicast IPTV services, it is co-located with WAN Gateway to intercept IGMP messages from OITF.
<li>CSPG-DTCP acts as an HTTP proxy or RTSP proxy. CSPG-DTCP identifies the location of the content through an input URL from OITF.
<li>CSPG-DTCP transforms service specific content protection formats and usage information format to DTCP over IP content protection format and usage information format respectively.
</ul>
<figure id="cspg-dtcp-overview-figure">
<img alt="FIGURE 16" src="images/CSPG-DTCP-Overview.png" />
<figcaption>Figure ####: CSPG-DTCP Overview</figcaption>
</figure>
<figure id="cspg-dtcp-interfaces-figure">
<img alt="FIGURE 17" src="images/CSPG-DTCP-Interfaces.png" />
<p>NOTE: HNI-AGC and HNI-AGI are not involved for the CSPG-DTCP.</p>
<figcaption>Figure ####: Overview of Involved Reference Points</figcaption>
</figure>
</section>
<section id="cspg-dtcp-connectivity"><h4>CSPG-DTCP Connectivity</h4>
<p>The CSPG-DTCP is an IP connected device, and uses the same physical interface used for other IP devices such as IG, AG or home router.</p>
</section>
<section id="hni-csp"><h4>HNI-CSP</h4>
<p>The main functionalities of the HNI-CSP are to provide:</p><ul>
<li>CSPG-DTCP discovery as described in [[.OIPF_PROT2]]),
<li>Content access through CSPG-DTCP,
<li>DTCP AKE, content stream and usage rule transmission
</ul>
<section><h5>Content Access Through CSPG-DTCP</h5>
<p>When an OITF determines, e.g. by inspecting the information in the DRMType element, see [[.OIPF_META2]], of the content guide, content access descriptor or SD&amp;S, that the content is protected by a service specific protection scheme, it SHALL access the content through the CSPG-DTCP, which acts as an HTTP proxy or RTSP proxy. CSPG-DTCP receives content and SHALL transform the protection scheme to DTCP-IP. When OITF receives error code of 403 from CSPG-DTCP, the error code is interpreted as DRM rights error. Then a DAE application accesses the error handling web page as an action of onDRMRightsError event defined in [[.OIPF_DAE2]], or a native application accesses the RightsIssuerURL described in BCG or SD&amp;S metadata [[.OIPF_META2]].</p>
<p>Refer to Annex <a href="#cspg-dtcp-session-setup-sequence-examples" class="sectionRef">E</a> for examples of session setup sequences with a CSPG-DTCP.</p>
<p>For HTTP streaming and download, the OITF SHALL send HTTP GET request through the HTTP proxy in CSPG-DTCP. Note that other HTTP transactions SHALL not use the HTTP proxy in CSPG-DTCP.</p>
</section>
<section><h5>DTCP AKE, Content Streaming and Usage Rule Transmission</h5>
<p>DTCP AKE (Authentication and Key Exchange), DTCP content stream and DTCP usage rule are defined in [[!DTCP]] and [[!DTCP-IP]]. The usage rule is provided to the OITF from the CSPG-DTCP considering appropriate mapping, which depends on the service provider’s business models. Content type of HTTP response/request SHALL be set to DTCP application media type as defined by [[!DTCP-IP]].</p>
</section>
</section>
<section><h4>UNIS-CSP-G</h4>
<p>This interface is out of scope because of applied service specific protection scheme.</p>
</section>
<section><h4>Protected Streaming and File Formats</h4>
<p>The CSPG-DTCP supports either or both of the following formats protected by DTCP-IP encryption on HNI-CSP. The supported format depends on the CA system supported by the CSPG-DTCP.  Media format on UNIS-CSP-G is out of scope of this specification.</p><ul>
<li>MPEG-2 TS and/or time stamped MPEG-2 TS
<li>MP4 File Format
</ul>
<p>If the OITF supports the unprotected MPEG-2 TS, the OITF SHALL support the DTCP-IP protected MPEG-2 TS format, as defined in this section and its sub-sections. Otherwise, the support of the DTCP-IP protected MPEG-2 TS format as defined in this section and its sub-sections is OPTIONAL.</p>
<p>If the OITF supports the unprotected time stamped MPEG-2 TS format, the OITF SHALL support the DTCP-IP protected time stamped MPEG-2 TS format, as defined in this section and its sub-sections. Otherwise, the support of the DTCP-IP protected time stamped MPEG-2 TS format as defined in this section and its sub-sections is OPTIONAL.</p>
<p>If the OITF supports the unprotected MP4 file format, the OITF SHALL support the DTCP-IP protected MP4 file format, as defined in this section and its sub-sections. Otherwise, the support of the DTCP-IP protected MP4 file format as defined in this section and its sub-sections is OPTIONAL.</p>
<section id="dtcpip-protection-of-mpeg2-transport-streams"><h5>Protection of MPEG-2 Transport Streams</h5>
<p>An MPEG-2 Transport Stream can be streamed or downloaded through CSPG-DTCP. CSPG-DTCP SHALL transmit the content in the DTCP PCP format. The DTCP PCP format encapsulates the MPEG-2 Transport Stream format, which is defined by [[.OIPF_MEDIA2]]. For the avoidance of doubt, Transport Stream level scrambling or PES level scrambling are not used. Both transport_scrambling_control bits and pes_scrambling control bits SHALL be set “00”.</p>
<p>For content with parental rating control, CSPG-DTCP SHALL transmit MPEG-2 Transport Stream with CA descriptor and KSM table as specified in <a href="#ca_descriptor" class="sectionRef">----</a> and <a href="#key-stream-message-and-ksm-table" class="sectionRef">4.2.4.5.1.2</a>. The access_criteria_descriptor carries information for parental rating control.</p>
<p>If the OITF supports the DTCP-IP based Gateway-Centric Approach, the OITF SHALL support the parental rating access_criteria_descriptor, specified in [[!IEC62455]], and SHALL support at least the rating_type 0 within these criteria, which maps to the parental rating system in DVB Systems [[!DVBSI]]. Other descriptors in the key stream message SHOULD be ignored.</p>
<p>For the parental rating control, the OITF SHALL compare the program's rating from the parental rating access_criteria_descriptor with the current parental rating criterion set in the OITF by the application (either native application or DAE) and SHALL block the consumption of the programme if the parental rating system is supported by the OITF and the programme’s rating does not meet the parental rating criterion (e.g. rating is at or above a certain threshold, for a rating system that is ordered from lower viewer age to higher viewer age). The OITF SHALL raise an event to the application controlling the playback or other operation whenever a parental rating for the A/V content is detected that does not meet the parental rating criterion that is set for the parental system in use, and which has lead to blocking of the consumption of the content. The event SHALL provide the programme's rating. In case the application is a DAE application, the event is called onParentalRatingChange and is defined in sections <a href="volume5.html#video-broadcast-extensions-drm-errors" class="extRef">7.13.6</a> and <a href="volume5.html#av-control-extensions-for-drm-rights-errors" class="extRef">7.14.6</a> of [[.OIPF_DAE2]].</p>
<p>If the OITF does not support the particular parental rating system used in the programme, the OITF SHALL raise an event to the application controlling the playback or other operation. The event SHALL provide the programme's rating. In case the application is a DAE application, the event is called onParentalRatingError and is defined in sections <a href="volume5.html#video-broadcast-extensions-drm-errors" class="extRef">7.13.6</a> and <a href="volume5.html#av-control-extensions-for-drm-rights-errors" class="extRef">7.14.6</a> of [[.OIPF_DAE2]]. The event MAY be managed via the DAE application (see <a href="volume5.html#parental-access-control" class="extRef">section 4.5</a> of [[.OIPF_DAE2]] for more information). In case the application is a native application, the event is managed through an OITF vendor dependent user interface. In both cases, consumption MAY be unblocked by setting a new parental rating threshold, the setting of which is usually restricted to privileged users, e.g. parents. A successful PIN input by a user MAY be used to control the parental rating threshold setting. The OITF SHOULD continue monitoring the MPEG-2 TS, taking into account parental rating criteria changes in ECM streams or new settings for the parental rating threshold in the OITF, and SHALL unblock consumption if the current program's rating becomes lower than the current parental rating threshold.</p>
<section><h6>CA_descriptor</h6>
<p>Content with parental rating control SHALL include the CA descriptor in PMT with the following restrictions:</p>
<table class="syntax-table" id="ca-descriptor-syntax">
<tr><th>Syntax</th><th>No. of bits</th><th>Mnemonic</th><th>Value</th></tr>
<tr><td>CA_descriptor() {</td><td></td><td></td><td></td></tr>
<tr><td>&nbsp;&nbsp;descriptor_tag</td><td>8</td><td>uimsbf</td><td>9</td></tr>
<tr><td>&nbsp;&nbsp;descriptor_length</td><td>8</td><td>uimsbf</td><td></td></tr>
<tr><td>&nbsp;&nbsp;CA_system_ID</td><td>16</td><td>uimsbf</td><td>0x0007</td></tr>
<tr><td>&nbsp;&nbsp;MPEG2_Reserved</td><td>3</td><td>bslbf</td><td></td></tr>
<tr><td>&nbsp;&nbsp;CA_PID</td><td>13</td><td>uimsbf</td><td></td></tr>
<tr><td>&nbsp;&nbsp;for (i=0; i&lt;N; i++) {</td><td></td><td></td><td></td></tr>
<tr><td>&nbsp;&nbsp;&nbsp;&nbsp;private_data_byte</td><td>8</td><td>uimsbf</td><td></td></tr>
<tr><td>&nbsp;&nbsp;}</td><td></td><td></td><td></td></tr>
<tr><td>}</td><td></td><td></td><td></td></tr>
</table>

<table class="arguments-table">
<tr><td>descriptor_tag</td><td>MPEG has defined the tag value of 9 for the CA-descriptor.</td></tr>
<tr><td>descriptor_length</td><td>The length of the descriptor.</td></tr>
<tr><td>CA_system_ID</td><td>0x0007</td></tr>
<tr><td>CA_PID</td><td>The PID on which the KSM table can be found</td></tr>
<tr><td>MPEG2_reserved</td><td>Bits reserved by [[!MPEG2TS]].</td></tr>
<tr><td>private_data_byte</td><td>Not used and SHALL be ignored.</td></tr>
</table>
</section>
<section><h6>Key Stream Message and KSM Table</h6>
<p>Content with parental rating control SHALL include Key Stream Message in KSM table ([[!IEC62455]], [[!DVB-CA]]).</p>
<p>Key Stream Message is defined in section 7.2 of [[!IEC62455]] and the following usage restrictions SHALL be applied:</p><ul>
<li>access_criteria_flag is set to KSM_FLAG_TRUE for the content with parental rating control.
<li>traffic protection protocol is set to KSM_ALGO_MPEG2_TS_CRYPT.
<li>traffic_authentication_flag is set to KSM_FLAG_FALSE (traffic authentication is not used).
<li>next_traffic_key_flag is set to KSM_FLAG_FALSE.
<li>timestamp_flag is set to KSM_FLAG_FALSE.
<li>programme_flag is set to KSM_FLAG_FALSE.
<li>service_flag is set to KSM_FLAG_FALSE.
<li>content_key_index MAY be set to any value defined in [[!IEC62455]]. The OITF SHALL ignore this field.
<li>odd_even_flag MAY be set to any value defined in [[!IEC62455]]. The OITF SHALL ignore this field.
<li>cipher_mode MAY be set to any value defined in [[!IEC62455]]. The OITF SHALL ignore this field.
<li>encrypted_traffic_key_material_length is set to 0.
<li>traffic_key_lifetime is set to 0.
</ul>
<p>For content with parental rating control, the access_criteria_descriptor loop in the Key Stream Message SHALL have at least one parental_rating access_criteria_descriptor. The OITF SHALL ignore other access_criteria_descriptors.</p>
</section>
</section>
<section><h5>Protection of MP4 File Format</h5>
<p>MP4 file format can be downloaded through CSPG-DTCP. CSPG-DTCP SHALL transmit the content in DTCP PCP format which encapsulates MP4 file format which is defined by [[.OIPF_MEDIA2]].</p>
</section>
</section>
<section><h4>Downloaded Content Usage</h4>
<p>For downloaded content, content SHALL be transformed to DTCP-IP protection by CSPG-DTCP when content is being downloaded. Content SHALL be stored and played back by OITF in a manner compliant to DTCP compliance rules [[!DTCP-AA]].</p>
</section>
<section><h4>PVR Usage</h4>
<p>For PVR usage for scheduled content service, content SHALL be transformed to DTCP-IP protection by CSPG-DTCP when content is being streamed or multicast. Content SHALL be stored and played back by OITF in a manner compliant to DTCP compliance rules [[!DTCP-AA]].</p>
</section>
</section>
</section>
</section>

<section id="identification-authentication"><h1>User Identification, Authentication, Authorisation and Service Access Protection</h1>
<p>For the syntax of the messages mentioned in section <a href="#identification-authentication" class="sectionRef">5</a>, see Volume 4 [[.OIPF_PROT2]].</p>
<section><h2>General Principals</h2>
<p>This section presents the general principles that govern Service Access Protection and User authentication. In this section the <b>requested service</b> represents for example Service Provider Discovery (SPD), Service Discovery (SD), or IPTV Application.</p>
<p>This section also applies to services on the IG requested from the OITF over the HNI-IGI. In this case the equivalent of SAA function and Service Function are co-located on the IG.</p>
<figure id="general-sap-and-ua-message-flow">
<img alt="FIGURE 18" src="images/GeneralMessageFlowForSAPandUA.png" />
<figcaption>Figure ####: General Message Flow for Service Access Protection and User Authentication</figcaption>
</figure>
<table class="sequence">
<tr><td>1.</td><td>The OITF requests a service.</td></tr>
<tr><td>2.</td><td>The requested service decides whether the request needs to be authenticated or not.<ul>
<li>If not, the service directly serves the request, go to step 5.
<li>If so, go on with step 3.</ul></td></tr>
<tr><td>3.</td><td>The requested service checks if the request is part of an existing valid authenticated service session (see section <a href="#session-management-and-sso" class="sectionRef"></a>, Session Management).<ul>
<li>If so, it directly serves the request, go to step 5.
<li>If not, go on with step 4.</ul></td></tr>
<tr><td>4.</td><td>The requested service triggers SAA authentication. There are two cases: the SAA function is co-located with the requested service or the SAA function is standalone (see section <a href="#service-access-protection" class="sectionRef"></a>, Service Access Protection). The SAA decides what authentication mechanisms it uses (see section <a href="#authentication-interfaces" class="sectionRef"></a>, Interfaces, and section <a href="#oitf-authentication" class="sectionRef"></a>, OITF Authentication Mechanisms).<ul>
<li>If the authentication is successful, go on with step 5. 
<li>If not, the OITF may e.g. retry step 4 or display an error message, or return an HTTP error.</ul></td></tr>
<tr><td>5.</td><td>The requested service serves the request.
</table>
<p>The <b>requested service</b> decides what security is needed for the service delivery: Authentication needed or not, Confidentiality needed (TLS/SSL) or not.</p>
<p>The <b>SAA</b> decides what authentication mechanisms it uses and what security is needed for the performed authentication: TLS/SSL or not.</p>

</section>
<section id="authentication-interfaces"><h2>Interfaces</h2>
<p>This section describes the impact of User Identification, Authentication, Authorisation and Service Access Protection on the HNI-INI and HNI-IGI interfaces.</p>
<section><h3>HNI-INI</h3>
<p>The following authentication mechanisms are supported for HTTP protocol on HNI-INI interface between OITF and Network (see section <a href="#oitf-authentication" class="sectionRef">5.4</a> for their specification):</p><ul>
<li>No authentication;
<li>HTTP authentication, see section <a href="#http-basic-and-digest-authentication" class="sectionRef"></a>;
<li>Network based authentication (this requires no action on the OITF), see section <a href="#network-based-authentication--informative" class="sectionRef"></a>;
<li>Web based authentication, see section <a href="#web-based-authentication" class="sectionRef">5.4.3</a>;
<li>HTTP Digest authentication using an IG (this requires an IG to be present in the home network), see section <a href="#http-digest-authentication-using-ims-gateway" class="sectionRef">5.4.4</a>;
<li>GBA authentication using an IG (this requires an IG to be present in the home network), see section <a href="#gba-authentication-using-ims-gateway" class="sectionRef">5.4.5</a>;
</ul>
<p>The OITF SHALL support all the mechanisms listed above.</p>
<p>The SAA MAY use any of the mechanisms listed above.</p>
<p>Note that GBA authentication can be achieved using either the mechanism in section <a href="#gba-authentication-using-ims-gateway" class="sectionRef">5.4.5</a> <a href="#gba-authentication-using-ims-gateway" class="sectionTitleRef"></a> or the, more general, mechanism in section <a href="#http-digest-authentication-using-ims-gateway" class="sectionRef">5.4.4</a> <a href="#http-digest-authentication-using-ims-gateway" class="sectionTitleRef"></a>. Section <a href="#http-digest-authentication-using-ims-gateway" class="sectionRef">5.4.4</a> allows the use of different authentication mechanism in a way that is transparent to the OITF, including possible future authentication mechanisms, and should preferably be used. It is expected that section <a href="#gba-authentication-using-ims-gateway" class="sectionRef">5.4.5</a> <a href="#gba-authentication-using-ims-gateway" class="sectionTitleRef"></a> will be deprecated and removed in future versions of this specification.</p>
</section>
<section><h3>HNI-IGI</h3>
<p>In this case the equivalent of SAA function and Service Function are co-located on the IG. The following authentication mechanisms are supported for HTTP protocol on HNI-IGI interface between OITF and IG:</p><ul>
<li>No authentication
<li>HTTP authentication, see section <a href="#http-basic-and-digest-authentication" class="sectionRef">5.4.1</a>
<li>Web based authentication, see section <a href="#web-based-authentication" class="sectionRef">5.4.3</a>
</ul>
<p>The OITF SHALL support all the mechanisms listed above.</p>
<p>On the HNI-IGI interface, the IG SHALL support at least one of the following authentication mechanisms:</p><ul>
<li>No authentication
<li>HTTP authentication, see section <a href="#http-basic-and-digest-authentication" class="sectionRef">5.4.1</a>
</ul>
<p>The IG MAY use any of the above listed mechanisms (No authentication, HTTP authentication or Web based authentication).</p>
<p>The OITF and IG SHALL support and perform IMS registration as specified in <a href="volume4.html#s5-4-6" class="extRef">section 5.4.6</a> in [[.OIPF_PROT2]] and described in section <a href="#ims-registration---oitf" class="sectionRef"></a>. They SHALL do so prior to any service access attempt in managed network relying on IMS.</p>
</section>
<section><h3>Common Requirements</h3>
<p>On both HNI-INI and HNI-IGI interface, the OITF SHALL support all of the following mechanisms, redirection, and security for the HTTP protocol and HTML support:</p><ul>
<li>standard HTTP requirements: HTTP redirection, HTTP cookies
<li>URL parameters
<li>HTML forms and HTTP Post in forms
<li>TLS/SSL – TLS 1.2 SHOULD be supported, if not then TLS 1.1 SHOULD be supported, otherwise TLS 1.0 SHALL be supported. The OITF SHALL support TLS Renegotiation Extension as described in [[!RFC5746]].
</ul>
<p>Note: The requirements above ensure the support of SAML web-based SSO, see section <a href="#saml-web-based-sso-1" class="sectionRef"></a>.</p>
<p>To avoid extra message exchanges, the OITF SHALL provide in requests, when available (see section <a href="#session-management-and-sso" class="sectionRef"></a>):</p><ul>
<li>HTTP authentication header (Authorization)
<li>HTTP cookie header (Cookie)
</ul>
</section>
</section>
<section id="service-access-protection"><h2>Service Access Protection (informative)</h2>
<section><h3>SAA Co-located with Service (informative)</h3>
<p>The following figure describes the sequences when the SAA function is co-located with the requested service.</p>
<figure>
<img alt="FIGURE 19" src="images/SAAColocatedWithRequestedService.png" />
<figcaption>Figure ####: SAA Co-located with Requested Service</figcaption>
</figure>

<table class="sequence">
<tr><td>1.</td><td>The OITF requests a service. Authentication is needed and there is no valid authenticated service session.</td></tr>
<tr><td>2.</td><td>The service/SAA performs authentication.</td></tr>
<tr><td>3.</td><td>The requested service serves the request.</td></tr>
</table>
</section>
<section><h3>SAA Standalone (informative)</h3>
<p>The following figure describes the sequences when the SAA function is standalone, the OITF is redirected to the SAA for authentication.</p>
<figure>
<img alt="FIGURE 20" src="images/StandaloneSAA-RedirectionMode.png" />
<figcaption>Figure ####: Standalone SAA, Redirection Mode</figcaption>
</figure>

<table class="sequence">
<tr><td>1.</td><td>The OITF requests a service. Authentication is needed and there is no valid authenticated service session.</td></tr>
<tr><td>2A.</td><td>The requested service triggers SAA authentication. The service redirects the OITF to the SAA (e.g. using HTTP redirection (Location = SAA)).</td></tr>
<tr><td>2B</td><td>The OITF connects to the SAA, using the redirection obtained in step 2A.</td></tr>
<tr><td>3.</td><td>The SAA performs authentication.</td></tr>
<tr><td>4A.</td><td>The SAA redirects the OITF back to the service (e.g. by using SAML HTTP-POST binding, SAML HTTP Post SimpleSign binding or HTTP redirection).</td></tr>
<tr><td>4B.</td><td>The OITF requests the service again, using the redirection obtained in step 4A.</td></tr>
<tr><td>5.</td><td>The requested service checks that authentication succeeded and serves the request.</td></tr>
</table>
</section>
</section>
<section id="oitf-authentication"><h2>OITF Authentication Mechanisms</h2>
<section><h3>HTTP Basic and Digest Authentication</h3>
<p>The OITF SHALL support HTTP basic and digest authentication as specified in [[!RFC2617]]. A possible message flow for HTTP basic and digest authentication is described in Figure <a href="#http-basic-and-digest-auth-sequence" class="figureRef"></a>. When HTTP basic or digest authentication [[!RFC2617]] is used, it is assumed that user identifier and its secret information (e.g. password) are shared between OITF and Providers Network (SAA) in advance of the described sequence.</p>
<figure id="http-basic-and-digest-auth-sequence">
<img alt="FIGURE 21" src="images/HTTPBasicAndDigestAuthentication.png" />
<figcaption>Figure ####: HTTP Basic and Digest Authentication</figcaption>
</figure>
<table class="sequence">
<tr><td>1.</td><td>The OITF requests a service co-located with the SAA function or has requested a service and has been redirected to SAA function.</td></tr>
<tr><td>2.</td><td>The SAA responds with a "401 Unauthorized" status code with a WWW-Authenticate header defined in [[!RFC2617]].</td></tr>
<tr><td>3.</td><td>The OITF re-sends the request with an Authorization header as defined in [[!RFC2617]]. The user identifier and its secret information are used as username-value and password for the generation of the Authorisation header.</td></tr>
<tr><td>4.</td><td>The SAA checks the Authorisation header. If the verification succeeds, the SAA/service serves the request or redirects the OITF to the service (e.g. by using SAML HTTP-POST binding, SAML HTTP Post SimpleSign binding or HTTP redirection). The response contains an AuthenticationInfo header. The response may contain session management information (cookie, URL parameter).</td></tr>
</table>
<p>If no user and password are available at the OITF, a window may be displayed to the user for entering his credentials between step 2 and 3. This is the standard working in a DAE application. As described in general principles, this situation shall occur only if no valid authentication session or credentials are available in the OITF.</p>
<p>NOTE: To protect the password that is in the clear in HTTP basic authentication; the SAA may additionally require TLS/SSL as stated in the general principles.</p>
</section>

<section><h3>Network Based Authentication (informative)</h3>
<p>This section describes the message flows for network based authentication. Network based authentication is a silent authentication based on network information. This authentication is transparent to the OITF.</p>
<p>In the case of a managed network, the SAA can rely on (proprietary) network specific information, which information is out of scope of this specification, to authenticate an incoming request. The sequences are depicted in the following figure:</p>
<figure>
<img alt="FIGURE 22" src="images/NetworkBasedAuthentication.png" />
<figcaption>Figure ####: Network Based Authentication</figcaption>
</figure>
<table class="sequence">
<tr><td>1.</td><td>The OITF requests a service co-located with the SAA function or has requested a service and has been redirected to an SAA function.</td></tr>
<tr><td>2.</td><td>The SAA links the request to the user based on network information.</td></tr>
<tr><td>3.</td><td>If the operation succeeds, the SAA/service serves the request or redirects the OITF to the service (e.g. by using SAML HTTP-POST binding, SAML HTTP Post SimpleSign binding or HTTP redirection). The response may contain session management information (cookie, URL parameter).</td></tr>
</table>
</section>
<section><h3>Web Based Authentication</h3>
<p>The calling function in the OITF SHOULD support receiving a CE-HTML response for a service HTTP request and SHOULD launch the DAE for displaying it. If the calling function does not support receiving an CE-HTML, XHTML or HTML compatible response, it SHALL signal it to the server by including its acceptable media types without “application/xhtml+xml”, “application/ce-html+xml”, and “text/html” in the request's HTTP "accept" header explicitly, and by also not including CE-HTML/1.0 as part of the User-Agent header. If the calling function does not support receiving an CE-HTML, XHTML or HTML compatible response, the SAA SHALL return a "403 Forbidden" HTTP error.</p>
<p>As described in general principles, this situation shall occur only if no valid authentication session is available in the OITF (e.g. no cookie available).</p>
<p>The DAE within the OITF SHALL support CE HTML forms and HTTP Post in forms.</p>
<p>The remainder of this section describes the message flows for web based authentication. Web based authentication can be explicit or implicit/silent.</p><ul>
<li>explicit authentication: the user is prompted with a web page form to fill-in with a login and password: the result of the authentication can be persistent for later re-use (implicit/silent authentication)
<li>implicit/silent authentication: the user is not prompted with any form but s/he is silently authenticated based on persistent data (session management)
</ul>
<p>Web based authentication mechanisms do not add requirements to the OITF besides supporting a DAE. They are based on optionally HTML forms and HTTP Post, HTTP redirection and HTTP cookies.</p>
<figure>
<img alt="FIGURE 23" src="images/WebBasedAuthenticationWithForm.png" />
<figcaption>Figure ####: Web Based Auhentication with Form</figcaption>
</figure>
<table class="sequence">
<tr><td>1.</td><td>The OITF requests a service co-located with the SAA function or has requested a service and has been redirected to SAA function.</td></tr>
<tr><td>2.</td><td>If the HTTP request to the SAA has a User-Agent string that includes CE-HTML/1.0 as defined in [[!CEA-2014-A]], or the "accept" HTTP header includes (explicitly or implicitly) a CE-HTML accept header (“application/ce html+xml”), the SAA responds with a CE-HTML compatible web form for requesting user credentials. User credentials provisioning are out of scope of this specification.</td></tr>
<tr><td>3.</td><td>The web form is displayed in the DAE. </td></tr>
<tr><td>4.</td><td>The user enters his credentials and validates the form.</td></tr>
<tr><td>5.</td><td>The form validation posts the user credentials to the SAA.</td></tr>
<tr><td>6.</td><td>The SAA checks the credentials.</td></tr>
<tr><td>7.</td><td>If verification is successful, the SAA/service serves the request or redirects the OITF to the service (e.g. by using SAML HTTP-POST binding, SAML HTTP Post SimpleSign binding or HTTP redirection). The response MAY contain session management information (cookie, URL parameter).</td></tr>
</table>
</section>
<section id="http-digest-authentication-using-ims-gateway"><h3>HTTP Digest Authentication using IMS Gateway</h3>
<p>This section specifies optional functionality by which an OITF can use HTTP Digest credentials in an IG, if present in the home network, for user authentication to HTTP services relying on IMS credentials. The mechanism specified here allows the use of different types of credentials, depending on the capabilities of the IG, and in a  way transparent to the OITF, including an extension mechanism to future authentication mechanisms. The OITF discovers the authentication mechanisms supported by IG and the associated credentials stored in the IG, and offers them towards an application server. The application server selects one of the offered authentication mechanisms.</p>
<p>The IG SHALL signal that it supports HTTP Digest Authentication in its description during UPnP discovery as specified in [[.OIPF_PROT2]], <a href="volume4.html#s10-1-1-1-3" class="extRef">section 10.1.1.1.3</a>.</p>
<p>HTTP Basic authentication SHALL NOT be used.</p>
<p>NOTE: The criteria that determine under which circumstances the functionality by which an OITF can use the HTTP Digest credentials in a Gateway Function is implemented in an OITF are out of the scope of the present document.</p>
<section><h4>Initial procedure</h4>
<p>When the OITF is powered up and if the IG supports HTTP Digest Authentication, the OITF SHALL request supported HTTP Digest authentication realms from the IG as described in [[.OIPF_PROT2]], <a href="volume4.html#s5-4-6-3-1" class="extRef">section 5.4.6.3.1</a>. Receiving this request:</p><ul>
<li>If the IG supports GBA as defined in [[!3GPP33.220]], the IG SHALL perform a GBA bootstrapping for the current IMS registered user towards the GBA Single Sign-On Function (acting like a BSF in [[!3GPP33.220]]). The GBA registration is based on secrets shared between the ISIM and the network provider. The result of a successful GBA run is the establishment of a session identifier, B-TID, and a shared key, Ks. The decision on running GBA_U or GBA_ME is based on subscription information (i;e; UICC capabilities) as described in [[!3GPP33.220]]. Thus if the ISIM supports GBA, GBA_U bootstrap SHALL be run and in this case the key Ks is computed by the ISIM on the IG side and doesn’t leave the UICC.  If the ISIM doesn’t support GBA, GBA_ME SHALL be run. The support of GBA by the ISIM is indicated in the ISIM Service Table as defined in [[!3GPP31.103]]. This Ks key can later be re-used to derive server side application (NAF) specific keys. These keys can also be passed on to trusted applications in the home network, and can later be used for authentication based on the GBA authentication, but without further need for IG-provider network communication.
<li>The IG SHALL provide the list of supported realms for <a href="#http-digest-authentication-using-ims-gateway" class="sectionTitleRef"></a>. If the IG supports GBA, it SHALL include in this list the realm for GBA authentication, as defined in [[!3GPP24.109]].
<li>The IG MAY provide a token to append to the HTTP User-Agent of the OITF for signalling support of specific authentication scheme. The IG SHALL provide the token "3gpp-gba", as specified in [[!3GPP24.109]], if it supports GBA.
</ul>
<p>The OITF MAY check the returned User-Agent token. The OITF SHALL accept unknown User-Agent tokens,  in order to allow evolution of the authentication procedure.</p>
<p>The OITF SHALL append the returned User-Agent token to its User-Agent.</p>
<p>Note: If the IG supports GBA Authentication, as the IG adds "3gpp-gba" to the returned User-Agent token, the OITF acts as a User Equipment in [[!3GPP24.109]] and signals in its User Agent that it supports GBA Authentication.</p>
<figure id="http-gba-initial-procedure">
<img alt="FIGURE 24" src="images/HTTPGBAInitialProcedure.png" />
<figcaption>Figure ####: Initial Procedure</figcaption>
</figure>
<p>Figure <a href="#http-gba-initial-procedure" class="figureRef"></a> shows the message sequence for initial procedure to ensure HTTP Digest authentication using IG. It contains the following steps:</p>
<table class="sequence">
<tr><td>1.</td><td>The OITF is powered on.</td></tr>
<tr><td>2.</td><td>The OITF performs a user registration as defined in section <a href="#ims-registration---oitf" class="sectionRef"></a>.</td></tr>
<tr><td>3.</td><td>The OITF sends a Fetch HTTP realms request to IG as defined in [[.OIPF_PROT2]], <a href="volume4.html#s5-4-6-3-1" class="extRef">section 5.4.6.3.1</a>, step 1. The IG validates the request. The IG may require at that stage any authentication mechanism specified in section <a href="#hni-igi" class="sectionRef">5.2.2</a> and/or any mechanism and security (i.e. TLS/SSL) specified in section <a href="#common-requirements" class="sectionRef">5.2.3</a>. For simplification, none of this mechanism is shown in Figure <a href="#http-gba-initial-procedure" class="figureRef"></a>.</td></tr>
<tr><td>4.</td><td>If IG supports GBA, the IG performs GBA Bootstrapping procedure according to [[!3GPP33.220]] towards the GBA Single Sign-on (BSF) function in the provider's network. If successful, this results in establishing a shared key Ks on both ends. The GBA Single Sign-on function also sends the lifetime of the key Ks and a session identifier B-TID to the IG.</td></tr>
<tr><td>5.</td><td>The IG returns the list of supported realm and user-agent string to the OITF as defined in [[.OIPF_PROT2]], <a href="volume4.html#s5-4-6-3-1" class="extRef">section 5.4.6.3.1</a>, step 2.</td></tr>
</table>

</section>
<section><h4>Authentication procedure</h4>
<p>If the OITF has registered to an IG which supports HTTP Digest Authentication, each time the OITF needs to access a service offered by an application server that requires HTTP Digest authentication, the OITF SHALL check the realm against the realms retrieved from IG in the initial procedure. If the realm matches to one of the IG supported realms, the OITF SHALL retrieve HTTP credentials and HTTP headers from the IG, as specified in [[.OIPF_PROT2]], <a href="volume4.html#s5-4-6-3-2" class="extRef">section 5.4.6.3.2</a>.</p> 
<p>As a pre-requisite to this procedure, the IMS registration MUST have been successfully completed.</p> 
<p>The IG MAY provide the following HTTP header:</p><ul>
<li>For 3GPP GBA Authentication, a "X-3GPP-Intended-Identity" containing the identity of the current user, as specified in [[!3GPP24.109]]
<li>For HTTP Digest Authentication, a "X-OIPF-Intended-Identity" containing the identity of the current user.
</ul> 
<p>The SAA MAY verify that the intended identity matches to the authenticated identity.</p> 
<p>Note: The intended identity is used to identify the user when credentials are shared among users. The service provider should define and enforce policies for sharing of credentials among users. </p> 
<p>The OITF MAY check the returned HTTP Headers. The OITF SHALL accept unknown User-Agent tokens, in order to allow evolution of the authentication procedure.</p> 
<p>The OITF SHALL use the returned credentials towards the application server, using HTTP Digest authentication as specified by [[!RFC2617]] and SHALL add the returned HTTP headers to the outgoing HTTP requests for this realm.</p> 
<p>Note: The service provider should define and enforce policies for sharing of credentials among application servers. </p> 

<section><h5>Authentication procedure using stored credentials</h5>
<p>The same credentials and realm as for SIP digest MAY be used, this is an operator security and deployment choice (managed in the IG and the network). In this case:</p><ul>
<li>the userid SHALL be set to the value of the private user identity;
<li>the realm SHALL be set to  the domain name of the home network;
</ul>
<figure id="http-credentials-stored-in-ig">
<img alt="FIGURE 25" src="images/HTTPCredentialsStoredInIG.png" />
<figcaption>Figure ####: Authentication between an OITF and an SAA based on HTTP credentials stored in IG</figcaption>
</figure>
<p>Figure <a href="#http-credentials-stored-in-ig" class="figureRef"></a> shows the message sequence for authentication between an OITF function and an SAA based on HTTP credentials retrieved from the IG. It contains the following steps:</p>
<table class="sequence">
<tr><td>1.</td><td>OITF function sends a request for a resource (e.g., service) to the SAA. It is assumed here that the resource requires authentication.</td></tr>
<tr><td>2.</td><td>The SAA returns a 401 Unauthorized message as defined in [[!RFC2617]]</td></tr>
<tr><td>3.</td><td>The OITF checks the realms. The realm is one of the realms supported by the IG for HTTP Digest authentication. The OITF sends a request including the IMPU, the auth-scheme and realm and additional authentication parameters in case of digest authentication to the IG to retrieve HTTP credentials for the registered user. The request format is specified in [[.OIPF_PROT2]], <a href="volume4.html#s5-4-6-3-2" class="extRef">section 5.4.6.3.2</a>, step 1.</td></tr>
<tr><td>4.</td><td>IG returns the authentication credentials and optionally HTTP Headers. The nature of the authentication credentials and the response format are specified in [[.OIPF_PROT2]],  <a href="volume4.html#s5-4-6-3-2" class="extRef">section 5.4.6.3.2</a>, step 2. The IG may require at that stage any authentication mechanism specified in section <a href="#hni-igi" class="sectionRef">5.2.2</a> and/or any mechanism and security (i.e. TLS/SSL) specified in section <a href="#common-requirements" class="sectionRef">5.2.3</a> for access control and/or protection of the credentials. For simplification, none of this mechanism is shown in Figure <a href="#http-credentials-stored-in-ig" class="figureRef"></a>.</td></tr>
<tr><td>5.</td><td>The OITF function repeats the request 1. with an Authorisation header, using returned authentication credentials. The OITF adds the returned HTTP headers, if any, to the request.</td></tr>
<tr><td>6.</td><td>SAA requests from the User Database for the subscriber specified via its user-id, its HTTP credentials (authentication vector) and possible identities. </td></tr>
<tr><td>7.</td><td>The SAA gets the authentication vector and possible identities from the User Database. The SAA checks the user-id and password. The SAA may verify that the intended identity provided in the HTTP header belongs to the possible identities of the subscriber. Note: it is assumed that there exists a trust relation between SAA and User Database. Details are out of scope of this specification.</td></tr>
<tr><td>8.</td><td>Upon successful authentication, the SAA/service serves the request or redirects the OITF to the service (e.g. by using SAML HTTP-POST binding, SAML HTTP Post SimpleSign binding or HTTP redirection). The response may contain session management information (cookie, URL parameter).</td></tr>
</table>
<p>The message format for steps 3 and 4 are specified in the  <a href="volume4.html#s5-4-6-3-2" class="extRef">section 5.4.6.3.2</a> of [[.OIPF_PROT2]].</p>
</section>
<section><h5>Authentication procedure using GBA credentials</h5>
<p>The key Ks that was established during the GBA registration MAY be used later on for authentication between OITF functions and services (i.e., Application Servers). Each time an OITF needs to access a service offered by an AS (i.e., NAF) that requires GBA Authentication, a specific key Ks_NAF in case of GBA-ME or Ks_ext_NAF in case of GBA-U SHALL be derived by the IG or ISIM in IG respectively and the server side GBA Single Sign-on function (acting like a BSF in [[!3GPP24.109]]). For clarity this specific key is named in the rest of the document Ks_(ext)_NAF and will refer to Ks_NAF in case of GBA_ME and Ks_ext_NAF in case of GBA_U. This generated key SHALL be conveyed to the OITF function in the residential network by the IG, and to the AS by the server side GBA Single Sign-on function (BSF). The key Ks_(ext)_NAF SHALL then be used for authentication between the OITF function and the AS, using HTTP Digest authentication as specified by [[!3GPP24.109]]. </p>
<p>When a SAA (acting like a NAF in [[!3GPP24.109]]) requests GBA Authentication (perceived as regular HTTP Digest authentication by the OITF), the OITF SHALL retrieve HTTP credentials, in this case GBA Credentials, and HTTP Headers and SHALL perform HTTP Digest authentication.</p>
<p>As a pre-requisite to this procedure, the GBA registration MUST have been successfully completed by the IG in the initial procedure (cf. <a href="#initial-procedure" class="sectionRef"></a>).</p>
<figure id="oitf-saa-based-on-gba-credentials">
<img alt="FIGURE 26" src="images/AuthenticationBetweenOITFandSAAbasedonGBA.png" />
<figcaption>Figure ####: Authentication between an OITF and an SAA Based on GBA Credentials</figcaption>
</figure>
<p>Figure <a href="#oitf-saa-based-on-gba-credentials" class="figureRef"></a> shows the message sequence for authentication between an OITF function and an SAA based on the previously established GBA bootstrapping. It contains the following steps:</p>
<table class="sequence">
<tr><td>1.</td><td>OITF function sends a request for a resource (e.g., service) to the SAA (NAF). It is assumed here that the resource requires authentication. The User-Agent string in the HTTP request contains "3gpp-gba" indicating to the SAA that it supports GBA authentication. Note: the user-agent string has previously been sent from IG to OITF,</td></tr>
<tr><td>2.</td><td>The SAA (NAF) returns a 401 Unauthorized message, the realm indicates that 3GPP bootstrapping is used and provides the NAF FQDN as defined in [[!3GPP24.109]].</td></tr>
<tr><td>3.</td><td>The OITF checks the realms. The realm is one of the realms supported by the IG for HTTP Digest authentication. The OITF sends a request including the IMPU, the auth-scheme and realm and additional authentication parameters for digest authentication to the IG to retrieve HTTP credentials for the registered user. The request format is specified in [[.OIPF_PROT2]],  <a href="volume4.html#s5-4-6-3-2" class="extRef">section 5.4.6.3.2</a>, step 1. The IG identifies from the realm that GBA authentication is requested. IG generates Ks_NAF in case of GBA_ME or Ks_ext_NAF with the co-operation of the ISIM in case of GBA_U (Ks_(ext)_NAF). Note: according to [[!3GPP33.220]], the NAF_ID is constructed as follows: NAF_ID = FQDN of the NAF || Ua security protocol identifier. The FQDN of the NAF is included in the realm. The identifier for Ua security protocol HTTP Digest authentication according to [[!3GPP24.109]] is (0x01,0x00,0x00, 0x00,0x02).<br />Ks_(ext)_NAF is computed as Ks_(ext)_NAF = KDF (Ks, "gba-me", RAND, IMPI, NAF_ID), where KDF is the key derivation function as specified in Annex B of [[!3GPP33.220]], and the key derivation parameters consist of the user's IMPI, the NAF_ID and RAND.</td></tr>
<tr><td>4.</td><td>IG returns the authentication credentials and optionally HTTP Headers. The B-TID is used as username and Ks_(ext)_NAF as password. The IG may return a "X-3GPP-Intended-Identity" HTTP header containing the identity of the current user, as specified in [[!3GPP24.109]]. The response format is specified in [[.OIPF_PROT2]], <a href="volume4.html#s5-4-6-3-2" class="extRef">section 5.4.6.3.2</a>, step 2.</td></tr>
<tr><td>5.</td><td>The OITF function repeats the request 1. with an Authorisation header, using authentication credentials returned from IG in step 4. The OITF adds the returned HTTP headers, if any, to the request.</td></tr>
<tr><td>6.</td><td>SAA (NAF) sends B-TID and its NAF_ID to the GBA Single Sign-on function (BSF) in provider network, the GBA Single Sign-on function retrieves Ks and calculates Ks_(ext)_NAF.</td></tr>
<tr><td>7.</td><td>The GBA Single Sign-on function (BSF) in provider network returns Ks_(ext)_NAF, together with its lifetime, to SAA (NAF).<br />Note the key lifetime returned by the GBA Single Sign-on function (BSF) is equal to the lifetime of the corresponding Ks. But the SAA (NAF) may choose a shorter key lifetime based on local policy and/or application-specific needs.</td></tr>
<tr><td>8.</td><td>If Ks_(ext)_NAF has expired, the SAA (NAF) shall send a suitable bootstrapping renegotiation request to the OITF, according to [[!3GPP33.220]] and [[!3GPP24.109]]. Otherwise the SAA (NAF) uses Ks_(ext)_NAF to authenticate the request. Upon successful authentication, the SAA (NAF)/service serves the request or redirects the OITF to the service (e.g. by using SAML HTTP-POST binding, SAML HTTP Post SimpleSign binding or HTTP redirection). The response may contain session management information (cookie, URL parameter).</td></tr>
</table>
<p>The message format for steps 3 and 4 are specified in the  <a href="volume4.html#s5-4-6-3-2" class="extRef">section 5.4.6.3.2</a> of [[.OIPF_PROT2]].</p>
</section>
</section>
</section>
<section id="gba-authentication-using-ims-gateway"><h3>GBA Authentication using IMS Gateway</h3>
<p>Note that GBA authentication can be achieved using either the mechanism in section <a href="#gba-authentication-using-ims-gateway" class="sectionRef">5.4.5</a> <a href="#gba-authentication-using-ims-gateway" class="sectionTitleRef"></a> or the, more general, mechanism in section <a href="#http-digest-authentication-using-ims-gateway" class="sectionRef">5.4.4</a> <a href="#http-digest-authentication-using-ims-gateway" class="sectionTitleRef"></a>. <a href="#http-digest-authentication-using-ims-gateway" class="sectionRef"></a> allows the use of different authentication mechanism in a way that is transparent to the OITF, including possible future authentication mechanisms, and should preferably be used. It is expected that section <a href="#gba-authentication-using-ims-gateway" class="sectionRef">5.4.5</a> <a href="#gba-authentication-using-ims-gateway" class="sectionTitleRef"></a> will be deprecated and removed in future versions of this specification.</p>
<p>This section specifies optional functionality by which an OITF can use the ISIM in an IG, if present in the home network, for user authentication to services relying on IMS credentials. This section is based on the principles described in [[.OIPF_ARCH2]] <a href="architecture.html#proxy-description-and-gba-sso" class="extRef">Appendix B</a>, but extends that section.</p>
<p>The IG SHALL signal that it supports GBA Authentication in its description during UPnP discovery as specified in [[.OIPF_PROT2]],  <a href="volume4.html#s10-1-1-1-3" class="extRef">section 10.1.1.1.3</a>.</p>
<p>NOTE: The criteria that determine under which circumstances the functionality by which an OITF can use the ISIM in a Gateway Function is implemented in an OITF are out of the scope of the present document.</p>
<section id="initial-gba-registration"><h4>Initial GBA Registration</h4>
<p>When the OITF is powered up or when the user initiates a registration, i.e. when the OITF requests a User Registration from the IG, and if the IG supports GBA Authentication, the OITF SHALL, after the User Registration from the IG, request a GBA Registration from the IG as described in [[.OIPF_PROT2]]. Receiving this request, the IG SHALL perform a GBA registration for the current IMS registered user towards the GBA Single Sign-On Function (acting like a BSF), according to [[!3GPP33.220]]. The GBA registration is based on secrets shared between the ISIM and the network provider. The result of a successful GBA run is the establishment of a session identifier, B-TID, and a shared key, Ks. This key Ks can later be re-used to derive server side application (NAF) specific keys. These keys can also be passed on to trusted applications in the home network, and can later be used for authentication based on the GBA authentication, but without further need for IG-provider network communication.</p>
<figure id="initial-gba-registration-sequence">
<img alt="FIGURE 27" src="images/InitialGBARegistration.png" />
<figcaption>Figure ####: Initial GBA Registration</figcaption>
</figure>
<p>Figure <a href="#initial-gba-registration-sequence" class="figureRef"></a> shows the message sequence for initial GBA registration. It contains the following steps:</p>
<table class="sequence">
<tr><td>1.</td><td>The OITF is powered on (automatic default registration) or the user requests a personalised registration.</td></tr>
<tr><td>2.</td><td>The OITF performs a user registration as defined in section <a href="#gba-authentication-using-ims-gateway" class="sectionRef">5.4.5</a>.</td></tr>
<tr><td>3.</td><td>The OITF sends a GBA registration request to IG as defined in [[.OIPF_PROT2]],  <a href="volume4.html#s5-4-6-2-1" class="extRef">section 5.4.6.2.1</a>, step 1.</td></tr>
<tr><td>4.</td><td>The IG validates the request. The IG may require at that stage any authentication mechanism specified in section <a href="#hni-igi" class="sectionRef">5.2.2</a> and/or any mechanism and security (i.e. TLS/SSL) specified in section <a href="#common-requirements" class="sectionRef">5.2.3</a>. For simplification, none of this mechanism is shown in Figure <a href="#initial-gba-registration-sequence" class="figureRef"></a>.</td></tr>
<tr><td>5.</td><td>The IG performs GBA bootstrapping procedure according to [[!3GPP33.220]] towards the GBA Single Sign-on function (BSF) in the provider's network. If successful, this results in establishing a shared key Ks on both ends. The GBA Single Sign-on function (BSF) also sends the lifetime of the key Ks and a session identifier B-TID to the IG.</td></tr>
<tr><td>6.</td><td>The IG returns the outcome of the GBA registration process to the OITF as defined in [[.OIPF_PROT2]], <a href="volume4.html#s5-3-6-2-1" class="extRef">section 5.3.6.2.1</a>, step 2.</td></tr>
<tr><td>7.</td><td>If the result of the registration procedure is successful, a registration state is created and maintained in IG.</td></tr>
<tr><td>8.</td><td>An indication is sent to the user that includes the outcome of the registration process.</td></tr>
</table>
</section>
<section><h4>Re-use of GBA Authentication – Using HTTP Digest Authentication</h4>
<p>The key Ks that was established during the GBA registration MAY be used later on for authentication between OITF functions and services (i.e., Application Servers). Each time an OITF needs to access a service offered by an AS (i.e., NAF) that requires GBA Authentication, a specific key Ks_(ext)_NAF SHALL be derived by the IG and the server side GBA Single Sign-on function (acting like a BSF in [[!3GPP24.109]]). This generated key SHALL be conveyed to the OITF function in the residential network by the IG, and to the AS by the server side GBA Single Sign-on function (BSF). The key Ks_(ext)_NAF SHALL then be used for authentication between the OITF function and the AS, using HTTP Digest authentication as specified by [[!3GPP24.109]]. </p>
<p>If the OITF has registered to an IG which supports GBA Authentication, the OITF SHALL act as a User Equipment in [[!3GPP24.109]] and therefore SHALL signal in its User Agent that it supports GBA Authentication.</p>
<p>When a SAA (acting like a NAF in [[!3GPP24.109]]) requests GBA Authentication, the OITF SHALL retrieve GBA Credentials for the specified SAA (NAF) from the IG as specified in [[.OIPF_PROT2]], and SHALL perform HTTP Digest authentication as specified by [[!3GPP24.109]].</p>
<p>If the OITF retrieves an X-HNI-IGI-Intended-Identity HTTP header from the IG, it SHALL use it as intended user identity and SHALL add an "X-3GPP-Intended-Identity" HTTP header to the outgoing HTTP requests to the SAA (NAF); as specified in [[!3GPP24.109]]. The SAA MAY verify that the intended identity belongs to the user (i.e. the identity matches one of the user’s public identities indicated in the user security setting that was retrieved from the GBA Single Sign-On Function (BSF)).</p>
<p>As a pre-requisite to this procedure, the GBA registration (cf. <a href="#initial-gba-registration" class="sectionRef"></a>) MUST have been successfully completed.</p>
<figure id="oitf-saa-authentication-based-on-gba-keys">
<img alt="FIGURE 28" src="images/AuthenticationBetweenOITFandSAAbasedonGBAkeys.png" />
<figcaption>Figure ####: Authentication between an OITF and an SAA Based on GBA Keys</figcaption>
</figure>
<p>Figure <a href="#oitf-saa-authentication-based-on-gba-keys" class="figureRef"></a> shows the message sequence for authentication between an OITF function and an SAA based on the previously established GBA key. It contains the following steps:</p>
<table class="sequence">
<tr><td>1.</td><td>OITF function sends a request for a resource (e.g., service) to the SAA (NAF). It is assumed here that the resource requires authentication. The User-Agent string in the HTTP request contains "3gpp-gba" indicating to the SAA (NAF) that it supports GBA authentication.</td></tr>
<tr><td>2.</td><td>The SAA (NAF) returns a 401 Unauthorized message, the realm indicates that 3GPP bootstrapping is used and provides the NAF FQDN as defined in [[!3GPP24.109]].</td></tr>
<tr><td>3.</td><td>OITF sends a request including the NAF FQDN to the IG to retrieve GBA credentials, and IG generates Ks_NAF in case of GBA_ME or Ks_ext_NAF with the co-operation of the ISIM in case of GBA_U (Ks_(ext)_NAF). Note: according to [[!3GPP33.220]], the NAF_ID is constructed as follows: NAF_ID = FQDN of the NAF || Ua security protocol identifier. The identifier for Ua security protocol HTTP Digest authentication according to [[!3GPP24.109]] is (0x01,0x00,0x00, 0x00,0x02). The request format is specified in [[.OIPF_PROT2]], <a href="volume4.html#s5-3-6-2-2" class="extRef">section 5.3.6.2.2</a>, step 1.<br />Ks_(ext)_NAF is computed as Ks_(ext)_NAF = KDF (Ks, "gba-me", RAND, IMPI, NAF_ID), where KDF is the key derivation function as specified in Annex B of [[!3GPP33.220]], and the key derivation parameters consist of the user's IMPI, the NAF_ID and RAND.</td></tr>
<tr><td>4.</td><td>IG returns Ks_(ext)_NAF, B-TID, the lifetime of the key Ks_(ext)_NAF and optionally the intended identity to OITF. The lifetime indicates the expiry time of the key Ks_(ext)_NAF and is equal to the lifetime of the key Ks (which was specified by the BSF during the GBA bootstrapping procedure). The response format is specified in [[.OIPF_PROT2]], <a href="volume4.html#s5-3-6-2-2" class="extRef">section 5.3.6.2.2</a>, step 2.</td></tr>
<tr><td>5.</td><td>The OITF function repeats the request with an Authorisation header, using B-TID as username and Ks_(ext)_NAF as password. If a non empty intended identity is returned from the IG, the OITF adds an X-3GPP-Intended-Identity HTTP Header containing the intended identity. If no intended identity is returned from the IG, the OITF shall not add an X-3GPP-Intended-Identiy.</td></tr>
<tr><td>6.</td><td>SAA (NAF) sends B-TID and its NAF_ID to the GBA Single Sign-on function (BSF) in provider network, the GBA Single Sign-on function (BSF) retrieves Ks and calculates Ks_(ext)_NAF.</td></tr>
<tr><td>7.</td><td>The GBA Single Sign-on function (BSF) in provider network returns Ks_(ext)_NAF, together with its lifetime, to SAA (NAF).<br />Note the key lifetime returned by the GBA Single Sign-on function (BSF) is equal to the lifetime of the corresponding Ks. But the SAA (NAF) may choose a shorter key lifetime based on local policy and/or application-specific needs.</td></tr>
<tr><td>8.</td><td>If Ks_(ext)_NAF has expired, the SAA (NAF) shall send a suitable bootstrapping renegotiation request to the OITF, according to [[!3GPP33.220]]. Otherwise the SAA (NAF) uses Ks_(ext)_NAF to authenticate the request. Upon successful authentication, the SAA (NAF)/service serves the request or redirects the OITF to the service (e.g. by using SAML HTTP-POST binding, SAML HTTP Post SimpleSign binding or HTTP redirection). The response may contain session management information (cookie, URL parameter).</td></tr>
</table>
<p>The message format for steps 3 and 4 are specified in the  <a href="volume4.html#s5-3-6-2-2" class="extRef">section 5.3.6.2.2</a> of [[.OIPF_PROT2]].</p>
</section>
<section><h4>Binding Between GBA User Authentication and DRM Device Authentication (informative)</h4>
<p>GBA authenticates ISIM/IMPI, not the device. On the other hand, DRM (e.g. Marlin) relies on device authentication; the device must have a valid certificate issued by the DRM trust authority. To avoid security issues e.g. allowing a legitimate (from a DRM point of view) device that is however not in fact authorised by a user accessing services, the GBA (user) authentication and the DRM device authentication need to be securely linked together.</p>
</section>
</section>
</section>
<section><h2>IMS Registration - OITF</h2> <!-- 5.5 -->
<p>This section specifies the message flows for IMS Registration using SIP Digest (*)  authentication or IMS AKA authentication by means of which Service Platform Providers and IMS Gateways located in Residential Networks can authenticate each other. These message flows are based on [[!3GPP33.203]] and [[!3GPP24.229]] (stage 3 specification).</p>
<p class="footnote">(*) This section specifies authentication-related details of certain SIP messages. Elsewhere, for example at ETSI TISPAN, this SIP authentication method is often called “HTTP Digest” as SIP Digest [[!RFC3261]] is identical to HTTP Digest [[!RFC2617]] – despite the fact that the protocol in question is SIP and not HTTP. The authentication method treated in this section is referred to as “SIP Digest” since the name “HTTP Digest” might lead to the wrong impression that the protocol in question is HTTP.</p>
<section><h3>Relevant Functional Entities and Reference Points</h3>
<p>Figure <a href="#fes-and-rps-in-ims-registration" class="figureRef"></a> extracts the functional entities and reference points relevant for IMS Registration from the OIPF Provider and Residential Network Architectures (see Figures <a href="architecture.html#high-level-architecture" class="extRef">5-2</a> and <a href="architecture.html#residential-network-architecture" class="extRef">5-4</a> in [[.OIPF_ARCH2]]):</p>
<figure id="fes-and-rps-in-ims-registration">
<img alt="FIGURE 29" src="images/FunctionsAndInterfacesInIMSRegistration.png" />
<figcaption>Figure ####: OIPF Functional Entities and Reference Points Involved in IMS Registration</figcaption>
</figure>
<p>SIP Digest authentication, and respectively IMS AKA authentication is interlaced into the IMS Registration message exchange between the IMS Gateway (IG) and the Authentication and Session Management (ASM) functional entities. IMS Registration occurs either when the IG is powered up or when the IG receives a corresponding request from an OITF. The User Database supplies the ASM with authentication vectors needed for SIP Digest authentication, and respectively IMS AKA authentication.</p>
</section>
<section><h3>Prerequisites</h3>
<p>Prior to the first IMS Registration (and hence prior to the first SIP Digest or IMS AKA) protocol execution, the following parameters MUST be provisioned:</p><ul>
<li>to the IG:<p class="footnote">In case of IMS AKA, these parameters are in a UICC with an ISIM or USIM application.</p><ul>
<li>for SIP Digest:<ul>
<li>one or more IP Multimedia Private Identities (IMPI),
<li>one or more IP Multimedia Public Identities (IMPU), each associated to one or more IMPIs,
<li>one or more passwords, each assigned to one and only one of the IMPIs provisioned to the IG,
<li>a Service Platform Provider Network Domain Name.</ul>
<li>for IMS AKA, an ISIM or a USIM application shall always be used for authentication, as described in [[!3GPP33.203]]. For the purpose of this document, the ISIM is a term that indicates a collection of IMS security data and functions on a UICC.<ul>
<li>The ISIM SHALL include :<ul>
<li>one IMPI.
<li>one or more IP Multimedia Public Identities (IMPU), associated with the IMPI
<li>a SPP Network Domain Name referred as Home Network Domain Name in 3GPP specifications
<li>Support for sequence number checking in the context of IMS Domain
<li>An Authentication key
<li>The same framework for algorithms as specified for USIM</ul>
<li>There shall only be one ISIM for each IMPI. </ul>
</ul>
<li>and to the User Database, the IMS subscription information comprising:<ul>
<li>the IMPI(s) and IMPU(s) provisioned to the IG, 
<li>the association of the IMPU(s) to the IMPI(s), 
<li>and for SIP Digest the password(s) provisioned to the IG. The User Database stores each password against the IMPI it is assigned to.
<li>and for IMS AKA the Authentication Key contained and protected within the UICC in the IG. The User Database stores each Authentication Key against the IMPI it is assigned to.
</ul></ul>
<p>Methods for provisioning these parameters to IG and User Database functional entities are out of scope of this specification.<p>

</section>
<section><h3>SIP Digest Message Flows</h3>
<p>Figure <a href="#sip-digest-with-ims-registration" class="figureRef"></a> shows the message flow for SIP Digest authentication, which is interlaced into IMS Registration messages:</p>
<figure id="sip-digest-with-ims-registration">
<img alt="FIGURE 30" src="images/SIPDigestWithIMSRegistration.png" />
<figcaption>Figure ####: SIP Digest Message Flow Interlaced into IMS Registration</figcaption>
</figure>
<table class="sequence">
<tr><td>0.</td><td>The IG is powered up. This can initiate the execution of steps 2 – 7.</td></tr>
<tr><td>1.</td><td><b>OITF to IG: Registration Request</b><br />The OITF sends a request for registration to the IMS Gateway (IG), when needed (the end user explicitly logs on for personalized services).</td></tr>
<tr><td>2.</td><td><b>IG to ASM: SIP REGISTER</b><br />This request contains the SPP Network Domain Name of the IG’s IMS home network, an IMPI and an IMPU. If the ASM has a valid SIP Digest authentication vector (SD-AV) for the specific IMPI, steps 3, 4 and 5 are omitted.</td></tr>
<tr><td>3.</td><td><b>ASM to User Database: DIAMETER MULTIMEDIA AUTH REQUEST (MAR)</b><br />The ASM requests a SD-AV from the User Database with respect to the IMPI received in step 2.</td></tr>
<tr><td>4.</td><td><b>User Database to ASM: DIAMETER MULTIMEDIA AUTH ANSWER (MAA)</b><br />Along with the IMPI, the User Database sends a SD-AV to the ASM containing the following data: qop value (quality of protection), the authentication algorithm, realm, and a hash value H(A1) of the IMPI, realm, and password. [[!RFC2617]] provides additional information on the values in the authentication vector for SIP Digest based authentication. Upon reception of the MAA message, the ASM stores the H(A1) value and generates the nonce value needed to challenge the IG.</td></tr>
<tr><td>5.</td><td><b>ASM to IG: SIP 401 Unauthorized</b><br />The ASM denies the IG authentication but sends a SIP 401 Unauthorized message to the IG in order to challenge the IG. This message contains the IMPI, the nonce, the authentication algorithm, and the realm and qop values. </td></tr>
<tr><td>6.</td><td><b>IG to ASM: SIP REGISTER</b><br />After reception message 5, the IG generates a client nonce (cnonce) and calculates an authentication response value using this cnonce and other values received in step 5 (see [[!RFC2617]]). The IG sends a new SIP REGISTER request to the ASM, this time with the authentication response along with the parameters IMPI, realm, nonce, response, cnonce, qop, nonce-count, and algorithm. </td></tr>
<tr><td>7.</td><td><b>ASM to IG: SIP 200 OK</b> (successful case)<br />After reception of the SIP REGISTER message containing the authentication response value, the ASM calculates the <i>expected</i> response value using the previously stored H(A1) and the stored nonce value together with other parameters (see [[!RFC2617]]). If the response value received from the IG equals the expected response value, the IG has been authenticated and the IMPU is registered in the ASM. In this successful case, the ASM sends the SIP 200 OK from ASM to the IG, enabling the IG to authenticate the SPP Network. This SIP 200 OK message contains a response digest calculated using the cnonce value generated by the IG prior to sending message 6.</td></tr>
<tr><td>8.</td><td><b>IG to OITF: Registration Response</b><br />The IG informs the OITF about the result of the registration procedure (when step 1 was executed).</td></tr>
</table>
<p>The details of the messages 2 – 7 are specified in [[!3GPP24.229]].</p>
</section>
<section><h3>IMS AKA Message Flows</h3>
<p>To support IMS AKA, a UICC with an ISIM or USIM application must be integrated into the IMS Gateway (IG). From the IMS point of view, the IG thereby takes the role of an IMS Subscriber. The UICC stores a long-term secret key K which is shared between the ISIM or USIM application and a User Database belonging to the network operator that provides the ISIM or the USIM. Figure <a href="#identification-and-authentication-based-on-ims-aka" class="figureRef"></a> shows the high-level message flows for user identification and authentication based on the IMS AKA procedure</p>
<figure id="identification-and-authentication-based-on-ims-aka">
<img alt="FIGURE 31" src="images/IdentificationAndAuthenticationBasedOnIMSAKA.png" />
<figcaption>Figure ####: User Identification and Authentication based on the IMS AKA procedure</figcaption>
</figure>
<table class="sequence">
<tr><td>0.</td><td>The IG is powered up. This can initiate the execution of steps 2-7 </td></tr>
<tr><td>1.</td><td><b>OITF to IG: Registration Request</b><br />
The OITF sends a request for registration to the IMS Gateway (IG), when needed (the end user explicitly logs on for personalized services)</td></tr>
<tr><td>2.</td><td><b>IG to ASM: SIP REGISTER</b><br />
This request contains the SPP Network Domain Name of the IG's IMS home network, the IMPI and the IMPU. All this data is read from the ISIM.</td></tr>
<tr><td>3.</td><td><b>ASM to User Database: DIAMETER MULTIMEDIA AUTH REQUEST (MAR)</b><br />
ASM requests authentication data from the User Database with respect to the IMPI received in step 2.</td></tr>
<tr><td>4.</td><td><b>User Database to ASM: DIAMETER MULTIMEDIA AUTH ANSWER (MAA)</b><br />
The User Database sends an Authentication Vectors (AV) to the ASM containing the following data: random challenge RAND, answer XRES expected by the IG in step 6, network authentication token AUTN, integrity key IK, and ciphering key CK. The authentication token AUTN contains a message authentication code (MAC) enabling the IG to authenticate the SPP Network (see step 5).</td></tr>
<tr><td>5.</td><td><b>ASM to IG: SIP 401 Unauthorized</b><br />
At this point in time, the ASM denies the IG authentication. Instead, it sends a SIP Unauthorized message with a WWW-Authenticate header to the IG. This header contains RAND and AUTN. After reception of this message, the IG verifies the message authentication code contained in AUTN thereby authenticating its SPP Network. </td></tr>
<tr><td>6.</td><td><b>IG to ASM: SIP REGISTER</b><br />
ISIM computes the value RES on input of its version of the secret key K stored on the UICC of the IG. The IG sends a new SIP REGISTER request to the ASM, this time with RES as response to the challenge the ASM initiated in step 5.</td></tr>
<tr><td>7.</td><td><b>ASM to IG: SIP 200 OK</b><br />
If RES = XRES (successful case), ASM considers the IG as authenticated, and binds IMPU to the IP address &lt;IP address&gt;.</td></tr>
<tr><td>8.</td><td><b>IG to OITF: Registration Response</b><br />
The IG informs the OITF about the result of the registration procedure. (when step 1 was executed) </td></tr>
</table>
<p>In case of success, the ISIM of the IG is able, based on its knowledge of the secret key K and the authentication token AUTN, to calculate the same values of the integrity key IK and the ciphering key CK as those that the ASM received in step 4 from the User Database. The IG and the ASM use IK and CK to establish IPSec Security Associations for protecting SIP signaling messages over the IG – ASM reference point</p>
<p>The details of the messages 2-7 are specified in [[!3GPP24.229]].</p>
</section>
</section>
<section id="session-management-and-sso"><h2>Session Management and Single Sign On</h2>
<p>User authentication does not need to be performed with each request. In order to avoid re-authentication at each request, a Service (and/or SSA) can rely on authentication session management and Single Sign On. The following authentication session management can be used: cookies, URL parameters and HTTP authentication session, if HTTP or GBA authentication has been used. SAML Web-based Single Sign On can be used.</p>
<section><h3>Cookie Session</h3>
<p>The OITF SHALL support HTTP session management using cookies as described in [[!RFC2109]]. The cookie is opaque data to the OITF.
<p>Persistent cookies SHALL be stored in non-volatile memory (Flash, HDD, etc.) in the OITF.</p>
<p>All OITF applications using HTTP (not only DAE) SHALL be able to create, read and delete <b>persistent</b> cookies with respect to domain restriction as specified in [[!RFC2109]]. Persistent cookies SHOULD be shared between all components in an OITF.</p>
<p>User SHALL have the possibility to delete <b>persistent</b> cookies in OITF.</p>
<p>The following figure shows an example of sequences based using cookie session:</p>
<figure id="session-management-with-cookies">
<img alt="FIGURE 32" src="images/SessionManagementWithCookie.png" />
<figcaption>Figure ####: Session Management Using Cookie</figcaption>
</figure>
<table class="sequence">
<tr><td>1.</td><td>The OITF requests a service with no valid cookie. </td></tr>
<tr><td>2.</td><td>The service triggers the SAA authentication and the SAA performs the wanted authentication.</td></tr>
<tr><td>3.</td><td>The service or SAA sets a cookie using Set-Cookie response header as specified in [[!RFC2109]].</td></tr>
<tr><td>4.</td><td>The OITF requests a service. Applicable cookies are provided in each HTTP request as specified in [[!RFC2109]] (domain-match, port-match, path-match, Max_Age-match, etc.).</td></tr>
<tr><td>5.</td><td>The service checks the cookie. Cookie checking is out of scope of this specification.</td></tr>
<tr><td>6.</td><td>The service optionally refreshes the cookie and sets it again using Set-Cookie response header as specified in [[!RFC2109]]. </td></tr>
</table>
<p>Steps 4 to 6 are performed for each new HTTP request according to cookie matching.</p>
</section>
<section><h3>URL Parameters (informative)</h3>
<p>An alternative to cookies for passing session data is the use of hidden input fields in forms or URL parameters in requests passed to the server. These mechanisms are transparent to the OITF. Below is an example message flow using URL parameters. Note that the use of hidden input fields can also be achieved with HTTP POST. The mechanism of using HTTP POST is not described in this section.</p>
<figure id="session-management-using-url-parameters">
<img alt="FIGURE 33" src="images/SessionManagementWithURLParameters.png"  />
<figcaption>Figure ####: Session Management Using URL Parameters</figcaption>
</figure>
<table class="sequence">
<tr><td>1.</td><td>The OITF requests a service with no valid authentication session. </td></tr>
<tr><td>2.</td><td>The service triggers the SAA authentication and the SAA performs the wanted authentication.</td></tr>
<tr><td>3.</td><td>The service or SAA redirects to the service with a new URL parameter for session data.</td></tr>
<tr><td>4.</td><td>The OITF requests a service with the URL parameter.</td></tr>
<tr><td>5.</td><td>The service checks the session data in the URL parameter. Session data is opaque data and out of scope of this specification.</td></tr>
<tr><td>6.</td><td>The service serves the request.</td></tr>
</table>
<p>NOTE: URL parameters are often used to pass session information from an HTTP session to a session using another protocol (e.g. RTSP).</p>
<p>NOTE: a web server (service or SAA) can maintain an HTTP session using this technique. But the server is responsible for modifying every link URL, so that the session data is posted in a form or appended to the request.</p>
<p>NOTE: Passing information through URL parameters is highly insecure.</p>
</section>
<section><h3>HTTP Authentication Session</h3>
<p>When using HTTP authentication, a server can rely on HTTP authentication session as specified in [[!RFC2617]].</p>
<p>The User MAY be prompted to allow OITF to store HTTP authentication parameters, i.e. username and password, in non-volatile memory. </p>
<p>All OITF applications using HTTP (not only DAE) SHOULD have access to HTTP authentication parameters, i.e. username and password.</p>
<p>All OITF applications using HTTP (not only DAE) SHOULD share the current HTTP authentication session (e.g. B-TID, Ks_NAF, nonce, cnonce, nonce-count and opaque values).</p>
<p>If username and password can be stored, the user SHALL have the possibility to change stored username and passwords in OITF for a given protection space as specified in [[!RFC2617]].</p>
<p>The following figure shows an example of sequences based on HTTP authentication session:</p>
<figure id="http-authentication-session">
<img alt="FIGURE 34" src="images/HTTPAuthenticationSession.png" />
<figcaption>Figure ####: HTTP Authentication Session</figcaption>
</figure>
<table class="sequence">
<tr><td>1.</td><td>The OITF requests a service with no valid HTTP authentication session.</td></tr>
<tr><td>2.</td><td>The service/SAA performs HTTP or GBA authentication.</td></tr>
<tr><td>3.</td><td>The service/SAA serves the request including an AuthenticationInfo header as specified in [[!RFC2617]].</td></tr>
<tr><td>4.</td><td>The OITF requests again a service. Appropriate HTTP Authorisation headers are provided in each HTTP request within the protection space (specified by domain) as specified in [[!RFC2617]].</td></tr>
<tr><td>5.</td><td>The Service/SAA checks the Authorisation header.</td></tr>
<tr><td>6.</td><td>The Service/SAA serves the request including an AuthenticationInfo header.</td></tr>
</table>
<p>Steps 4 to 6 can be performed for each new HTTP request within the protection space.</p>
</section>
<section><h3>SAML Web-based SSO</h3>
<p>This section specifies the functionality and possible message flows for basic SAML web-based single sign-on.</p>
<p>SAML Web-based single sign-on SHALL adhere to section 4.1 of [[!SAMLPROF]], whereby either a SAML HTTP POST or a SAML HTTP SimpleSign binding of a SAML &lt;Response&gt; message from the SAA SHALL use MIME-type “application/ce html+xml” as defined in [[!CEA-2014-A]]. A standard CEA-2014-A compatible browser is able to handle the SAML HTTP redirect and POST bindings defined in this section, without requiring any extensions to CEA-2014-A. This profile of SAML therefore does not add requirements to the OITF besides supporting DAE functionality.</p>
<p>The remainder of this section describes sequences of how SAML Web-based single sign-on is handled between the different relevant entities, i.e. the service, the SAA, and the OITF.</p>
<p>The sequences assume that the SAA and service provider share a logical identification of the user in advance of the described sequence. The user is known to the SAA. The SAA maintains knowledge of the user’s authentication credentials.</p>
<figure id="saml-web-based-sso">
<img alt="FIGURE 35" src="images/SAMLWebBasedSSO.png" />
<figcaption>Figure ####: SAML Web-based SSO</figcaption>
</figure>
<table class="sequence">
<tr><td>1.</td><td>The OITF requests a service. Authentication is needed and there is no valid authenticated service session.</td></tr>
<tr><td>2.</td><td>The requested service triggers SAA authentication by issuing a redirect request using SAML HTTP Redirect binding, i.e. an HTTP Response with HTTP "302 Found" or “303 See Other” (Location = SAA) , with a SAML &lt;AuthnRequest&gt; message (as defined in section 3.4.1 of [[!SAMLCORE]]).</td></tr>
<tr><td>3.</td><td>The SAA authenticates the user. Various methods exist for this. Valid methods include the authentication methods as defined in sections <a href="#http-basic-and-digest-authentication" class="sectionRef">5.4.1</a> through <a href="#gba-authentication-using-ims-gateway" class="sectionRef">5.4.5</a> of this document.</td></tr>
<tr><td>4.</td><td>The SAA responds with either a SAML HTTP POST or HTTP POST SimpleSign binding of a SAML &lt;Response&gt; message (as defined in section 3.3.3 of [[!SAMLCORE]]). Since the browser of the OITF is CE-HTML compliant, the SAA response message must use MIME-type “application/ce-html+xml” as defined in [[!CEA-2014-A]]. The CE-HTML browser will load the CE HTML page with the SAML POST binding, after which it issues an HTTP POST request to the target service with the SAML &lt;Response&gt; message as payload. </td></tr>
<tr><td>5.</td><td>The requested service checks the SAML &lt;Response&gt; message to see if authentication succeeded. If succeeded, the service serves the request.</td></tr>
</table>

</section>
</section>

</section>


<section id="forced-playout-using-media-zones"><h1>Forced Play Out Using Media Zones</h1>
<p>Content may contain navigation constraints for forced playout, see [[.OIPF_MEDIA2]] sections <a href="volume2.html#system-mpeg2-ts" class="extRef">4.1</a> and <a href="volume2.html#system-mp4-file-format" class="extRef">4.2</a>.</p>
<p>If an OITF supports DMZ navigation constraints signalled in zone maps within MP4 files or MPEG-2 TS, it SHALL indicate this via the appropriate capability signalling [[.OIPF_DAE2]]. If an OITF does not understand the navigation constraints, this capability description is either absent or set to “false”. If the capability description to support such DMZ navigation constraints is set to “true”, an OITF SHALL obey the signalled constrains and SHALL NOT ignore the presence of navigation constraints.</p>
<p>Note: When this capability description is not sent or is set to “false”, it is the choice of the service provider whether the content shall be sent to the OITF as there is no guarantee whether the navigation constraints will be obeyed.</p>
<p>For navigation constraints pertaining to protected content, the zone map information MAY be integrity protected using an included signature as described in [[!MRL-DMZ]]. If the zone map is integrity protected using a signature, and if the terminal-centric approach is used for content protection, the key used for signature is derived as described in [[!MRL-DMZ]] sections 2.1 and 2.3 for MP4 (using a key derived from the content key), and as described in [[!MRL-DMZ]] section 7.2.2 for MPEG-2 TS (using a signature key signalled in ECMs). Note that the [[!MRL-DMZ]] specification contains normative language on what should happen if the integrity of the signalled constraints cannot be verified. If an OITF supports DMZ navigation constraints and if integrity protection is used, the OITF SHALL verify the integrity of the signalled constraints, If the integrity of the signalled constraints cannot be verified, the OITF SHALL NOT play the associated content.</p>
<p>Note: Server-based play out control is described in [[.OIPF_PROT2]], <a href="volume4.html#s6-1-2-3" class="extRef">section 6.1.2.3</a>. The concept there is applicable to interactive streaming where the server may or may not grant requests for trick-mode commands like fast forward.</p>
</section>


<section class="appendix" id="link-of-user-authentication-and-drm-device-authentication"><h1>Link of User Authentication and DRM Device Authentication (informative)</h1>
<p>This section describes the generic mechanism to link user authentication result with device authentication in OITF. Although the device authentication mechanism is provided by Marlin, the user authentication mechanism varies depending on the system environment.</p>
<p>The mechanism described in this section uses HTTP Digest Authentication [[!RFC2617]] and assumes that user identifier and its secret information (e.g. password, Ks_NAF) are shared between OITF and Providers Network in advance of the sequences between CSP and CSP-T Server.</p>
<p>The sequence below explains how the user authentication and device authentication are securely correlated with each other by Marlin Action Token Acquisition and Marlin Protocol.</p>
<figure id="user-auth-for-cst-to-cspt-server-communication">
<img alt="FIGURE 36" src="images/UserAuthenticationForCSP-CSPT-Server.png" />
<figcaption>Figure ####: User Authentication for CSP, CSP-T Server communication</figcaption>
</figure>
<table class="sequence">
<tr><td>1.</td><td>The CSP requests a Marlin Action Token to the CSP-T Server.</td></tr>
<tr><td>2.</td><td>When the CSP-T Server receives the request from CSP for the Marlin Action Token, the CSP-T Server responds with a "401 Unauthorized" status code with a WWW-Authenticate header defined in [[!RFC2617]].</td></tr>
<tr><td>3.</td><td>When the CSP receives the response, the CSP sends the request which includes an Authorisation header defined in [[!RFC2617]]. The user identifier and its secret information are used as username and password for generation of the Authorisation header.</td></tr>
<tr><td>4.</td><td>When the CSP-T Server receives the Authorisation header, <ul>
<li>The CSP-T Server verifies the Authorisation header.
<li>When the verification succeeds, the CSP-T Server generates user information to be included into the Business Token, and stores the combination of user identifier from the Authorisation header and user information to be included into the Business Token.
<li>The CSP-T Server then sends Marlin Action Token which includes the Business Token with AuthenticationInfo header defined in [[!RFC2617]] to the CSP as the response.</ul></td></tr>
<tr><td>5.</td><td>Given the Marlin Action Token, the CSP sends a (Marlin Protocol) request to CSP-T Server which includes Authorisation header calculated from its username and password, and the Business Token.</td></tr>
<tr><td>6.</td><td>When the CSP-T Server receives the Authorisation header in the (Marlin Protocol) request, which includes the Business Token,<ul>
<li>The CSP-T Server verifies the Authorisation header.
<li>When the verification succeeds, the CSP-T Server checks the combination of user identifier and Business Token in the request with its stored combination.
<li>If the check succeeds, the CSP-T Server sends a (Marlin Protocol) response and correlates user identifier and its secret information (i.e. user authentication) with device identifier (i.e. device authentication).</ul></td></tr>
</table>
</section>

<section class="appendix" id="xml-schemas"><h1>XML Schemas</h1>
<section id="marlinprivatedatatype-schema"><h2>XML Schema for MarlinPrivateDataType Structure</h2>
<p>This is the XML schema for MarlinPrivateDataType Structure (see section <a href="#drm-control-information" class="sectionRef"></a>):</p>
<pre class="xml-schema">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema" elementFormDefault="qualified" attributeFormDefault="unqualified"&gt;
&lt;!-- schema filename is  csp-MarlinPrivateData.xsd --&gt;
&lt;xs:include schemaLocation="csp-DRMPrivateDataType.xsd"/&gt;
&lt;xs:complexType name="MarlinPrivateDataType"&gt;
  &lt;xs:complexContent&gt;
    &lt;xs:extension base="DRMPrivateDataType"&gt;
      &lt;xs:sequence&gt;
        &lt;xs:choice&gt;
          &lt;xs:element name="MarlinLicense" type="xs:base64Binary"/&gt;
          &lt;xs:element name="MarlinToken" type="xs:base64Binary"/&gt;
        &lt;/xs:choice&gt;
        &lt;xs:any namespace="##any" processContents="lax" minOccurs="0" 
          maxOccurs="unbounded"/&gt;
      &lt;/xs:sequence&gt;
    &lt;/xs:extension&gt;
  &lt;/xs:complexContent&gt;
&lt;/xs:complexType&gt;
&lt;/xs:schema&gt;
</pre>
<p>The DRMPrivateDataType structure is defined in the included file “csp-DRMPrivateDataType.xsd” as</p>
<pre class="xml-schema">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema" elementFormDefault="qualified"
  attributeFormDefault="unqualified"&gt;
  
  &lt;xs:complexType name="DRMPrivateDataType" abstract="true"&gt;
    &lt;xs:attribute name="mimeType" type="xs:string" use="optional"/&gt;
    &lt;!-- NOTE: DRMPrivateDataType is an abstract type that can be extended and replaced 
      by a specific instance type to carry messages for a particular DRM system. 
      Derived types of &lt;DRMPrivateData&gt; should include an &lt;any&gt; 
      construct to be prepared for future extensibility, as is done for 
      example for &lt;MarlinPrivateData&gt; --&gt;
  &lt;/xs:complexType&gt;
&lt;/xs:schema&gt;
</pre>

</section>
<section id="mippvcontrolmessage-schema"><h2>XML Schema for MIPPVControlMessage Format</h2>
<p>This is the XML schema for MIPPVControlMessage (see section <a href="#mippvcontrolmessage-format" class="sectionRef"></a>):</p>
<pre class="xml-schema">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;xs:schema targetNamespace="urn:oipf:csp:MIPPVControlMessage:2008" xmlns:tns="urn:oipf:csp:MIPPVControlMessage:2008" xmlns:xs="http://www.w3.org/2001/XMLSchema" elementFormDefault="qualified" attributeFormDefault="unqualified"&gt;
&lt;!-- schema filename is  csp-MIPPVControlMessage.xsd --&gt;
  &lt;xs:element name="MIPPVControlMessage"&gt;
    &lt;xs:complexType&gt;
      &lt;xs:sequence&gt;
        &lt;xs:element name="MarlinLicense" type="xs:base64Binary" minOccurs="0"/&gt;
        &lt;xs:element name="MarlinActionToken" minOccurs="0"&gt;
          &lt;xs:complexType&gt;
            &lt;xs:simpleContent&gt;
            &lt;xs:extension base="xs:base64Binary"&gt;
            &lt;xs:attribute name="absoluteAcquisitionTiming" type="xs:dateTime"
                 use="optional"/&gt;
            &lt;xs:attribute name="relativeAcquisitionTiming" type="xs:duration"
                 use="optional"/&gt;
            &lt;/xs:extension&gt;
            &lt;/xs:simpleContent&gt;
          &lt;/xs:complexType&gt;
        &lt;/xs:element&gt;
      &lt;/xs:sequence&gt;
    &lt;/xs:complexType&gt;
  &lt;/xs:element&gt;
&lt;/xs:schema&gt;
</pre>
</section>
<section id="hexbinaryprivatedatatype-schema"><h2>XML Schema for HexBinaryPrivateDataType Structure</h2>
<p>This is the XML schema for HexBinaryPrivateDataType Structure (see <a href="#ciplusgw-metadata-drm-control-information" class="sectionRef">4.2.3.10.2</a>):</p>
<pre class="xml-schema">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema" elementFormDefault="qualified" attributeFormDefault="unqualified"&gt;
&lt;!-- schema filename is  csp-HexBinaryPrivateDataType.xsd --&gt;
&lt;xs:include schemaLocation="csp-DRMPrivateDataType.xsd"/&gt;
&lt;xs:complexType name="HexBinaryPrivateDataType"&gt;
  &lt;xs:complexContent&gt;
    &lt;xs:extension base="DRMPrivateDataType"&gt;
      &lt;xs:sequence&gt;
        &lt;xs:element name="Message" type="xs:hexBinary"/&gt;
        &lt;xs:any namespace="##any" processContents="lax" minOccurs="0"
          maxOccurs="unbounded"/&gt;
      &lt;/xs:sequence&gt;
    &lt;/xs:extension&gt;
  &lt;/xs:complexContent&gt;
&lt;/xs:complexType&gt;
&lt;/xs:schema&gt;
</pre>
<p>The DRMPrivateDataType structure is defined in the included file csp-DRMPrivateDataType.xsd and is shown in section <a href="#marlinprivatedatatype-schema" class="sectionRef"></a>.</p>
</section>

</section>
<section class="appendix" id="drm-messages-used-in-dae"><h1>DRM Messages used in DAE (informative)</h1>
<p>The following table summarizes the DRM messages and their MIME-types used in <a href="volume5.html#oipfdrmagent-senddrmmessage" class="apiRef">sendDRMMessage</a> API defined in [[.OIPF_DAE2]].</p>
<table class="simple" id="drm-messages-used-in-dae-table">
<caption>Table ####: DRM Messages used in DAE</caption>
<tr><th>Mime-type</th><th>Description</th></tr>
<tr><td>application/vnd.marlin.drm.actiontoken+xml</td><td>Marlin Action Token defined by [[!MRL-BNSP]]</td></tr>
<tr><td>application/vnd.oipf.mippvcontrolmessage+xml</td><td>MIPPVControl Message as described in section <a href="#mippvcontrolmessage-format" class="sectionRef"></a></td></tr>
<tr><td>application/vnd.oipf.cspg-hexbinary</td><td>CSPG-CI+ message as described in section <a href="#mapping-messages-to-dae-api-or-events" class="sectionRef"></a>, “<a href="#mapping-messages-to-dae-api-or-events" class="sectionTitleRef"></a>”
<p>Note: This type may also be used for CSPG messages in the case the gateway is combined with the OITF as introduced in section <a href="#gca" class="sectionRef"></a>.</p></td></tr>
<tr><td>application/vnd.marlin.drm.actiontoken2+xml</td><td>Marlin Action Token defined by [[!MRL-MS3]]</td></tr>
</table>
</section>
<section class="appendix" id="cspg-ciplus-usage-examples"><h1>CSPG-CI+ Usage Examples (informative)</h1>
<p>CI+ Host is the function in the OITF responsible for managing the dialog with the CSPG-CI+. CSPG-CI+ is referred to as CI+ CAM in [[!CI+]] specifications. It is an internal function in OITF, not identified in [[.OIPF_ARCH2]]. It is shown on the following sequence diagrams to help understanding of interaction with other identified functions.</p>
<p>Management of content protection using CSPG-CI+ has no impact on the protocols used for service discovery, Scheduled Content or CoD session establishment and management and delivery, as defined in [[.OIPF_PROT2]]. CSPG-CI+ protected services can be Scheduled Content services or CoD services (multicast streaming, unicast streaming or download IPTV services). Following sequence diagrams are only examples of services.</p>
<section id="cspg-ciplus-initial-power-on"><h2>CSPG-CI+ Initial Power-on (informative)</h2>
<p>During initial power-on, the CSPG-CI+ and the OITF mutually authenticate each other using the CI+ authentication mechanism. Figure <a href="#cspg-ciplus-first-power-on-sequence" class="figureRef"></a> is an overview of the mechanism. For further detail, please refer to [[!CI+]], section 6.</p>
<figure id="cspg-ciplus-first-power-on-sequence">
<img alt="FIGURE 37" src="images/CSPG-CI+First-Power-on.png" />
<figcaption>Figure ####: CSPG-CI+ First Power-on</figcaption>
</figure>
</section>
<section id="cspg-ciplus-normal-power-on"><h2>CSPG-CI+ Normal Power-on (informative)</h2>
<p>During initialization, if the CSPG-CI+ has stored authentication information, it only verifies that this authentication information is shared with the OITF. Figure <a href="#cspg-ciplus-normal-power-on-sequence" class="figureRef"></a> is an overview of the mechanism. For further detail, please refer to [[!CI+]], section 6.</p>
<figure id="cspg-ciplus-normal-power-on-sequence">
<img alt="FIGURE 38" src="images/CSPG-CI+Normal-Power-on.png" />
<figcaption>Figure ####: CSPG-CI+ Normal Power-on</figcaption>
</figure>
</section>
<section id="live-session-example"><h2>Live Session Example (informative)</h2>
<figure>
<img alt="FIGURE 39" src="images/LiveSessionExample.png" />
<figcaption>Figure ####: CSPG-CI+ Live Session Example</figcaption>
</figure>
</section>
<section id="parental-control-management-example"><h2>Parental Control Management Example (informative)</h2>
<figure>
<img alt="FIGURE 40" src="images/ParentalControlManagementExample.png" />
<figcaption>Figure ####: Parental Control Management Example</figcaption>
</figure>
</section>
<section id="no-rights-event-and-purchase-example"><h2>No Rights Event and Purchase Example (informative)</h2>
<figure>
<img alt="FIGURE 41" src="images/NoRightsEventAndPurchaseExample.png" />
<figcaption>Figure ####: No Rights Event and Purchase Example</figcaption>
</figure>
</section>
<section id="vod-session-example"><h2>VOD Session Example (informative)</h2>
<figure>
<img alt="FIGURE 42" src="images/VODSessionExample.png" />
<figcaption>Figure ####: VOD Session Example</figcaption>
</figure>
</section>
</section>
<section class="appendix" id="cspg-dtcp-session-setup-sequence-examples"><h1>CSPG-DTCP Session Setup Sequence Examples (informative)</h1>
<p>This appendix describes session setup sequences with CSPG-DTCP for following use cases:</p><ul>
<li>Multicast streaming with SIP session management,
<li>Unicast streaming with SIP session management,
<li>Unicast streaming with RTSP session management, and
<li>HTTP streaming and download.</ul>
<p>Note that SIP messages over HNI-IGI (between OITF and IG) are delivered over HTTP as specified in [[.OIPF_PROT2]].</p>
<section><h2>Multicast streaming with SIP session management</h2>
<p>Figure <a href="#session-setup-multicast-with-sip" class="figureRef"></a> describes session setup sequence for multicast streaming with SIP session management:</p>
<figure id="session-setup-multicast-with-sip">
<img alt="FIGURE 43" src="images/MulticastSessuibSetupWithSIP.png" />
<figcaption>Figure ####: Session Setup Sequence for multicast streaming with SIP session management</figcaption>
</figure>
<p>Figure <a href="#cspg-dtcp-initiated-teardown-for-multicast-sip" class="figureRef"></a> describes CSPG-DTCP initiated teardown sequence for multicast IPTV service. Note that OITF and Network initiated teardown sequences are the same as defined in [[.OIPF_PROT2]]:</p>
<figure id="cspg-dtcp-initiated-teardown-for-multicast-sip">
<img alt="FIGURE 44" src="images/CSPGDTCPInitiatedTeardownForMulticastWithSIP.png" />
<figcaption>Figure ####: CSPG-DTCP Initiated Teardown Sequence for multicast streaming with SIP session management</figcaption>
</figure>
</section>
<section><h2>Unicast streaming with SIP session management</h2>
<p>Figure <a href="#session-setup-unicast-with-sip" class="figureRef"></a> describes session setup sequence for unicast streaming with SIP session management:</p>
<figure id="session-setup-unicast-with-sip">
<img alt="FIGURE 45" src="images/UnicastSessionSetupWithSIP.png" />
<figcaption>Figure ####: Session Setup Sequence for unicast streaming with SIP session management</figcaption>
</figure>
</section>
<section><h2>Unicast streaming with RTSP session management</h2>
<p>Figure <a href="#session-setup-unicast-with-rtsp-sequence" class="figureRef"></a> describes session setup sequence for unicast streaming with RTSP session management:</p>
<figure id="session-setup-unicast-with-rtsp-sequence">
<img alt="FIGURE 46" src="images/UnicastSessionSetupWithRTSP.png" />
<figcaption>Figure ####: Session Setup Sequence for unicast streaming with RTSP session management</figcaption>
</figure>
</section>
<section><h2>HTTP Streaming and Download</h2>
<p>Figure <a href="#http-streaming-and-download" class="figureRef"></a> describes session setup sequence for HTTP streaming and download:</p>
<figure id="http-streaming-and-download">
<img alt="FIGURE 47" src="images/SessionSetupForHTTPStreamingAndDownload.png" />
<figcaption>Figure ####: Session Setup Sequence for HTTP Streaming and Download</figcaption>
</figure>
</section>
</section>
<section class="appendix" id="embedded-cspg"><h1>Embedded CSPG (informative)</h1>
<p>As introduced in section <a href="#gca" class="sectionRef">4.2</a>, the CSP Gateway-Centric Approach allows for co-location of an embedded (virtual) CSPG in the same physical device that hosts the OITF. This is a purely conceptual approach that in practice facilitates that the embedded CSPG can terminate any chosen CA or DRM solution deployed in that device, for the reception of services that implement the chosen CA/DRM system. This appendix provides an informative description of the embedded CSPG approach.</p>
<p>The following deployments are possible implementations of OIPF specifications:</p><ul>
<li>Combined IG, OITF and CSPG TV or STB: A TV or STB including IG, OITF and CSPG functionality.
<li>Combined OITF and CSPG TV or STB: A TV or STB including OITF and CSPG functionality.
</ul>
<figure>
<img src="images/EmbeddedCSPG.png" alt="embeddedCSPG.png"/>
</figure>
<p>For a CSPG embedded in the same device as OITF, the following figure applies:</p>
<figure>
<img src="images/EmbeddedCSPG-interfaces.png" alt="embeddedCSPG-interfaces.png"/>
</figure>
<p>As shown on the figure above:</p><ul>
<li>The interface between CSPG and OITF functions is internal to device implementation and is out of scope of the present specification.
<li>The external interfaces UNIS-xx between the device and the network which form the basis for network-device interoperability remain unchanged, compared to when CSPG and OITF are implemented in separate devices. Service behaviour remains the same when the CSPG is embedded.</ul>
<p>With the embedded (virtual) CSPG approach, there is no normatively specified interface between the OITF and CSPG. The DAE application communicates directly with the chosen CA/DRM solution using the common DRM agent communication API’s defined for the DAE [[.OIPF_DAE2] <a href="volume5.html#content-service-protection-api" class="extRef">section 7.6</a>. The embedded CSPG is not signalled as a CSPG implementation at all; all communications via the DRM agent API take place using the usual CA/DRM system identifier and DRM capability indication mechanisms, as described in section <a href="#cspg-dae-interface" class="sectionRef">4.2.1</a>.</p>
<p>The following example shows the signaling for a device with both embedded (virtual) CSPG and (non-embedded) CSPG-CI+ capabilities as defined in <a href="volume5.html#drm-capability-indication" class="extRef">section 9.3.10</a> DRM capability indication of [[.OIPF_DAE2]].</p>
<p>Example:</p><pre>
&lt;drm DRMSystemID="urn:dvb:casystemid:01535"&gt;TS_PF&lt;/drm&gt;
&lt;drm DRMSystemID="urn:dvb:casystemid:12348" protectionGateways="ci+"&gt;TS_PF TTS_PF&lt;/drm&gt;</pre>
<p>For an embedded CSPG, the following interface mappings can be described:</p><ul>
<li>Connectivity and Discovery: internal to the device
<li>HNI-CSP:<ul>
<li>Control Channel: The events and functions provided by the CSPG are mapped internally in the device to the DAE API and events, e.g. <a href="volume5.html#oipfdrmagent-senddrmmessage" class="apiRef">sendDRMMessage</a>, <a href="volume5.html#oipfdrmagent-ondrmmessageresult" class="apiRef">onDRMMessageResult</a>, onDRMRightsError, onParentalRatingChange or onParentalRatingError. This mapping is out of scope for the present specification. 
<li>Media Channel: This is an internal interface.</ul>
<li>UNIS-CSP-G: The device provides access to a network driver to the CSPG
<li>HNI-AGC: not used
</ul>
<section><h2>Application to Simple and Secure Streaming</h2>
<p>The call flow in Figure <a href="#sss-with-cspg" class="figureRef"></a> depicts an example of sequence for getting credential and applies when secure streaming of content is triggered by the end-user.</p>
<figure id="sss-with-cspg">
<img alt="FUGURE 48" src="images/SimpleAndSecureStreamingWithCSPG.png" style="width:90%" />
<figcaption>Figure ####: Simple and Secure Streaming with CSPG</figcaption>
</figure>
<table class="sequence">
<tr><td>1.</td><td>The end-user browses the catalog and selects a content for playing.</td></tr>
<tr><td>2.</td><td>The server provides DRMControlInformation associated to the content.</td></tr>
<tr><td>3.</td><td>The DAE Application asks the DRM client to provide authentication means via the DAE API. Note that the full authentication sequence is not described here for simplification and because it is specific to the DRM implementation.</td></tr>
<tr><td>4.</td><td>The DRM client replies to the requests via the DAE API.</td></tr>
<tr><td>5.</td><td>The DAE Application requests credentials to the IPTV Application providing DRMControlInformation associated to the content and authentication means bound to the OITF DRM client.</td></tr>
<tr><td>6.</td><td>The IPTV Application transmits the request to the DRM Server.</td></tr>
<tr><td>7.</td><td>The DRM Server returns credentials to allow access to the content.</td></tr>
<tr><td>8.</td><td>The IPTV Application returns the credentials to the DAE Application.<br />
Note: the retrieval of credentials could also be performed through a proprietary communication between the CSPG and the CSP-G Server. In this case the reply to DAE application in step 4 above is limited to an acknowledgement that credentials are available for play.</td></tr>
<tr><td>9.</td><td>The DAE Application provides the credentials to the DRM Client via the DAE API.</td></tr>
<tr><td>10.</td><td>The DRM client checks the credential and extracts the content key. The DRM client provides the content key to the Player.</td></tr>
<tr><td>11.</td><td>The DAE Application triggers the streaming of the content.</td></tr>
<tr><td>12.</td><td>The CDN streams the content to the OITF. The decryption process associated to the Player uses the content key to render the content in clear.</td></tr>
</table>

</section>

</section>

</body>
</html>